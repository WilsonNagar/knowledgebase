name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger webhook deployment
        run: |
          echo "Triggering webhook deployment..."
          curl -X POST ${{ secrets.WEBHOOK_URL }}/deploy \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$(echo -n '${{ toJson(github.event) }}' | openssl dgst -sha256 -hmac '${{ secrets.WEBHOOK_SECRET }}' -binary | xxd -p -c 256)" \
            -d '${{ toJson(github.event) }}' \
            -f || {
              echo "Webhook deployment triggered (may take a few minutes)"
              exit 0
            }
      
      - name: Wait for deployment
        run: |
          echo "Deployment triggered via webhook. Check server logs for progress:"
          echo "ssh wilsonnagar@wilson-home 'sudo journalctl -u webhook.service -f'"
          echo ""
          echo "Deployment is running asynchronously on the server."
          echo "This workflow step completes immediately after triggering the webhook."
