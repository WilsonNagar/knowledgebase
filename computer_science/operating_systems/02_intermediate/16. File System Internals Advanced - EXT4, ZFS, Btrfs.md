---
number: 16
title: "File System Internals Advanced - EXT4, ZFS, Btrfs"
slug: "file-system-internals-advanced-ext4-zfs-btrfs"
level: "intermediate"
tags: ["operating-systems", "filesystem", "ext4", "zfs", "btrfs"]
prerequisites: ["file-system-internals"]
estimated_minutes: 145
contributors: []
diagrams: []
examples: []
canonical_id: "cs-os-int-16"
---

# File System Internals Advanced - EXT4, ZFS, Btrfs

## Overview

Advanced file systems like EXT4, ZFS, and Btrfs provide sophisticated features including copy-on-write, snapshots, checksums, and advanced allocation strategies. Understanding their architectures, features, and trade-offs is essential for choosing and optimizing file systems.

## Table of Contents

1. [EXT4 File System](#ext4)
2. [ZFS File System](#zfs)
3. [Btrfs File System](#btrfs)
4. [Comparison](#comparison)
5. [Copy-on-Write](#copy-on-write)
6. [Snapshots](#snapshots)
7. [Checksums & Data Integrity](#checksums)
8. [Use Cases](#use-cases)

## EXT4 File System

### What is EXT4?

**EXT4**: Fourth extended file system

**Evolution**: EXT2 → EXT3 → EXT4

**Features**: 
- **Large Files**: Large file support
- **Extents**: Extent-based allocation
- **Journaling**: Journaling
- **Delayed Allocation**: Delayed allocation

**Use**: Linux default file system

### EXT4 Features

**1. Extents**:
```
Contiguous block allocation
Better performance
```

**2. Journaling**:
```
Journal for metadata
Faster recovery
```

**3. Delayed Allocation**:
```
Delay block allocation
Better allocation decisions
```

**4. Large File Support**:
```
Files up to 16TB
```

## ZFS File System

### What is ZFS?

**ZFS**: Zettabyte File System

**Features**: 
- **Copy-on-Write**: Copy-on-write
- **Snapshots**: Snapshots
- **Checksums**: Data integrity checksums
- **Pooling**: Storage pooling
- **Compression**: Compression

**Use**: Enterprise storage, servers

### ZFS Architecture

**Components**:
- **ZFS Pool**: Storage pool
- **Datasets**: File systems, volumes
- **Snapshots**: Point-in-time copies
- **Clones**: Writable snapshots

**Pool**: Manages physical storage

**Datasets**: Logical file systems

### ZFS Features

**1. Copy-on-Write**:
```
Never overwrite data
Always write to new location
```

**2. Snapshots**:
```
Instant snapshots
Space-efficient
```

**3. Checksums**:
```
Data integrity verification
Automatic error detection
```

**4. Compression**:
```
Transparent compression
Space savings
```

## Btrfs File System

### What is Btrfs?

**Btrfs**: B-tree File System

**Features**: 
- **Copy-on-Write**: Copy-on-write
- **Snapshots**: Snapshots
- **Subvolumes**: Subvolumes
- **RAID**: Built-in RAID
- **Compression**: Compression

**Use**: Linux file system

### Btrfs Architecture

**Components**:
- **B-trees**: B-tree structures
- **Subvolumes**: Logical volumes
- **Snapshots**: Snapshots
- **RAID**: RAID support

**B-trees**: Efficient indexing

**Subvolumes**: Separate file systems

### Btrfs Features

**1. Copy-on-Write**:
```
Copy-on-write semantics
```

**2. Snapshots**:
```
Instant snapshots
```

**3. Subvolumes**:
```
Multiple file systems
```

**4. RAID**:
```
Built-in RAID support
```

## Comparison

### Comparison Table

| Feature | EXT4 | ZFS | Btrfs |
|---------|------|-----|-------|
| **Copy-on-Write** | No | Yes | Yes |
| **Snapshots** | No | Yes | Yes |
| **Checksums** | No | Yes | Yes |
| **Compression** | No | Yes | Yes |
| **RAID** | No | Yes | Yes |
| **Maturity** | Very Mature | Mature | Maturing |
| **Performance** | Excellent | Good | Good |

### When to Use Each

**EXT4**: 
- **General Purpose**: General-purpose use
- **Performance**: High performance needed
- **Stability**: Maximum stability

**ZFS**: 
- **Enterprise**: Enterprise storage
- **Data Integrity**: Critical data integrity
- **Features**: Need advanced features

**Btrfs**: 
- **Linux**: Linux systems
- **Snapshots**: Need snapshots
- **RAID**: Need built-in RAID

## Copy-on-Write

### What is Copy-on-Write?

**Copy-on-Write**: Never overwrite data

**Method**: 
```
1. Write to new location
2. Update pointers
3. Free old data if needed
```

**Benefit**: 
- **Snapshots**: Easy snapshots
- **Integrity**: Data integrity
- **Recovery**: Better recovery

### Copy-on-Write Example

**Traditional**:
```
Overwrite block in place
```

**Copy-on-Write**:
```
Write to new block
Update pointer
Old block preserved (for snapshot)
```

**Benefit**: Snapshots are free

## Snapshots

### What are Snapshots?

**Snapshots**: Point-in-time copy

**Method**: 
- **Copy-on-Write**: Copy-on-write enables snapshots
- **Instant**: Instant creation
- **Space-Efficient**: Space-efficient

**Use**: 
- **Backup**: Backup
- **Recovery**: Recovery
- **Testing**: Testing

### Snapshot Example

**Create Snapshot**:
```
snapshot = create_snapshot(filesystem)
```

**Use Snapshot**:
```
Restore from snapshot
Or access snapshot
```

**Benefit**: Instant backup

## Checksums & Data Integrity

### Checksums

**Checksums**: Verify data integrity

**Method**: 
```
1. Calculate checksum on write
2. Store checksum
3. Verify checksum on read
4. Detect errors
```

**Benefit**: Detect corruption

### Data Integrity

**ZFS**: 
- **Checksums**: Automatic checksums
- **Scrubbing**: Periodic scrubbing
- **Self-Healing**: Self-healing with redundancy

**Btrfs**: 
- **Checksums**: Checksums
- **Scrubbing**: Scrubbing
- **RAID**: RAID for redundancy

## Use Cases

### Use Case 1: General Purpose

**File System**: EXT4

**Use**: General-purpose systems

**Reason**: 
- **Performance**: High performance
- **Stability**: Stable
- **Compatibility**: Wide compatibility

### Use Case 2: Enterprise Storage

**File System**: ZFS

**Use**: Enterprise storage

**Reason**: 
- **Data Integrity**: Data integrity
- **Features**: Advanced features
- **Scalability**: Scalability

### Use Case 3: Linux with Snapshots

**File System**: Btrfs

**Use**: Linux systems needing snapshots

**Reason**: 
- **Snapshots**: Snapshots
- **RAID**: Built-in RAID
- **Linux**: Native Linux support

## Real-World Examples

### Example 1: Linux Desktop

**File System**: EXT4

**Use**: Desktop Linux

**Features**: 
- **Performance**: Fast
- **Stability**: Stable
- **Compatibility**: Compatible

**Result**: Reliable desktop

### Example 2: Storage Server

**File System**: ZFS

**Use**: Storage server

**Features**: 
- **Snapshots**: Snapshots
- **Checksums**: Data integrity
- **Compression**: Compression

**Result**: Reliable storage

## Common Pitfalls

### Problem: Wrong File System

```c
// BAD: Use wrong file system
// Poor performance or missing features

// GOOD: Choose based on needs
// Match features to requirements
```

### Problem: Not Using Snapshots

```c
// BAD: No snapshots
// No easy recovery

// GOOD: Use snapshots
// Regular snapshots for recovery
```

## Quiz

1. What is EXT4?
   - **A)** Database
   - **B)** Linux file system with extents, journaling, and delayed allocation
   - **C)** Cache
   - **D)** Network protocol

2. What is ZFS?
   - **A)** Simple file system
   - **B)** Advanced file system with copy-on-write, snapshots, and checksums
   - **C)** Database
   - **D)** Cache

3. What is copy-on-write?
   - **A)** Overwrite in place
   - **B)** Write to new location, never overwrite existing data
   - **C)** Copy everything
   - **D)** No writes

**Answers:**
1. **B** - EXT4 is the default Linux file system with extent-based allocation, journaling, and delayed allocation for performance
2. **B** - ZFS is an advanced file system with copy-on-write, snapshots, checksums, compression, and storage pooling
3. **B** - Copy-on-write writes data to new locations instead of overwriting, enabling snapshots and data integrity

## Next Steps

- [Process Scheduling Advanced](../operating_systems/17.%20Process%20Scheduling%20Advanced.md) - CFS, MLFQ
- [I/O Subsystems Advanced](../operating_systems/18.%20I-O%20Subsystems%20Advanced.md) - Block devices, DMA

