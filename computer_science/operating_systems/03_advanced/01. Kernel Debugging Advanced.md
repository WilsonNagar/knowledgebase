---
number: 1
title: "Kernel Debugging Advanced"
slug: "kernel-debugging-advanced"
level: "advanced"
tags: ["operating-systems", "kernel", "debugging", "gdb", "kgdb"]
prerequisites: ["boot-process-advanced-uefi-secure-boot"]
estimated_minutes: 150
contributors: []
diagrams: []
examples: []
canonical_id: "cs-os-adv-01"
---

# Kernel Debugging Advanced

## Overview

Advanced kernel debugging techniques enable debugging of kernel code, device drivers, and system-level issues. Understanding kernel debugging tools, techniques, remote debugging, and kernel crash analysis is essential for kernel development and system troubleshooting.

## Table of Contents

1. [Kernel Debugging Challenges](#challenges)
2. [Kernel Debugging Tools](#tools)
3. [KGDB - Kernel GDB](#kgdb)
4. [Kernel Probes](#kernel-probes)
5. [Crash Dump Analysis](#crash-dump)
6. [Kernel Tracing](#tracing)
7. [Remote Debugging](#remote-debugging)
8. [Best Practices](#best-practices)

## Kernel Debugging Challenges

### Challenges

**1. No User Space**:
```
No user space debugger
```

**2. System Crashes**:
```
Debugging can crash system
```

**3. Timing Issues**:
```
Timing-sensitive bugs
```

**4. Hardware Access**:
```
Direct hardware access
```

**5. Privilege**:
```
Requires kernel privileges
```

### Debugging Approaches

**1. Print Statements**:
```
printk() debugging
```

**2. Kernel Debugger**:
```
KGDB, KDB
```

**3. Tracing**:
```
ftrace, perf
```

**4. Crash Dumps**:
```
Analyze crash dumps
```

## Kernel Debugging Tools

### Tool Categories

**1. Debuggers**:
```
KGDB, KDB
```

**2. Tracers**:
```
ftrace, perf, eBPF
```

**3. Probes**:
```
kprobes, uprobes
```

**4. Crash Analysis**:
```
crash utility, gdb
```

### Tool Comparison

| Tool | Type | Use Case |
|------|------|----------|
| **KGDB** | Debugger | Remote kernel debugging |
| **KDB** | Debugger | Local kernel debugging |
| **ftrace** | Tracer | Function tracing |
| **perf** | Profiler | Performance analysis |
| **kprobes** | Probe | Dynamic instrumentation |

## KGDB - Kernel GDB

### What is KGDB?

**KGDB**: Kernel GDB

**Purpose**: Remote kernel debugging

**Method**: 
```
1. Configure kernel with KGDB
2. Connect GDB remotely
3. Debug kernel like user program
```

**Benefit**: Full GDB features

**Use**: Kernel development

### KGDB Setup

**Setup**:
```
1. Enable KGDB in kernel config
2. Boot with kgdboc parameter
3. Connect GDB to kernel
4. Set breakpoints
5. Debug
```

**Connection**: Serial or network

**GDB**: Standard GDB commands

## Kernel Probes

### What are Kernel Probes?

**Kernel Probes**: Dynamic instrumentation

**Types**: 
- **kprobes**: Kernel function probes
- **jprobes**: Jump probes
- **kretprobes**: Return probes

**Purpose**: 
- **Tracing**: Function tracing
- **Debugging**: Dynamic debugging
- **Profiling**: Profiling

### kprobes Example

**kprobe**:
```c
static int handler_pre(struct kprobe *p, struct pt_regs *regs)
{
    printk("Function %s called\n", p->symbol_name);
    return 0;
}

static struct kprobe kp = {
    .symbol_name = "do_fork",
    .pre_handler = handler_pre,
};

register_kprobe(&kp);
```

**Use**: Trace function calls

## Crash Dump Analysis

### What are Crash Dumps?

**Crash Dump**: Memory dump on crash

**Purpose**: Analyze crashes

**Types**: 
- **kdump**: Linux crash dump
- **core dumps**: Process core dumps
- **minidumps**: Windows minidumps

**Analysis**: Analyze offline

### Crash Dump Analysis

**Tools**: 
- **crash**: Linux crash utility
- **gdb**: GDB for dumps
- **WinDbg**: Windows debugger

**Process**:
```
1. Load crash dump
2. Analyze stack traces
3. Examine memory
4. Identify cause
```

## Kernel Tracing

### Tracing Tools

**1. ftrace**:
```
Function tracer
```

**2. perf**:
```
Performance profiler
```

**3. eBPF**:
```
Extended Berkeley Packet Filter
```

**4. SystemTap**:
```
SystemTap
```

### ftrace Example

**ftrace**:
```bash
# Enable tracing
echo function > /sys/kernel/debug/tracing/current_tracer

# Start tracing
echo 1 > /sys/kernel/debug/tracing/tracing_on

# View trace
cat /sys/kernel/debug/tracing/trace
```

**Use**: Function call tracing

## Remote Debugging

### Remote Debugging Setup

**Setup**:
```
1. Configure remote debugging
2. Connect debugger
3. Set breakpoints
4. Debug remotely
```

**Methods**: 
- **Serial**: Serial connection
- **Network**: Network connection
- **JTAG**: JTAG debugging

**Benefit**: Debug without local access

## Best Practices

### Practice 1: Use Appropriate Tools

**Choose**: 
```
Match tool to problem
Print for simple, debugger for complex
```

**Benefit**: Efficient debugging

### Practice 2: Enable Debugging Early

**Enable**: 
```
Enable debugging features early
Don't wait for problems
```

**Benefit**: Easier debugging

### Practice 3: Document Debugging

**Document**: 
```
Document debugging process
Share knowledge
```

**Benefit**: Knowledge sharing

## Real-World Examples

### Example 1: Driver Bug

**Problem**: Driver crash

**Method**: 
- **Crash Dump**: Analyze crash dump
- **Stack Trace**: Examine stack trace
- **Code Review**: Review driver code

**Result**: Identify bug

### Example 2: Performance Issue

**Problem**: Kernel performance

**Method**: 
- **perf**: Profile with perf
- **ftrace**: Trace functions
- **Analysis**: Analyze results

**Result**: Identify bottleneck

## Common Pitfalls

### Problem: Debugging Crashes System

```c
// BAD: Breakpoint in interrupt handler
// System hangs

// GOOD: Use appropriate debugging
// Avoid interrupt handlers
```

### Problem: Too Much Debugging

```c
// BAD: Too many print statements
// Performance impact

// GOOD: Use conditional compilation
// Debug builds only
```

## Quiz

1. What is KGDB?
   - **A)** User space debugger
   - **B)** Remote kernel debugging using GDB
   - **C)** Tracer
   - **D)** Profiler

2. What are kernel probes?
   - **A)** Hardware probes
   - **B)** Dynamic instrumentation for kernel functions
   - **C)** Network probes
   - **D)** Memory probes

3. What is ftrace?
   - **A)** Debugger
   - **B)** Function tracer for kernel
   - **C)** Profiler
   - **D)** Crash analyzer

**Answers:**
1. **B** - KGDB enables remote kernel debugging using GDB over serial or network connection
2. **B** - Kernel probes (kprobes) allow dynamic instrumentation of kernel functions for tracing and debugging
3. **B** - ftrace is a kernel function tracer that can trace function calls and execution flow

## Next Steps

- [Real-Time Systems](./02.%20Real-Time%20Systems.md) - Real-time OS
- [Embedded Systems OS](./03.%20Embedded%20Systems%20OS.md) - Embedded OS

