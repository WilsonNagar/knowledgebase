---
number: 12
title: "Linux Kernel Debugging Tools"
slug: "linux-kernel-debugging-tools"
level: "intermediate"
tags: ["operating-systems", "linux", "debugging", "perf", "ftrace", "ebpf"]
prerequisites: ["boot-process-bios-kernel"]
estimated_minutes: 130
contributors: []
diagrams: []
examples: []
canonical_id: "cs-os-12"
---

# Linux Kernel Debugging Tools

## Overview

Linux kernel debugging tools are essential for performance analysis, troubleshooting, and understanding system behavior. Understanding perf, ftrace, eBPF, and other debugging tools is crucial for system administrators, kernel developers, and performance engineers.

## Table of Contents

1. [Kernel Debugging Overview](#overview)
2. [perf - Performance Analysis](#perf)
3. [ftrace - Function Tracing](#ftrace)
4. [eBPF - Extended Berkeley Packet Filter](#ebpf)
5. [SystemTap](#systemtap)
6. [strace & ltrace](#strace-ltrace)
7. [Kernel Probes](#kernel-probes)
8. [Memory Debugging](#memory-debugging)

## Kernel Debugging Overview

### Challenges

**Kernel Space**: 
- **Privileged**: Full system access
- **Critical**: Bugs affect entire system
- **Complex**: Hard to debug

**Tools Needed**:
- **Performance**: Profile kernel
- **Tracing**: Trace execution
- **Debugging**: Debug issues

## perf - Performance Analysis

### What is perf?

**perf**: Linux performance analysis tool

**Capabilities**:
- **CPU profiling**: Profile CPU usage
- **Hardware events**: CPU counters
- **Software events**: Context switches, page faults
- **Tracing**: Trace system calls, functions

### perf Commands

**1. perf stat**:
```bash
# Count events
perf stat ./program
# Output: Instructions, cycles, cache misses, etc.
```

**2. perf record**:
```bash
# Record profile
perf record ./program
# Creates perf.data file
```

**3. perf report**:
```bash
# Analyze profile
perf report
# Shows hotspots, call graphs
```

**4. perf top**:
```bash
# Real-time profiling
perf top
# Shows functions consuming CPU
```

### perf Examples

**Profile CPU**:
```bash
perf record -g ./my_program
perf report
# Shows call graph, hotspots
```

**Profile Specific Event**:
```bash
perf record -e cache-misses ./my_program
# Profile cache misses
```

**System-Wide Profiling**:
```bash
perf record -a sleep 10
# Profile all processes for 10 seconds
```

## ftrace - Function Tracing

### What is ftrace?

**ftrace**: Linux kernel function tracer

**Capabilities**:
- **Function tracing**: Trace function calls
- **Event tracing**: Trace kernel events
- **Latency tracing**: Measure latencies

### ftrace Interface

**Debug Filesystem**: `/sys/kernel/debug/tracing`

**Files**:
- **trace**: Output
- **set_ftrace_filter**: Filter functions
- **tracing_on**: Enable/disable

### ftrace Usage

**Enable Tracing**:
```bash
echo function > /sys/kernel/debug/tracing/current_tracer
echo 1 > /sys/kernel/debug/tracing/tracing_on
# ... run workload ...
echo 0 > /sys/kernel/debug/tracing/tracing_on
cat /sys/kernel/debug/tracing/trace
```

**Filter Functions**:
```bash
echo sys_read > /sys/kernel/debug/tracing/set_ftrace_filter
# Only trace sys_read
```

**Function Graph**:
```bash
echo function_graph > /sys/kernel/debug/tracing/current_tracer
# Shows call graph
```

## eBPF - Extended Berkeley Packet Filter

### What is eBPF?

**eBPF**: In-kernel virtual machine

**Capabilities**:
- **Tracing**: Trace kernel/user events
- **Filtering**: Filter packets, events
- **Monitoring**: Monitor system behavior
- **Safe**: Verified before execution

### eBPF Programs

**Types**:
- **kprobes**: Kernel function probes
- **uprobes**: User function probes
- **tracepoints**: Static tracepoints
- **perf events**: Hardware/software events

### eBPF Tools

**1. bpftrace**:
```bash
# Trace syscalls
bpftrace -e 'tracepoint:syscalls:sys_enter_open { printf("%s\n", str(args->filename)); }'
```

**2. BCC** (BPF Compiler Collection):
```python
# Python interface to eBPF
from bcc import BPF

b = BPF(text="""
int kprobe__sys_clone(void *ctx) {
    bpf_trace_printk("Hello, World!\\n");
    return 0;
}
""")
```

**3. bpftool**:
```bash
# Manage eBPF programs
bpftool prog list
bpftool map list
```

## SystemTap

### What is SystemTap?

**SystemTap**: Dynamic tracing framework

**Capabilities**:
- **Kernel tracing**: Trace kernel functions
- **User tracing**: Trace user functions
- **Scripting**: Write tracing scripts

### SystemTap Scripts

**Basic Script**:
```stap
probe kernel.function("sys_open") {
    printf("%s opened %s\n", execname(), filename)
}
```

**Run Script**:
```bash
stap script.stp
```

**Precompiled**:
```bash
stap -p4 script.stp  # Generate C code
```

## strace & ltrace

### strace

**strace**: Trace system calls

**Usage**:
```bash
strace ./program
# Shows all system calls

strace -e trace=open,read ./program
# Trace specific syscalls

strace -c ./program
# Summary statistics
```

**Output**:
```
open("/etc/passwd", O_RDONLY) = 3
read(3, "root:x:0:0:root:/root:/bin/bash\n"..., 4096) = 1234
close(3) = 0
```

### ltrace

**ltrace**: Trace library calls

**Usage**:
```bash
ltrace ./program
# Shows library function calls

ltrace -c ./program
# Summary statistics
```

**Output**:
```
malloc(1024) = 0x12345678
strcpy(0x12345678, "hello") = 0x12345678
free(0x12345678) = <void>
```

## Kernel Probes

### kprobes

**kprobes**: Dynamic kernel probes

**Usage**:
```bash
# Insert probe
echo 'p:myprobe sys_read' > /sys/kernel/debug/tracing/kprobe_events

# Enable
echo 1 > /sys/kernel/debug/tracing/events/kprobes/myprobe/enable

# View
cat /sys/kernel/debug/tracing/trace
```

### uprobes

**uprobes**: User-space probes

**Usage**:
```bash
# Probe user function
echo 'p:myuprobe /bin/ls:0x1234' > /sys/kernel/debug/tracing/uprobe_events
```

## Memory Debugging

### kmemleak

**kmemleak**: Detect kernel memory leaks

**Usage**:
```bash
# Enable
echo scan > /sys/kernel/debug/kmemleak

# Check
cat /sys/kernel/debug/kmemleak
```

### KASAN

**KASAN**: Kernel Address Sanitizer

**Purpose**: Detect memory errors

**Features**:
- **Use-after-free**: Detect use after free
- **Out-of-bounds**: Detect buffer overflows
- **Double-free**: Detect double free

## Real-World Examples

### Example 1: Performance Profiling

**Problem**: Slow application

**Solution**:
```bash
perf record -g ./slow_app
perf report
# Identify hotspots
```

### Example 2: System Call Tracing

**Problem**: Application not working

**Solution**:
```bash
strace ./app 2>&1 | grep -i error
# See what system calls fail
```

### Example 3: Kernel Function Tracing

**Problem**: Slow I/O

**Solution**:
```bash
echo 1 > /sys/kernel/debug/tracing/tracing_on
echo function_graph > /sys/kernel/debug/tracing/current_tracer
echo sys_read > /sys/kernel/debug/tracing/set_graph_function
# ... run I/O ...
cat /sys/kernel/debug/tracing/trace
```

## Common Pitfalls

### Problem: Overhead

```bash
# BAD: Trace everything
perf record -a  # High overhead!

# GOOD: Filter events
perf record -e cpu-cycles ./program
```

### Problem: Not Understanding Output

```bash
# BAD: Just run perf without understanding
perf report  # May misinterpret results

# GOOD: Understand what you're measuring
# Read documentation, understand events
```

## Quiz

1. What is perf used for?
   - **A)** Memory management
   - **B)** Performance analysis and profiling
   - **C)** Network configuration
   - **D)** File system management

2. What is eBPF?
   - **A)** Encryption protocol
   - **B)** In-kernel virtual machine for safe, verified tracing and monitoring
   - **C)** File system
   - **D)** Network protocol

3. What does strace trace?
   - **A)** Library calls
   - **B)** System calls
   - **C)** Function calls
   - **D)** Network packets

**Answers:**
1. **B** - perf is a performance analysis tool for profiling CPU usage, counting hardware/software events, and tracing system behavior
2. **B** - eBPF is an in-kernel virtual machine that allows safe, verified programs to run in the kernel for tracing, filtering, and monitoring
3. **B** - strace traces system calls made by a process, showing interactions with the kernel

## Next Steps

- [Process Lifecycle & LMK](./13.%20Process%20Lifecycle%20%26%20LMK.md) - Process management
- [Power Management](./14.%20Power%20Management.md) - System power optimization

