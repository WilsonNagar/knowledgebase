---
number: 7
title: "Profiling Tools - perf, Valgrind, Instruments"
slug: "profiling-tools-perf-valgrind-instruments"
level: "intermediate"
tags: ["performance", "profiling", "tools", "perf", "valgrind", "instruments"]
prerequisites: ["algorithmic-optimization"]
estimated_minutes: 145
contributors: []
diagrams: []
examples: []
canonical_id: "cs-mem-07"
---

# Profiling Tools - perf, Valgrind, Instruments

## Overview

Profiling tools help identify performance bottlenecks and memory issues. Understanding tools like perf (Linux), Valgrind, and Instruments (macOS) is essential for performance analysis and optimization.

## Table of Contents

1. [What is Profiling?](#what-is-profiling)
2. [perf (Linux)](#perf)
3. [Valgrind](#valgrind)
4. [Instruments (macOS)](#instruments)
5. [Profiling Types](#profiling-types)
6. [Interpreting Results](#interpreting)
7. [Best Practices](#best-practices)
8. [Real-World Examples](#examples)

## What is Profiling?

### Definition

**Profiling**: Analyze program execution

**Purpose**: 
- **Bottlenecks**: Identify bottlenecks
- **Hotspots**: Find hotspots
- **Memory**: Analyze memory usage
- **Optimization**: Guide optimization

**Types**: 
- **CPU Profiling**: CPU usage
- **Memory Profiling**: Memory usage
- **I/O Profiling**: I/O operations

## perf (Linux)

### What is perf?

**perf**: Linux performance profiler

**Features**: 
- **CPU Profiling**: CPU profiling
- **Hardware Events**: Hardware counters
- **Call Graphs**: Call graphs
- **Sampling**: Statistical sampling

**Use**: Linux performance analysis

### perf Commands

**Record**:
```bash
perf record ./program
```

**Report**:
```bash
perf report
```

**Top**:
```bash
perf top
```

**Stat**:
```bash
perf stat ./program
```

### perf Examples

**CPU Profiling**:
```bash
# Record
perf record -g ./program

# Report
perf report

# Flame graph
perf script | stackcollapse-perf.pl | flamegraph.pl > flame.svg
```

**Hardware Events**:
```bash
perf stat -e cache-misses,cache-references ./program
```

## Valgrind

### What is Valgrind?

**Valgrind**: Memory error detector

**Tools**: 
- **memcheck**: Memory error detector
- **massif**: Heap profiler
- **callgrind**: Call graph profiler
- **cachegrind**: Cache profiler

**Use**: Memory debugging, profiling

### Valgrind memcheck

**Memory Error Detection**:
```bash
valgrind --tool=memcheck ./program
```

**Detects**: 
- **Leaks**: Memory leaks
- **Use-After-Free**: Use after free
- **Invalid Access**: Invalid memory access
- **Uninitialized**: Uninitialized values

### Valgrind massif

**Heap Profiling**:
```bash
valgrind --tool=massif ./program
ms_print massif.out.*
```

**Shows**: 
- **Heap Usage**: Heap usage over time
- **Peaks**: Peak heap usage
- **Allocation Sites**: Where allocated

### Valgrind callgrind

**Call Graph Profiling**:
```bash
valgrind --tool=callgrind ./program
kcachegrind callgrind.out.*
```

**Shows**: 
- **Call Graph**: Function call graph
- **Time**: Time per function
- **Call Counts**: Call counts

## Instruments (macOS)

### What is Instruments?

**Instruments**: macOS profiling tool

**Features**: 
- **Time Profiler**: CPU profiling
- **Allocations**: Memory allocations
- **Leaks**: Memory leak detection
- **Energy**: Energy profiling

**Use**: macOS/iOS profiling

### Instruments Templates

**1. Time Profiler**:
```
CPU profiling
```

**2. Allocations**:
```
Memory allocations
```

**3. Leaks**:
```
Memory leak detection
```

**4. System Trace**:
```
System-level tracing
```

### Instruments Usage

**1. Open Instruments**:
```
Open Instruments
Select template
```

**2. Record**:
```
Record application
```

**3. Analyze**:
```
Analyze results
```

**4. Optimize**:
```
Optimize based on results
```

## Profiling Types

### CPU Profiling

**CPU Profiling**: Measure CPU usage

**Methods**: 
- **Sampling**: Statistical sampling
- **Instrumentation**: Code instrumentation

**Tools**: 
- **perf**: Linux
- **Instruments**: macOS
- **gprof**: GNU profiler

### Memory Profiling

**Memory Profiling**: Analyze memory usage

**Metrics**: 
- **Allocations**: Allocation counts
- **Size**: Allocation sizes
- **Leaks**: Memory leaks
- **Fragmentation**: Fragmentation

**Tools**: 
- **Valgrind**: Linux
- **Instruments**: macOS
- **Dr. Memory**: Windows

### I/O Profiling

**I/O Profiling**: Analyze I/O operations

**Metrics**: 
- **Reads/Writes**: I/O counts
- **Latency**: I/O latency
- **Throughput**: I/O throughput

**Tools**: 
- **perf**: Linux
- **Instruments**: macOS
- **strace**: Linux

## Interpreting Results

### CPU Profiling Results

**Hotspots**: 
```
Functions using most CPU
```

**Call Graph**: 
```
Function call relationships
```

**Optimization**: 
```
Focus on hotspots
```

### Memory Profiling Results

**Allocations**: 
```
Where memory allocated
```

**Leaks**: 
```
Memory leaks identified
```

**Optimization**: 
```
Fix leaks, reduce allocations
```

## Best Practices

### Practice 1: Profile Release Builds

**Release Builds**: 
```
Profile optimized builds
```

**Benefit**: Real performance

### Practice 2: Multiple Runs

**Multiple Runs**: 
```
Run multiple times
```

**Benefit**: More reliable results

### Practice 3: Focus on Hotspots

**Hotspots**: 
```
Focus optimization on hotspots
```

**Benefit**: Biggest impact

## Real-World Examples

### Example 1: CPU Bottleneck

**Problem**: Slow performance

**Profiling**: perf shows hotspot

**Optimization**: Optimize hotspot

**Result**: Significant speedup

### Example 2: Memory Leak

**Problem**: Memory leak

**Profiling**: Valgrind identifies leak

**Fix**: Fix leak

**Result**: Leak fixed

## Common Pitfalls

### Problem: Profiling Debug Builds

```c
// BAD: Profile debug builds
// Not representative

// GOOD: Profile release builds
// Real performance
```

### Problem: Ignoring Results

```c
// BAD: Don't act on results
// No improvement

// GOOD: Optimize based on results
// Real improvement
```

## Quiz

1. What is perf?
   - **A)** Performance test
   - **B)** Linux performance profiler with hardware event support
   - **C)** Memory profiler
   - **D)** Code analyzer

2. What does Valgrind memcheck detect?
   - **A)** CPU usage
   - **B)** Memory errors like leaks, use-after-free, invalid access
   - **C)** I/O operations
   - **D)** Network operations

3. What is Instruments?
   - **A)** Linux tool
   - **B)** macOS profiling tool for CPU, memory, and energy profiling
   - **C)** Windows tool
   - **D)** Web tool

**Answers:**
1. **B** - perf is a Linux performance profiler that uses statistical sampling and hardware performance counters to analyze CPU usage
2. **B** - Valgrind memcheck detects memory errors including leaks, use-after-free, invalid memory access, and uninitialized value usage
3. **B** - Instruments is Apple's profiling tool for macOS/iOS, providing templates for CPU profiling, memory analysis, leak detection, and energy profiling

## Next Steps

- [Memory Management Advanced](../memory_performance/08.%20Memory%20Management%20Advanced.md) - Advanced memory
- [Performance Engineering Patterns](../memory_performance/09.%20Performance%20Engineering%20Patterns.md) - Performance patterns

