---
number: 2
title: "Kubernetes Internals"
slug: "kubernetes-internals"
level: "intermediate"
tags: ["cloud", "kubernetes", "k8s", "orchestration", "containers"]
prerequisites: ["containers-namespaces-cgroups"]
estimated_minutes: 130
contributors: []
diagrams: []
examples: []
canonical_id: "cs-cloud-02"
---

# Kubernetes Internals

## Overview

Kubernetes is the de facto standard for container orchestration. Understanding Kubernetes architecture, components (API server, etcd, kubelet, controllers), pod lifecycle, scheduling, and networking is essential for DevOps, cloud engineering, and modern application deployment.

## Table of Contents

1. [Kubernetes Overview](#overview)
2. [Kubernetes Architecture](#architecture)
3. [Control Plane Components](#control-plane)
4. [Node Components](#node-components)
5. [Pods & Containers](#pods)
6. [Pod Lifecycle](#pod-lifecycle)
7. [Scheduling](#scheduling)
8. [Networking](#networking)
9. [Storage](#storage)
10. [Controllers & Operators](#controllers)

## Kubernetes Overview

### What is Kubernetes?

**Kubernetes**: Container orchestration platform

**Purpose**: Automate deployment, scaling, management of containers

**Features**:
- **Self-healing**: Restart failed containers
- **Scaling**: Scale up/down automatically
- **Load balancing**: Distribute traffic
- **Rolling updates**: Zero-downtime deployments

### Kubernetes Concepts

**Pod**: Smallest deployable unit (one or more containers)

**Deployment**: Manages pod replicas

**Service**: Stable network endpoint for pods

**Namespace**: Virtual cluster (resource isolation)

## Kubernetes Architecture

### Cluster Structure

**Master Node** (Control Plane):
- **API Server**: Central control
- **etcd**: Cluster state storage
- **Scheduler**: Pod scheduling
- **Controller Manager**: Controllers

**Worker Nodes**:
- **kubelet**: Node agent
- **kube-proxy**: Network proxy
- **Container Runtime**: Docker, containerd, etc.

### Communication Flow

```
User/Controller → API Server → etcd
                         ↓
                    Scheduler
                         ↓
                    kubelet → Containers
```

## Control Plane Components

### API Server

**Purpose**: Central control point

**Functions**:
- **REST API**: Kubernetes API
- **Authentication**: Verify users
- **Authorization**: Check permissions
- **Validation**: Validate resources
- **Watch**: Watch for changes

**Communication**: All components communicate via API server

### etcd

**Purpose**: Distributed key-value store

**Stores**:
- **Cluster state**: All cluster data
- **Configurations**: Cluster config
- **Secrets**: Encrypted secrets

**Characteristics**:
- **Consistent**: Strong consistency
- **Highly available**: Replicated
- **Fast**: Low latency

### Scheduler

**Purpose**: Assign pods to nodes

**Process**:
```
1. Watch for unscheduled pods
2. Filter nodes (feasible)
3. Score nodes (best fit)
4. Bind pod to node
```

**Factors**:
- **Resources**: CPU, memory availability
- **Affinity**: Node/pod affinity rules
- **Taints**: Node taints and tolerations

### Controller Manager

**Purpose**: Run controllers

**Controllers**:
- **Replication Controller**: Maintain replica count
- **Deployment Controller**: Manage deployments
- **Node Controller**: Monitor nodes
- **Service Controller**: Manage services

## Node Components

### kubelet

**Purpose**: Node agent

**Functions**:
- **Pod management**: Start/stop pods
- **Health checks**: Monitor pod health
- **Resource reporting**: Report node resources
- **Volume mounting**: Mount volumes

**Communication**: With API server

### kube-proxy

**Purpose**: Network proxy

**Functions**:
- **Service proxy**: Forward traffic to pods
- **Load balancing**: Distribute load
- **Network rules**: iptables/ipvs rules

**Modes**:
- **iptables**: Linux iptables rules
- **ipvs**: IP Virtual Server
- **userspace**: User-space proxy (deprecated)

### Container Runtime

**Purpose**: Run containers

**Runtimes**:
- **Docker**: Docker engine
- **containerd**: CNCF runtime
- **CRI-O**: OCI runtime

**Interface**: CRI (Container Runtime Interface)

## Pods & Containers

### What is a Pod?

**Pod**: Smallest deployable unit

**Contains**: One or more containers

**Shared**:
- **Network**: Same IP, ports
- **Storage**: Shared volumes
- **Namespace**: Same namespace

**Isolation**: Each pod isolated

### Pod Structure

**Pod Spec**:
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
spec:
  containers:
  - name: app
    image: nginx:latest
    ports:
    - containerPort: 80
  volumes:
  - name: data
    emptyDir: {}
```

### Multi-Container Pods

**Sidecar Pattern**:
```
Pod:
  - Main container (app)
  - Sidecar container (logging, monitoring)
```

**Init Containers**:
```
Pod:
  - Init containers (run first, sequentially)
  - Main containers (run after init)
```

## Pod Lifecycle

### Pod States

**Pending**: Pod accepted, not yet scheduled

**Running**: Pod bound to node, containers running

**Succeeded**: All containers terminated successfully

**Failed**: At least one container failed

**Unknown**: Pod state cannot be determined

### Pod Lifecycle Events

**1. Creation**:
```
API Server → Scheduler → kubelet → Container Runtime
```

**2. Running**:
```
Containers start
Health checks begin
```

**3. Termination**:
```
Graceful shutdown (SIGTERM)
Force kill if needed (SIGKILL)
```

## Scheduling

### Scheduling Process

**Step 1: Filtering**:
```
Filter nodes that can run pod:
  - Resources available
  - Node selector matches
  - Taints/tolerations
  - Affinity rules
```

**Step 2: Scoring**:
```
Score filtered nodes:
  - Resource availability
  - Affinity preferences
  - Anti-affinity
  - Select best node
```

**Step 3: Binding**:
```
Bind pod to selected node
kubelet on node starts pod
```

### Scheduling Policies

**Node Affinity**:
```yaml
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: zone
          operator: In
          values: ["us-east-1a"]
```

**Pod Affinity**:
```yaml
affinity:
  podAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchLabels:
          app: database
      topologyKey: zone
```

## Networking

### Kubernetes Networking Model

**Requirements**:
- **Pods**: Can communicate without NAT
- **Nodes**: Can communicate with pods
- **Services**: Stable IPs for pods

### Pod Networking

**CNI**: Container Network Interface

**Plugins**:
- **Flannel**: Simple overlay network
- **Calico**: Policy-based networking
- **Weave**: Encrypted networking

**Pod IP**: Assigned by CNI plugin

### Service Networking

**Service Types**:
- **ClusterIP**: Internal service (default)
- **NodePort**: Expose on node port
- **LoadBalancer**: Cloud load balancer
- **ExternalName**: External service

**Service Example**:
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: my-app
  ports:
  - port: 80
    targetPort: 8080
  type: ClusterIP
```

## Storage

### Volume Types

**1. emptyDir**:
```
Temporary storage
Deleted when pod deleted
```

**2. hostPath**:
```
Mount host directory
Node-specific
```

**3. PersistentVolume**:
```
Persistent storage
Survives pod deletion
```

**4. ConfigMap/Secret**:
```
Configuration data
Mounted as volumes
```

### Persistent Volumes

**PV**: Cluster resource

**PVC**: Pod request for storage

**Process**:
```
1. Admin creates PV
2. User creates PVC
3. Kubernetes binds PVC to PV
4. Pod uses PVC
```

## Controllers & Operators

### Controllers

**Purpose**: Maintain desired state

**ReplicaSet Controller**:
```
Maintains desired replica count
Creates/deletes pods as needed
```

**Deployment Controller**:
```
Manages ReplicaSets
Handles rolling updates
```

**StatefulSet Controller**:
```
Manages stateful applications
Ordered deployment
Stable network identities
```

### Operators

**Purpose**: Extend Kubernetes

**Custom Resources**: Define custom resources

**Controllers**: Manage custom resources

**Example**: Database operator manages database instances

## Real-World Examples

### Example 1: Web Application Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
      - name: app
        image: web-app:latest
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: web-service
spec:
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 8080
  type: LoadBalancer
```

### Example 2: Database StatefulSet

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: database
spec:
  serviceName: database
  replicas: 3
  template:
    spec:
      containers:
      - name: db
        image: postgres:13
        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
```

## Common Pitfalls

### Problem: Resource Limits

```yaml
# BAD: No resource limits
containers:
- name: app
  image: app:latest
# May consume all resources

# GOOD: Set limits
containers:
- name: app
  image: app:latest
  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"
```

### Problem: Not Handling Failures

```yaml
# BAD: No health checks
containers:
- name: app
  image: app:latest
# Kubernetes doesn't know if app is healthy

# GOOD: Add health checks
containers:
- name: app
  image: app:latest
  livenessProbe:
    httpGet:
      path: /health
      port: 8080
  readinessProbe:
    httpGet:
      path: /ready
      port: 8080
```

## Quiz

1. What is a Pod in Kubernetes?
   - **A)** Container
   - **B)** Smallest deployable unit containing one or more containers
   - **C)** Node
   - **D)** Service

2. What is the purpose of the Kubernetes Scheduler?
   - **A)** Manage storage
   - **B)** Assign pods to nodes based on resources and constraints
   - **C)** Manage networking
   - **D)** Run containers

3. What does etcd store in Kubernetes?
   - **A)** Container images
   - **B)** Cluster state and configurations
   - **C)** Logs
   - **D)** Metrics

**Answers:**
1. **B** - A Pod is the smallest deployable unit in Kubernetes, containing one or more containers that share network and storage
2. **B** - The Scheduler watches for unscheduled pods and assigns them to nodes based on resource availability, affinity rules, and other constraints
3. **B** - etcd is a distributed key-value store that stores all cluster state, configurations, and secrets in Kubernetes

## Next Steps

- [Docker Internals - Layers & Union FS](../cloud_infrastructure/03.%20Docker%20Internals.md) - Docker storage
- [Service Meshes - Istio](./03.%20Service%20Meshes%20-%20Istio.md) - Microservices networking

