---
number: 10
title: "Speculative Execution & Security"
slug: "speculative-execution-security"
level: "intermediate"
tags: ["computer-architecture", "speculative-execution", "security", "spectre", "meltdown"]
prerequisites: ["out-of-order-execution"]
estimated_minutes: 140
contributors: []
diagrams: []
examples: []
canonical_id: "cs-arch-10"
---

# Speculative Execution & Security

## Overview

Speculative execution improves performance by executing instructions before knowing if they're needed, but creates security vulnerabilities like Spectre and Meltdown. Understanding speculative execution, side-channel attacks, and mitigation techniques is essential for understanding modern CPU security.

## Table of Contents

1. [What is Speculative Execution?](#what-is-speculative)
2. [Branch Prediction](#branch-prediction)
3. [Speculative Execution Process](#process)
4. [Security Vulnerabilities](#vulnerabilities)
5. [Spectre Attacks](#spectre)
6. [Meltdown Attack](#meltdown)
7. [Mitigations](#mitigations)
8. [Real-World Impact](#impact)

## What is Speculative Execution?

### Definition

**Speculative Execution**: Execute instructions before knowing if needed

**Purpose**: Improve performance

**Method**: 
```
Predict branch outcome
Execute speculatively
Rollback if wrong
```

**Benefit**: Hide branch latency

**Risk**: Security vulnerabilities

### Why Speculative Execution?

**Problem**: Branches cause stalls

**Solution**: Predict and execute speculatively

**Benefit**: Better performance

**Example**:
```
if (condition) {
    // Predict taken
    // Execute speculatively
    // Rollback if wrong
}
```

## Branch Prediction

### What is Branch Prediction?

**Branch Prediction**: Predict branch outcome

**Purpose**: Guide speculative execution

**Methods**: 
- **Static**: Always predict same
- **Dynamic**: Based on history
- **Pattern-Based**: Based on patterns

**Accuracy**: 90-95% accurate

### Branch Prediction Types

**1. Always Taken**:
```
Always predict taken
```

**2. Always Not Taken**:
```
Always predict not taken
```

**3. Bimodal Predictor**:
```
2-bit saturating counter
```

**4. Two-Level Predictor**:
```
Pattern-based prediction
```

**5. Tournament Predictor**:
```
Combine multiple predictors
```

## Speculative Execution Process

### Process Steps

**1. Predict**:
```
Predict branch outcome
```

**2. Execute**:
```
Execute speculatively
```

**3. Check**:
```
Check if prediction correct
```

**4. Commit or Rollback**:
```
Commit if correct
Rollback if wrong
```

### Speculative State

**Speculative State**: State during speculation

**Characteristics**: 
- **Temporary**: Temporary state
- **Not Committed**: Not committed yet
- **Rollback**: Can be rolled back

**Problem**: Side effects visible

## Security Vulnerabilities

### The Problem

**Problem**: Speculative execution leaks information

**Method**: 
```
Speculatively access memory
Cache side effects
Measure cache timing
```

**Impact**: Read unauthorized memory

### Side-Channel Attacks

**Side-Channel**: Use implementation details

**Types**: 
- **Timing**: Execution time
- **Cache**: Cache behavior
- **Power**: Power consumption
- **Electromagnetic**: EM emissions

**Use**: Extract secrets

## Spectre Attacks

### What is Spectre?

**Spectre**: Speculative execution attack

**Variant 1**: Bounds check bypass

**Variant 2**: Branch target injection

**Impact**: Read arbitrary memory

### Spectre Variant 1

**Attack**: 
```
1. Train branch predictor
2. Cause bounds check to be mispredicted
3. Speculatively access out-of-bounds memory
4. Cache side effect
5. Measure cache timing
```

**Example**:
```c
if (x < array_size) {
    // Mispredict: x >= array_size
    // Speculatively execute
    value = array[x];  // Out of bounds
    // Cache side effect
    // Measure timing
}
```

### Spectre Variant 2

**Attack**: 
```
1. Poison branch target buffer
2. Cause indirect branch to wrong target
3. Execute attacker code speculatively
4. Leak secrets
```

**Impact**: More powerful than Variant 1

## Meltdown Attack

### What is Meltdown?

**Meltdown**: Speculative execution attack

**Target**: Kernel memory

**Method**: 
```
1. Speculatively access kernel memory
2. Cache side effect
3. Measure cache timing
4. Recover kernel memory
```

**Impact**: Read kernel memory from user space

### Meltdown Process

**Process**:
```
1. Load kernel address speculatively
2. Use value to index array
3. Cache array element
4. Measure cache timing
5. Recover kernel memory
```

**Vulnerability**: Out-of-order execution

## Mitigations

### Software Mitigations

**1. Retpoline**:
```
Return trampoline
Prevent branch target injection
```

**2. LFENCE**:
```
Load fence
Prevent speculation
```

**3. Bounds Check**:
```
Strengthen bounds checks
```

**4. Indirect Branch Limiting**:
```
Limit indirect branches
```

### Hardware Mitigations

**1. Speculation Barriers**:
```
Hardware barriers
```

**2. Indirect Branch Restricted Speculation**:
```
Restrict speculation
```

**3. Single Thread Indirect Branch Predictors**:
```
Per-thread predictors
```

**4. Enhanced IBRS**:
```
Enhanced indirect branch restrictions
```

### Performance Impact

**Mitigations**: Reduce performance

**Impact**: 5-30% performance reduction

**Trade-off**: Security vs performance

## Real-World Impact

### Impact on Industry

**1. CPU Vendors**:
```
Release microcode updates
```

**2. Operating Systems**:
```
Implement mitigations
```

**3. Applications**:
```
Update applications
```

**4. Performance**:
```
Performance degradation
```

### Affected Processors

**Spectre**: 
- **Intel**: Most processors
- **AMD**: Some processors
- **ARM**: Some processors

**Meltdown**: 
- **Intel**: Most processors
- **ARM**: Some processors
- **AMD**: Not affected

## Common Pitfalls

### Problem: Ignoring Mitigations

```c
// BAD: Ignore mitigations
// Vulnerable to attacks

// GOOD: Apply mitigations
// Secure systems
```

### Problem: Assuming Security

```c
// BAD: Assume hardware is secure
// May have vulnerabilities

// GOOD: Understand vulnerabilities
// Apply mitigations
```

## Quiz

1. What is speculative execution?
   - **A)** Executing instructions in order
   - **B)** Executing instructions before knowing if needed, based on predictions
   - **C)** Executing instructions randomly
   - **D)** Executing instructions slowly

2. What is Spectre?
   - **A)** CPU feature
   - **B)** Speculative execution attack that leaks memory through side channels
   - **C)** CPU instruction
   - **D)** CPU register

3. What is Meltdown?
   - **A)** CPU feature
   - **B)** Speculative execution attack that reads kernel memory
   - **C)** CPU instruction
   - **D)** CPU cache

**Answers:**
1. **B** - Speculative execution executes instructions speculatively based on branch predictions, improving performance but creating security risks
2. **B** - Spectre is a class of attacks that exploit speculative execution to leak memory through cache timing side channels
3. **B** - Meltdown exploits speculative execution to read kernel memory from user space by speculatively accessing kernel addresses

## Next Steps

- [GPU Computing Advanced](../computer_architecture/11.%20GPU%20Computing%20Advanced.md) - Advanced GPU
- [Quantum Computing Fundamentals](../computer_architecture/12.%20Quantum%20Computing%20Fundamentals.md) - Quantum computing

