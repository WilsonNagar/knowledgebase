---
number: 7
title: "Distributed Tracing"
slug: "distributed-tracing"
level: "intermediate"
tags: ["distributed-systems", "tracing", "observability", "microservices", "debugging"]
prerequisites: ["gossip-protocols"]
estimated_minutes: 110
contributors: []
diagrams: []
examples: []
canonical_id: "cs-dist-07"
---

# Distributed Tracing

## Overview

Distributed tracing tracks requests as they flow through distributed systems, providing visibility into system behavior and performance. Understanding trace collection, span correlation, and tracing systems like OpenTracing, OpenTelemetry, and Jaeger is essential for debugging and monitoring microservices.

## Table of Contents

1. [The Tracing Problem](#tracing-problem)
2. [What is Distributed Tracing?](#what-is-tracing)
3. [Spans & Traces](#spans-traces)
4. [Trace Collection](#trace-collection)
5. [Trace Correlation](#trace-correlation)
6. [Sampling](#sampling)
7. [Tracing Systems](#tracing-systems)
8. [Best Practices](#best-practices)

## The Tracing Problem

### The Challenge

**Distributed Systems**: Requests span multiple services

**Problem**: Hard to debug, understand flow

**Questions**:
- Where did request go?
- Which service is slow?
- What caused error?

**Solution**: Distributed tracing

## What is Distributed Tracing?

### Definition

**Distributed Tracing**: Track request across services

**Purpose**: Understand request flow, identify bottlenecks

**Components**: Traces, spans, context propagation

**Use**: Debugging, performance analysis, monitoring

### Tracing Benefits

**1. Visibility**:
```
See request path through system
```

**2. Performance Analysis**:
```
Identify slow services
Find bottlenecks
```

**3. Debugging**:
```
Trace errors to source
Understand failures
```

**4. Monitoring**:
```
Monitor system health
Track SLAs
```

## Spans & Traces

### Span

**Span**: Single operation in trace

**Properties**:
- **Name**: Operation name
- **Start time**: When started
- **Duration**: How long took
- **Tags**: Key-value metadata
- **Logs**: Events during span

**Example**:
```
Span: "database_query"
Start: 10:00:00.000
Duration: 50ms
Tags: {db: "users", query: "SELECT"}
```

### Trace

**Trace**: Collection of spans

**Structure**: Tree of spans

**Root Span**: Initial request

**Child Spans**: Operations within request

**Example**:
```
Trace:
  Span: HTTP Request (100ms)
    Span: Auth Service (20ms)
    Span: Database Query (50ms)
    Span: Cache Lookup (10ms)
```

## Trace Collection

### Collection Process

**1. Instrumentation**:
```
Add tracing code to services
```

**2. Context Propagation**:
```
Pass trace context between services
```

**3. Span Creation**:
```
Create spans for operations
```

**4. Export**:
```
Send spans to tracing backend
```

### Instrumentation

**Manual**: Add tracing code manually

**Automatic**: Auto-instrumentation (libraries)

**Example**:
```python
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

with tracer.start_as_current_span("database_query") as span:
    span.set_attribute("db", "users")
    result = db.query("SELECT * FROM users")
    span.set_attribute("rows", len(result))
```

## Trace Correlation

### Context Propagation

**Problem**: Correlate spans across services

**Solution**: Propagate trace context

**Methods**:
- **HTTP Headers**: Trace-ID, Span-ID
- **gRPC Metadata**: Trace context
- **Message Headers**: For message queues

### Trace Context

**Trace-ID**: Unique identifier for trace

**Span-ID**: Unique identifier for span

**Parent Span-ID**: Parent span identifier

**Flags**: Sampling flags

**Example Header**:
```
X-Trace-Id: abc123
X-Span-Id: def456
X-Parent-Span-Id: ghi789
```

## Sampling

### Why Sampling?

**Problem**: High volume of traces

**Solution**: Sample traces

**Methods**:
- **Head-based**: Decide at start
- **Tail-based**: Decide at end
- **Rate-based**: Sample percentage

### Sampling Strategies

**1. Always Sample**:
```
Sample 100%
Use: Development, debugging
```

**2. Rate Sampling**:
```
Sample X% of traces
Use: Production
```

**3. Adaptive Sampling**:
```
Sample based on conditions
Use: Sample errors, slow requests
```

## Tracing Systems

### OpenTracing

**Standard**: Vendor-neutral API

**Purpose**: Standardize tracing

**Status**: Merged into OpenTelemetry

### OpenTelemetry

**Standard**: Unified observability

**Components**:
- **Tracing**: Distributed tracing
- **Metrics**: Metrics collection
- **Logging**: Log collection

**Status**: Active standard

### Jaeger

**System**: Distributed tracing system

**Features**:
- **Collection**: Collect traces
- **Storage**: Store traces
- **UI**: Visualize traces

**Use**: Popular open-source tracer

### Zipkin

**System**: Distributed tracing system

**Features**: Similar to Jaeger

**Use**: Alternative to Jaeger

## Best Practices

### Tracing Best Practices

**1. Instrument Key Operations**:
```
Trace important operations
Don't over-instrument
```

**2. Meaningful Names**:
```
Use descriptive span names
```

**3. Add Context**:
```
Add relevant tags/logs
```

**4. Sample Appropriately**:
```
Balance detail vs overhead
```

**5. Correlate with Logs**:
```
Include trace ID in logs
```

## Real-World Examples

### Example 1: Microservices Request

**Flow**:
```
API Gateway → Auth Service → User Service → Database
```

**Trace**: Shows all services, timing

**Benefit**: Identify slow service

### Example 2: Error Debugging

**Problem**: Error in production

**Solution**: 
```
1. Find trace with error
2. See which service failed
3. Check span logs
4. Identify root cause
```

## Common Pitfalls

### Problem: Over-Instrumentation

```python
# BAD: Trace every operation
# High overhead, too much data

# GOOD: Trace key operations
# Balance detail vs overhead
```

### Problem: Not Propagating Context

```python
# BAD: Don't propagate trace context
# Spans not correlated

# GOOD: Propagate trace context
# Use headers/metadata
```

## Quiz

1. What is distributed tracing?
   - **A)** Logging
   - **B)** Tracking requests across distributed services to understand flow and performance
   - **C)** Monitoring
   - **D)** Debugging

2. What is a span?
   - **A)** Trace
   - **B)** Single operation in a trace with timing and metadata
   - **C)** Service
   - **D)** Request

3. What is trace correlation?
   - **A)** Combining traces
   - **B)** Linking spans across services using trace context propagation
   - **C)** Sampling traces
   - **D)** Storing traces

**Answers:**
1. **B** - Distributed tracing tracks requests as they flow through multiple services in a distributed system, providing visibility into request paths, timing, and performance
2. **B** - A span represents a single operation (like a database query or HTTP call) within a trace, containing timing information, metadata (tags), and events (logs)
3. **B** - Trace correlation links spans from different services into a single trace by propagating trace context (trace ID, span ID) through headers or metadata

## Next Steps

- [Service Discovery](./08.%20Service%20Discovery%20-%20Consul%2C%20etcd%2C%20ZooKeeper.md) - Finding services
- [Distributed Caching](./09.%20Distributed%20Caching%20-%20Redis%2C%20Memcached%20Strategies.md) - Caching strategies

