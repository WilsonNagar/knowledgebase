---
number: 2
title: "Event Sourcing & CQRS"
slug: "event-sourcing-cqrs"
level: "advanced"
tags: ["distributed-systems", "event-sourcing", "cqrs", "event-driven", "architecture"]
prerequisites: ["distributed-transactions-2pc-3pc-saga"]
estimated_minutes: 145
contributors: []
diagrams: []
examples: []
canonical_id: "cs-dist-adv-02"
---

# Event Sourcing & CQRS

## Overview

Event Sourcing stores state changes as events, and CQRS (Command Query Responsibility Segregation) separates read and write models. Understanding these patterns, their implementations, and trade-offs is essential for building scalable, event-driven distributed systems.

## Table of Contents

1. [What is Event Sourcing?](#what-is-event-sourcing)
2. [Event Sourcing Architecture](#event-sourcing-architecture)
3. [What is CQRS?](#what-is-cqrs)
4. [CQRS Architecture](#cqrs-architecture)
5. [Event Sourcing + CQRS](#event-sourcing-cqrs)
6. [Event Store](#event-store)
7. [Event Replay](#event-replay)
8. [Best Practices](#best-practices)

## What is Event Sourcing?

### Definition

**Event Sourcing**: Store events, not state

**Traditional**: Store current state

**Event Sourcing**: Store events (state changes)

**Reconstruction**: Reconstruct state from events

**Benefit**: 
- **Audit Trail**: Complete audit trail
- **Time Travel**: Time travel
- **Replay**: Replay events

### Event Sourcing Example

**Traditional**:
```
Account: balance = 100
```

**Event Sourcing**:
```
Events:
- AccountCreated(accountId, initialBalance=0)
- Deposit(accountId, amount=50)
- Deposit(accountId, amount=50)
```

**State**: Reconstruct from events

## Event Sourcing Architecture

### Architecture Components

**1. Event Store**:
```
Store events
```

**2. Event Stream**:
```
Stream of events
```

**3. Aggregates**:
```
Domain aggregates
```

**4. Projections**:
```
Read models
```

### Event Flow

**Process**:
```
1. Command received
2. Load events
3. Reconstruct aggregate
4. Apply command
5. Generate events
6. Store events
7. Update projections
```

## What is CQRS?

### Definition

**CQRS**: Command Query Responsibility Segregation

**Principle**: Separate read and write

**Commands**: Mutations (writes)

**Queries**: Reads

**Benefit**: 
- **Optimization**: Optimize separately
- **Scalability**: Scale separately
- **Flexibility**: More flexibility

### CQRS Architecture

**Write Side**:
```
Commands → Command Handler → Write Model → Events
```

**Read Side**:
```
Queries → Query Handler → Read Model
```

**Separation**: Complete separation

## CQRS Architecture

### Write Model

**Write Model**: 
- **Commands**: Handle commands
- **Validation**: Validate commands
- **Business Logic**: Business logic
- **Events**: Generate events

**Optimization**: Optimized for writes

### Read Model

**Read Model**: 
- **Queries**: Handle queries
- **Projections**: Materialized views
- **Optimization**: Optimized for reads

**Optimization**: Optimized for reads

### Synchronization

**Synchronization**: 
- **Event Bus**: Event bus
- **Projections**: Update projections
- **Eventual Consistency**: Eventual consistency

**Method**: Events update read models

## Event Sourcing + CQRS

### Combined Pattern

**Event Sourcing + CQRS**: 
- **Write**: Event sourcing for writes
- **Read**: CQRS for reads
- **Sync**: Events sync read models

**Benefit**: Best of both

### Combined Architecture

**Write Side**:
```
Commands → Aggregate → Events → Event Store
```

**Read Side**:
```
Events → Projections → Read Models → Queries
```

**Sync**: Events update projections

## Event Store

### What is an Event Store?

**Event Store**: Database for events

**Features**: 
- **Append-Only**: Append-only
- **Versioning**: Event versioning
- **Streams**: Event streams
- **Replay**: Event replay

**Examples**: EventStore, Kafka, custom

### Event Store Operations

**1. Append Events**:
```
Append events to stream
```

**2. Read Events**:
```
Read events from stream
```

**3. Replay Events**:
```
Replay events
```

**4. Subscribe**:
```
Subscribe to events
```

## Event Replay

### What is Event Replay?

**Event Replay**: Replay events

**Purpose**: 
- **Reconstruction**: Reconstruct state
- **Migration**: Migrate projections
- **Debugging**: Debug issues
- **Testing**: Test scenarios

**Process**: 
```
1. Load events
2. Apply events
3. Reconstruct state
```

### Event Replay Example

**Replay**:
```
Events:
1. AccountCreated(accountId, balance=0)
2. Deposit(accountId, amount=100)
3. Withdraw(accountId, amount=30)

Replay:
State: balance = 70
```

**Use**: Reconstruct state

## Best Practices

### Practice 1: Event Design

**Events**: 
```
Design events carefully
Immutable, versioned
```

**Benefit**: Stable events

### Practice 2: Snapshot

**Snapshots**: 
```
Create snapshots
Faster reconstruction
```

**Benefit**: Performance

### Practice 3: Projections

**Projections**: 
```
Create projections for queries
Optimize read models
```

**Benefit**: Performance

### Practice 4: Event Versioning

**Versioning**: 
```
Version events
Handle migrations
```

**Benefit**: Evolution

## Real-World Examples

### Example 1: Banking System

**Use**: Banking transactions

**Pattern**: Event Sourcing + CQRS

**Events**: 
- AccountCreated
- Deposit
- Withdraw
- Transfer

**Benefit**: Complete audit trail

### Example 2: E-Commerce

**Use**: Order processing

**Pattern**: Event Sourcing + CQRS

**Events**: 
- OrderCreated
- PaymentProcessed
- OrderShipped
- OrderDelivered

**Benefit**: Order history

## Common Pitfalls

### Problem: Event Explosion

```c
// BAD: Too many events
// Storage explosion

// GOOD: Aggregate events
// Use snapshots
```

### Problem: Complex Replay

```c
// BAD: Complex replay logic
// Hard to maintain

// GOOD: Keep replay simple
// Use snapshots
```

## Quiz

1. What is Event Sourcing?
   - **A)** Store current state
   - **B)** Store state changes as events, reconstruct state from events
   - **C)** Store events only
   - **D)** Store snapshots

2. What is CQRS?
   - **A)** Combined queries
   - **B)** Command Query Responsibility Segregation - separating read and write models
   - **C)** Single model
   - **D)** No separation

3. What is event replay?
   - **A)** Delete events
   - **B)** Replaying events to reconstruct state
   - **C)** Skip events
   - **D)** Ignore events

**Answers:**
1. **B** - Event Sourcing stores all state changes as immutable events, allowing state reconstruction and time travel
2. **B** - CQRS separates command (write) and query (read) responsibilities, allowing independent optimization
3. **B** - Event replay processes events in order to reconstruct the current state or rebuild projections

## Next Steps

- [Distributed Graph Processing](./03.%20Distributed%20Graph%20Processing.md) - Graph processing
- [Blockchain Fundamentals](./04.%20Blockchain%20Fundamentals.md) - Blockchain

