---
number: 1
title: "Distributed Transactions - 2PC, 3PC, Saga"
slug: "distributed-transactions-2pc-3pc-saga"
level: "advanced"
tags: ["distributed-systems", "transactions", "2pc", "3pc", "saga"]
prerequisites: ["leader-election-algorithms"]
estimated_minutes: 150
contributors: []
diagrams: []
examples: []
canonical_id: "cs-dist-adv-01"
---

# Distributed Transactions - 2PC, 3PC, Saga

## Overview

Distributed transactions ensure atomicity across multiple nodes. Understanding Two-Phase Commit (2PC), Three-Phase Commit (3PC), Saga pattern, and their trade-offs is essential for building distributed systems with transactional guarantees.

## Table of Contents

1. [What are Distributed Transactions?](#what-are-distributed-transactions)
2. [Two-Phase Commit (2PC)](#2pc)
3. [Three-Phase Commit (3PC)](#3pc)
4. [Saga Pattern](#saga)
5. [2PC vs 3PC vs Saga](#comparison)
6. [Distributed Transaction Challenges](#challenges)
7. [Real-World Examples](#examples)
8. [Best Practices](#best-practices)

## What are Distributed Transactions?

### Definition

**Distributed Transaction**: Transaction across nodes

**Goal**: ACID across network

**Challenge**: 
- **Network**: Network failures
- **Coordination**: Coordination
- **Performance**: Performance

**Use Cases**: 
- **Distributed Databases**: Distributed databases
- **Microservices**: Microservices transactions
- **Distributed Systems**: Distributed systems

### Distributed Transaction Properties

**ACID**:
- **Atomicity**: All or nothing
- **Consistency**: Consistent state
- **Isolation**: Isolation
- **Durability**: Durability

**Challenge**: Ensure ACID across nodes

## Two-Phase Commit (2PC)

### What is 2PC?

**2PC**: Two-Phase Commit

**Phases**:
- **Phase 1 (Prepare)**: Prepare phase
- **Phase 2 (Commit/Abort)**: Commit or abort

**Coordinator**: Coordinates transaction

**Participants**: Execute transaction

### 2PC Process

**Phase 1: Prepare**:
```
1. Coordinator sends prepare to all participants
2. Participants vote (yes/no)
3. Participants write to log
4. Coordinator collects votes
```

**Phase 2: Commit/Abort**:
```
1. If all yes: Coordinator sends commit
2. If any no: Coordinator sends abort
3. Participants commit/abort
4. Participants acknowledge
```

### 2PC Problems

**1. Blocking**:
```
Blocking if coordinator fails
```

**2. Single Point of Failure**:
```
Coordinator failure
```

**3. Performance**:
```
Multiple round trips
```

**4. Network Partitions**:
```
Network partition issues
```

## Three-Phase Commit (3PC)

### What is 3PC?

**3PC**: Three-Phase Commit

**Phases**:
- **Phase 1 (CanCommit)**: Can commit?
- **Phase 2 (PreCommit)**: Pre-commit
- **Phase 3 (DoCommit)**: Do commit

**Purpose**: Reduce blocking

**Benefit**: Non-blocking (in some cases)

### 3PC Process

**Phase 1: CanCommit**:
```
1. Coordinator sends canCommit
2. Participants respond yes/no
3. Coordinator collects responses
```

**Phase 2: PreCommit**:
```
1. If all yes: Coordinator sends preCommit
2. Participants acknowledge
3. Participants ready to commit
```

**Phase 3: DoCommit**:
```
1. Coordinator sends doCommit
2. Participants commit
3. Participants acknowledge
```

### 3PC Benefits

**1. Non-Blocking**:
```
Non-blocking in some cases
```

**2. Timeout**:
```
Timeout mechanism
```

**3. Recovery**:
```
Better recovery
```

**Trade-off**: More complex

## Saga Pattern

### What is Saga?

**Saga**: Long-running transaction pattern

**Method**: 
- **Compensating Transactions**: Compensating transactions
- **No Global Locks**: No global locks
- **Eventual Consistency**: Eventual consistency

**Use**: Microservices, long transactions

### Saga Types

**1. Choreography**:
```
Participants coordinate
```

**2. Orchestration**:
```
Orchestrator coordinates
```

### Saga Example

**Order Processing**:
```
1. Create order
2. Reserve inventory
3. Charge payment
4. Ship order

If failure:
- Compensate: Cancel order
- Compensate: Release inventory
- Compensate: Refund payment
```

**Benefit**: Non-blocking

## 2PC vs 3PC vs Saga

### Comparison

| Aspect | 2PC | 3PC | Saga |
|--------|-----|-----|------|
| **Blocking** | Yes | Reduced | No |
| **Consistency** | Strong | Strong | Eventual |
| **Performance** | Medium | Slower | Fast |
| **Complexity** | Medium | High | Medium |
| **Use Case** | Short transactions | Short transactions | Long transactions |

### When to Use Each

**2PC**: 
- **Short Transactions**: Short transactions
- **Strong Consistency**: Need strong consistency
- **ACID**: Need ACID

**3PC**: 
- **Short Transactions**: Short transactions
- **Less Blocking**: Want less blocking
- **Strong Consistency**: Need strong consistency

**Saga**: 
- **Long Transactions**: Long transactions
- **Microservices**: Microservices
- **Eventual Consistency**: Accept eventual consistency

## Distributed Transaction Challenges

### Challenges

**1. Network Failures**:
```
Network partitions
```

**2. Node Failures**:
```
Node failures
```

**3. Performance**:
```
Performance overhead
```

**4. Scalability**:
```
Scalability limitations
```

### Solutions

**1. Timeouts**:
```
Use timeouts
```

**2. Retries**:
```
Retry mechanisms
```

**3. Compensations**:
```
Compensating transactions
```

**4. Eventual Consistency**:
```
Accept eventual consistency
```

## Real-World Examples

### Example 1: Distributed Database

**Use**: Distributed database transactions

**Method**: 2PC

**Benefit**: ACID across nodes

**Trade-off**: Performance overhead

### Example 2: Microservices

**Use**: Microservices transactions

**Method**: Saga

**Benefit**: Non-blocking, scalable

**Trade-off**: Eventual consistency

### Example 3: Payment Processing

**Use**: Payment processing

**Method**: Saga

**Process**: 
```
1. Authorize payment
2. Reserve inventory
3. Ship order
4. Capture payment
```

**Compensation**: Rollback on failure

## Best Practices

### Practice 1: Choose Right Pattern

**Choose**: 
```
Match pattern to use case
2PC for ACID
Saga for long transactions
```

**Benefit**: Optimal solution

### Practice 2: Handle Failures

**Failures**: 
```
Handle failures gracefully
Compensations, retries
```

**Benefit**: Resilience

### Practice 3: Minimize Scope

**Scope**: 
```
Minimize transaction scope
Reduce conflicts
```

**Benefit**: Better performance

## Common Pitfalls

### Problem: Long Transactions

```c
// BAD: Long transactions
// High blocking risk

// GOOD: Short transactions
// Or use Saga
```

### Problem: Ignoring Failures

```c
// BAD: Don't handle failures
// Data inconsistencies

// GOOD: Handle failures
// Compensations, retries
```

## Quiz

1. What is 2PC?
   - **A)** Single-phase commit
   - **B)** Two-Phase Commit protocol for distributed transactions
   - **C)** Three-phase commit
   - **D)** No commit

2. What is the Saga pattern?
   - **A)** Two-phase commit
   - **B)** Long-running transaction pattern using compensating transactions
   - **C)** Three-phase commit
   - **D)** Lock pattern

3. What is the main problem with 2PC?
   - **A)** Too fast
   - **B)** Blocking if coordinator fails
   - **C)** Too simple
   - **D)** No problems

**Answers:**
1. **B** - 2PC (Two-Phase Commit) coordinates distributed transactions through prepare and commit/abort phases
2. **B** - Saga pattern uses compensating transactions for long-running distributed transactions without global locks
3. **B** - 2PC blocks if the coordinator fails, as participants wait indefinitely for commit/abort messages

## Next Steps

- [Event Sourcing & CQRS](./02.%20Event%20Sourcing%20%26%20CQRS.md) - Event sourcing
- [Distributed Graph Processing](./03.%20Distributed%20Graph%20Processing.md) - Graph processing

