---
number: 6
title: "Zookeeper Coordination"
slug: "zookeeper-coordination"
level: "intermediate"
tags: ["backend", "zookeeper", "coordination", "distributed-systems", "kafka"]
prerequisites: ["kafka-message-streaming"]
estimated_minutes: 100
contributors: []
diagrams: []
examples: []
canonical_id: "backend-intermediate-06"
---

# Zookeeper Coordination

## Overview

Apache Zookeeper is a centralized service for maintaining configuration information, naming, providing distributed synchronization, and group services. This guide covers Zookeeper architecture, znodes, watches, leader election, configuration management, and its role in distributed systems like Kafka.

## Deep Explanation

### Core Concepts

**ZNode**: Data node in Zookeeper's hierarchical namespace
**Session**: Connection between client and server
**Watch**: Mechanism for notifications
**Ensemble**: Cluster of Zookeeper servers

### ZNode Types

**Persistent**: Exists until explicitly deleted
**Ephemeral**: Deleted when session ends
**Sequential**: Automatically numbered

### Operations

**Create**: Create a znode
**Read**: Get data and children
**Update**: Set data
**Delete**: Remove znode
**Watch**: Get notifications on changes

## Real Code Examples

### Example: Configuration Management

```python
from kazoo.client import KazooClient

zk = KazooClient(hosts='127.0.0.1:2181')
zk.start()

# Store configuration
zk.create("/config/database", b"postgresql://localhost:5432", makepath=True)

# Read configuration
data, stat = zk.get("/config/database")
print(f"Database URL: {data.decode()}")

# Watch for changes
@zk.DataWatch("/config/database")
def watch_config(data, stat):
    if data:
        print(f"Config updated: {data.decode()}")
```

### Example: Leader Election

```python
import time
from kazoo.client import KazooClient
from kazoo.recipe.election import Election

zk = KazooClient(hosts='127.0.0.1:2181')
zk.start()

election = Election(zk, "/election", "node-1")

# Try to become leader
election.run(lambda: leader_function())

def leader_function():
    print("I am the leader!")
    while True:
        # Leader work
        time.sleep(1)
```

## Hard Use-Case: Distributed Lock

### Problem Statement

Implement distributed locking using Zookeeper for coordinating access to shared resources.

### Solution

```python
from kazoo.client import KazooClient
from kazoo.recipe.lock import Lock

zk = KazooClient(hosts='127.0.0.1:2181')
zk.start()

lock = Lock(zk, "/locks/resource")

# Acquire lock
with lock:
    # Critical section
    process_resource()
    # Lock automatically released
```

## Edge Cases and Pitfalls

### Common Mistakes

1. **Session Timeout**
   - Set appropriate timeout
   - Handle session expiration
   - Reconnect on failure

2. **Watch Missed Events**
   - Watches are one-time
   - Re-register watches
   - Handle race conditions

## References and Further Reading

- Zookeeper Official Documentation
- Zookeeper Recipes and Solutions

## Quiz

### Question 1
What happens to an ephemeral znode when the client session ends?

**A)** It persists  
**B)** It is automatically deleted  
**C)** It becomes persistent  
**D)** It is archived

**Answer: B** - Ephemeral znodes are automatically deleted when the session ends.

## Related Topics

- [Kafka Message Streaming](./04.%20Kafka%20Message%20Streaming.md)
- [Distributed Systems Patterns](../04_overachiever/01.%20Distributed%20Systems%20Patterns.md)

