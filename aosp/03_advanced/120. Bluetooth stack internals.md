---
number: 120
title: Bluetooth stack internals
slug: bluetooth-stack-internals
level: advanced
tags:
  - aosp
  - framework
  - bluetooth
  - bluetooth-stack
  - ble
  - bluetooth-classic
  - bluetooth-hal
prerequisites:
  - system-server-overview
  - binder-ipc-basics
  - android-architecture-complete-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-120
---

# Bluetooth stack internals

## Overview

Bluetooth stack internals refers to the internal architecture and implementation of Android's Bluetooth stack, including the Bluetooth service, Bluetooth HAL, HCI (Host Controller Interface), Bluetooth profiles, and the communication flow between framework and hardware. Understanding Bluetooth stack internals is essential for AOSP development, as it explains how Bluetooth is initialized, how Bluetooth operations are handled, how the stack communicates with hardware, how Bluetooth profiles work, and how the Bluetooth framework operates. This guide provides a comprehensive overview of Bluetooth stack internals, architecture, Bluetooth service, Bluetooth HAL, HCI layer, profile management, and debugging.

Think of Bluetooth stack internals like a communication protocol stack: just as a protocol stack has multiple layers (application, transport, network, link, physical), the Bluetooth stack has multiple layers (application/framework, Bluetooth service, HCI, HAL, hardware), each handling different aspects of Bluetooth communication.

## Deep Explanation

### What is Bluetooth Stack Internals?

Bluetooth stack internals refers to the internal architecture and implementation of Android's Bluetooth stack, including the Bluetooth service, Bluetooth HAL, HCI layer, profile management, and the communication flow between the Android framework and Bluetooth hardware.

**Key Characteristics:**
- **Multi-Layer Architecture:** Multiple layers handle different aspects
- **Service-Based:** Bluetooth service manages operations
- **HAL Abstraction:** HAL abstracts hardware differences
- **HCI Communication:** HCI layer communicates with hardware
- **Profile Support:** Supports multiple Bluetooth profiles

**Why Bluetooth Stack Internals?**
- **Hardware Abstraction:** Abstracts hardware complexity
- **Profile Management:** Manages Bluetooth profiles
- **State Management:** Manages Bluetooth state
- **Communication Flow:** Handles communication with hardware

### Bluetooth Stack Architecture

#### Stack Layers

**Bluetooth Stack Layers:**
```
Application Layer
    ↓
Framework Layer (BluetoothManager, BluetoothAdapter)
    ↓
Bluetooth Service (BluetoothService)
    ↓
Bluetooth HAL (BluetoothHciHal)
    ↓
HCI Layer (Host Controller Interface)
    ↓
Bluetooth Hardware (Controller)
```

**Layer Responsibilities:**
- **Application Layer:** Apps use Bluetooth APIs
- **Framework Layer:** Provides Bluetooth APIs to apps
- **Bluetooth Service:** Manages Bluetooth operations
- **Bluetooth HAL:** Abstracts hardware interface
- **HCI Layer:** Standard Bluetooth interface
- **Hardware:** Bluetooth controller chip

#### Service Location

**Bluetooth Service Location:**
- Runs in `system_server` process (or separate process)
- Part of SystemServer
- Started during boot
- Registered with ServiceManager

**Service Registration:**
```java
// In SystemServer
BluetoothService bluetoothService = new BluetoothService(...);
ServiceManager.addService(Context.BLUETOOTH_SERVICE, bluetoothService);
```

**Access from Apps:**
```java
// Apps access via BluetoothManager
BluetoothManager bm = (BluetoothManager) context.getSystemService(
    Context.BLUETOOTH_SERVICE);
BluetoothAdapter adapter = bm.getAdapter();
```

### Bluetooth Service

#### BluetoothService Responsibilities

**BluetoothService Responsibilities:**
- Manage Bluetooth adapter state
- Handle Bluetooth operations
- Manage Bluetooth devices
- Coordinate with Bluetooth HAL
- Manage Bluetooth profiles

**Service Operations:**
- Enable/disable Bluetooth
- Discover devices
- Pair/unpair devices
- Connect/disconnect devices
- Manage profiles

#### Bluetooth State Management

**Bluetooth States:**
- **STATE_OFF:** Bluetooth off
- **STATE_TURNING_ON:** Bluetooth turning on
- **STATE_ON:** Bluetooth on
- **STATE_TURNING_OFF:** Bluetooth turning off

**State Management:**
```java
// Bluetooth state
enum BluetoothState {
    STATE_OFF,
    STATE_TURNING_ON,
    STATE_ON,
    STATE_TURNING_OFF
}

// Track Bluetooth state
void trackBluetoothState(BluetoothState state) {
    mBluetoothState = state;
    notifyBluetoothStateChange(state);
}
```

#### Device Management

**Device Management:**
- Discover devices
- Pair devices
- Track device state
- Manage device connections

**Device Operations:**
```java
// Device management
class BluetoothDeviceManager {
    private Map<String, BluetoothDevice> mDevices = new HashMap<>();
    
    void addDevice(BluetoothDevice device) {
        mDevices.put(device.getAddress(), device);
        notifyDeviceAdded(device);
    }
    
    void removeDevice(BluetoothDevice device) {
        mDevices.remove(device.getAddress());
        notifyDeviceRemoved(device);
    }
    
    BluetoothDevice getDevice(String address) {
        return mDevices.get(address);
    }
}
```

### Bluetooth HAL

#### HAL Overview

**Bluetooth HAL:**
- Hardware Abstraction Layer for Bluetooth
- Abstracts hardware differences
- Provides standard interface
- Communicates with HCI layer

**HAL Responsibilities:**
- Initialize Bluetooth hardware
- Send HCI commands
- Receive HCI events
- Handle ACL/SCO data
- Manage hardware state

#### HAL Interface

**HAL Interface:**
```aidl
// Bluetooth HAL interface
interface IBluetoothHci {
    Return<void> initialize(in IBluetoothHciCallbacks callback);
    Return<void> sendHciCommand(in byte[] command);
    Return<void> sendAclData(in byte[] data);
    Return<void> sendScoData(in byte[] data);
    Return<void> close();
}

interface IBluetoothHciCallbacks {
    oneway void hciEventReceived(in byte[] event);
    oneway void aclDataReceived(in byte[] data);
    oneway void scoDataReceived(in byte[] data);
}
```

#### HAL Implementation

**HAL Implementation:**
```cpp
// Bluetooth HAL implementation
class BluetoothHciHal : public BnBluetoothHci {
public:
    ::ndk::ScopedAStatus initialize(
            const std::shared_ptr<IBluetoothHciCallbacks>& callback) override;
    ::ndk::ScopedAStatus sendHciCommand(
            const std::vector<uint8_t>& command) override;
    ::ndk::ScopedAStatus sendAclData(
            const std::vector<uint8_t>& data) override;
    ::ndk::ScopedAStatus sendScoData(
            const std::vector<uint8_t>& data) override;
    ::ndk::ScopedAStatus close() override;

private:
    std::shared_ptr<IBluetoothHciCallbacks> mCallback;
    int mBtFd;
    
    void processHciEvents();
    void handleHciEvent(const uint8_t* event, size_t length);
};
```

### HCI Layer

#### HCI Overview

**HCI (Host Controller Interface):**
- Standard Bluetooth interface
- Command/event protocol
- ACL (Asynchronous Connection-Less) data
- SCO (Synchronous Connection-Oriented) data

**HCI Responsibilities:**
- Send commands to controller
- Receive events from controller
- Handle ACL data
- Handle SCO data

#### HCI Commands

**HCI Commands:**
- **Link Control:** Connection management
- **Link Policy:** Connection policy
- **Controller & Baseband:** Controller configuration
- **Informational:** Query information
- **Status:** Status parameters

**HCI Command Example:**
```cpp
// HCI command structure
struct HciCommand {
    uint8_t opcode[2];  // Opcode (OGF + OCF)
    uint8_t length;     // Parameter length
    uint8_t parameters[]; // Parameters
};

// Example: Reset command
uint8_t resetCommand[] = {0x03, 0x0C, 0x00}; // OGF=0, OCF=0x0C
sendHciCommand(resetCommand, sizeof(resetCommand));
```

#### HCI Events

**HCI Events:**
- **Command Complete:** Command completed
- **Command Status:** Command status
- **Connection Events:** Connection state changes
- **Inquiry Events:** Device discovery
- **Data Events:** ACL/SCO data

**HCI Event Handling:**
```cpp
// HCI event handling
void handleHciEvent(const uint8_t* event, size_t length) {
    uint8_t eventCode = event[0];
    
    switch (eventCode) {
        case HCI_EVENT_COMMAND_COMPLETE:
            handleCommandComplete(event, length);
            break;
        case HCI_EVENT_CONNECTION_COMPLETE:
            handleConnectionComplete(event, length);
            break;
        // ... other events
    }
}
```

### Bluetooth Profiles

#### Profile Overview

**Bluetooth Profiles:**
- Define Bluetooth functionality
- Standardize Bluetooth features
- Enable interoperability
- Support different use cases

**Common Profiles:**
- **A2DP:** Advanced Audio Distribution Profile (audio streaming)
- **HFP:** Hands-Free Profile (phone calls)
- **HSP:** Headset Profile (headset)
- **AVRCP:** Audio/Video Remote Control Profile (media control)
- **GATT:** Generic Attribute Profile (BLE)

#### Profile Management

**Profile Management:**
- Register profiles
- Manage profile connections
- Handle profile events
- Coordinate profile state

**Profile Registration:**
```java
// Profile registration
class BluetoothProfileManager {
    private Map<Integer, BluetoothProfile> mProfiles = new HashMap<>();
    
    void registerProfile(int profileId, BluetoothProfile profile) {
        mProfiles.put(profileId, profile);
    }
    
    BluetoothProfile getProfile(int profileId) {
        return mProfiles.get(profileId);
    }
}
```

### Bluetooth Classic

#### Classic Overview

**Bluetooth Classic:**
- Traditional Bluetooth
- Higher bandwidth
- Connection-oriented
- RFCOMM sockets

**Classic Characteristics:**
- **RFCOMM:** Serial port emulation
- **SDP:** Service Discovery Protocol
- **L2CAP:** Logical Link Control and Adaptation Protocol
- **ACL:** Asynchronous Connection-Less links

#### Classic Operations

**Classic Operations:**
- Device discovery
- Pairing
- RFCOMM connection
- Data transfer
- Disconnection

**Classic Connection Flow:**
```
1. Discover device
2. Pair device
3. Create RFCOMM socket
4. Connect socket
5. Transfer data
6. Close socket
```

### Bluetooth Low Energy (BLE)

#### BLE Overview

**Bluetooth Low Energy (BLE):**
- Low power Bluetooth
- Attribute-based
- GATT protocol
- Connection intervals

**BLE Characteristics:**
- **GATT:** Generic Attribute Profile
- **Services:** Collections of characteristics
- **Characteristics:** Data values
- **Descriptors:** Metadata

#### BLE Operations

**BLE Operations:**
- Scan for devices
- Connect to device
- Discover services
- Read/write characteristics
- Subscribe to notifications

**BLE Connection Flow:**
```
1. Scan for BLE devices
2. Connect to device
3. Discover services
4. Read/write characteristics
5. Subscribe to notifications
6. Disconnect
```

### Bluetooth Communication Flow

#### Command Flow

**Command Flow:**
```
App → Framework → BluetoothService → BluetoothHAL → HCI → Hardware
```

**Command Example:**
```java
// App requests Bluetooth operation
adapter.enable();

// Framework calls BluetoothService
bluetoothService.enable();

// BluetoothService calls HAL
hal.sendHciCommand(enableCommand);

// HAL sends to hardware
// Hardware responds with event
```

#### Event Flow

**Event Flow:**
```
Hardware → HCI → BluetoothHAL → BluetoothService → Framework → App
```

**Event Example:**
```cpp
// Hardware sends event
void onHciEventReceived(const uint8_t* event, size_t length) {
    // HAL receives event
    mCallback->hciEventReceived(event, length);
    
    // BluetoothService processes event
    // Framework notifies app
}
```

### Bluetooth Security

#### Pairing

**Pairing:**
- Establish secure connection
- Exchange keys
- Store pairing information
- Enable encrypted communication

**Pairing Process:**
```
1. Initiate pairing
2. Exchange pairing information
3. Authenticate
4. Exchange keys
5. Store pairing
6. Establish encrypted link
```

#### Encryption

**Encryption:**
- Encrypt data transmission
- Use pairing keys
- Secure communication
- Protect data privacy

### Debugging Bluetooth Stack

#### Service Dumps

**Dump Bluetooth Service State:**
```bash
# Dump Bluetooth service state
adb shell dumpsys bluetooth_manager

# Dump Bluetooth adapter state
adb shell dumpsys bluetooth_manager | grep Adapter

# Dump connected devices
adb shell dumpsys bluetooth_manager | grep Device
```

#### Bluetooth Logs

**Bluetooth Service Logs:**
```bash
# Bluetooth service logs
adb logcat | grep BluetoothService

# Bluetooth HAL logs
adb logcat | grep BluetoothHci

# HCI logs
adb logcat | grep HCI
```

#### HCI Sniffing

**HCI Sniffing:**
```bash
# Enable HCI logging
adb shell setprop bluetooth.hci.log true

# View HCI logs
adb logcat | grep HCI
```

#### Common Issues

**Common Issues:**
- Bluetooth not enabling
- Devices not discovering
- Pairing failures
- Connection issues
- Profile not working

**Debugging Steps:**
1. Check Bluetooth service logs
2. Verify Bluetooth state
3. Check HAL communication
4. Review HCI logs
5. Check hardware state

## Key Takeaways

1. **Bluetooth stack internals** refers to the internal architecture and implementation of Android's Bluetooth stack, including Bluetooth service, HAL, HCI layer, and profile management.

2. **Bluetooth stack architecture** includes stack layers (Application, Framework, Service, HAL, HCI, Hardware), layer responsibilities (each layer handles different aspects), and service location (runs in system_server or separate process).

3. **Bluetooth service** includes responsibilities (manage adapter state, handle operations, manage devices), state management (STATE_OFF, TURNING_ON, ON, TURNING_OFF), and device management (discover, pair, track state).

4. **Bluetooth HAL** includes HAL overview (hardware abstraction layer, abstracts hardware differences), HAL interface (IBluetoothHci interface, callbacks), and HAL implementation (initialize, send commands, receive events).

5. **HCI layer** includes HCI overview (standard Bluetooth interface, command/event protocol), HCI commands (link control, link policy, controller configuration), and HCI events (command complete, connection events, data events).

6. **Bluetooth profiles** include profile overview (define functionality, standardize features), common profiles (A2DP, HFP, HSP, AVRCP, GATT), and profile management (register profiles, manage connections, handle events).

7. **Bluetooth Classic** includes classic overview (traditional Bluetooth, higher bandwidth, connection-oriented), classic operations (discovery, pairing, RFCOMM connection), and classic connection flow (discover, pair, connect, transfer, disconnect).

8. **Bluetooth Low Energy (BLE)** includes BLE overview (low power, attribute-based, GATT protocol), BLE operations (scan, connect, discover services, read/write characteristics), and BLE connection flow (scan, connect, discover, read/write, subscribe, disconnect).

9. **Bluetooth communication flow** includes command flow (App → Framework → Service → HAL → HCI → Hardware), event flow (Hardware → HCI → HAL → Service → Framework → App), and communication examples.

10. **Understanding Bluetooth stack internals** is essential for AOSP development, enabling Bluetooth hardware abstraction, profile management, state management, and efficient Bluetooth communication.

## Related Topics

- **System Server Overview:** How system services are organized
- **Hardware Abstraction Layer (HAL):** HAL architecture
- **Binder IPC Basics:** How Bluetooth service communicates
- **Service lifecycle:** How services go through lifecycle phases

