---
number: 142
title: rollback index
slug: rollback-index
level: advanced
tags:
  - aosp
  - security
  - verified-boot
  - rollback-index
  - rollback-protection
  - avb
  - version-protection
prerequisites:
  - verified-boot-avb
  - boot-verification-flow
  - android-verified-boot-2-0-avb
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-142
---

# rollback index

## Overview

Rollback index is a security mechanism in Android Verified Boot (AVB) that prevents version downgrade attacks by tracking the version of each partition and ensuring that only newer or equal versions can be installed. The rollback index is a monotonically increasing value stored per partition that is compared against a stored value during boot verification. Understanding rollback index is essential for AOSP development, as it explains how rollback protection works, how rollback indexes prevent downgrades, how rollback indexes are managed, how rollback indexes are stored, and how rollback protection maintains security. This guide provides a comprehensive overview of rollback index, rollback protection concept, rollback index management, rollback index storage, and rollback protection mechanisms.

Think of rollback index like a version number that only goes forward: just as a building's security system might track which version of access cards are valid (preventing use of older, revoked cards), rollback index tracks which version of partitions are valid, preventing installation of older, potentially vulnerable versions.

## Deep Explanation

### What is Rollback Index?

Rollback index is a security mechanism in Android Verified Boot (AVB) that prevents version downgrade attacks by tracking the version of each partition and ensuring that only newer or equal versions can be installed. The rollback index is a monotonically increasing value stored per partition that is compared against a stored value during boot verification.

**Key Characteristics:**
- **Monotonic:** Only increases, never decreases
- **Per-Partition:** Each partition has own index
- **Version Tracking:** Tracks partition version
- **Downgrade Prevention:** Prevents version downgrades
- **Security:** Critical for security updates

**Why Rollback Index?**
- **Security:** Prevents downgrade attacks
- **Updates:** Ensures security updates are applied
- **Version Control:** Tracks partition versions
- **Protection:** Protects against rollback attacks

### Rollback Protection Concept

#### Downgrade Attack Prevention

**Downgrade Attack Prevention:**
- Prevents installing older versions
- Older versions may have vulnerabilities
- Attackers might try to downgrade
- Rollback index prevents this

**Attack Scenario:**
```
1. Device running Android 12 (index 5)
2. Security vulnerability found
3. Security patch released (index 6)
4. Attacker tries to install Android 11 (index 3)
5. Rollback protection: Rejects (3 < 5)
6. Device remains secure
```

#### Version Tracking

**Version Tracking:**
- Each partition version tracked
- Index increments with each update
- Stored value tracks current version
- New versions must have higher index

**Tracking Mechanism:**
- **Per-Partition:** Each partition tracked separately
- **Monotonic:** Index only increases
- **Stored Value:** Stored securely
- **Comparison:** Compared during verification

### Rollback Index Verification

#### Verification Process

**Verification Process:**
```
1. Partition has rollback index N
2. Stored rollback index is M
3. If N >= M: Accept (newer or same)
4. If N < M: Reject (older version)
5. If accepted: Update stored index to N
```

**Verification Steps:**
- **Read Index:** Read rollback index from partition
- **Read Stored:** Read stored rollback index
- **Compare:** Compare partition index with stored index
- **Decision:** Accept if partition index >= stored index
- **Update:** Update stored index if accepted

#### Verification Example

**Verification Example:**
```
Current stored rollback index: 5
New partition rollback index: 6
Comparison: 6 >= 5
Result: Accept (newer version)

Current stored rollback index: 5
New partition rollback index: 3
Comparison: 3 < 5
Result: Reject (downgrade attempt)
```

### Rollback Index Storage

#### Secure Hardware Storage

**Secure Hardware Storage (Preferred):**
- Stored in secure element
- Tamper-resistant
- Cannot be modified by software
- Best security

**Secure Storage Characteristics:**
- **Hardware-Based:** Stored in secure hardware
- **Tamper-Resistant:** Resistant to tampering
- **Software-Protected:** Cannot be modified by software
- **High Security:** Best security option

#### Persistent Storage

**Persistent Storage (Fallback):**
- Stored in dedicated partition
- Protected by filesystem
- Can be updated securely
- Fallback option

**Persistent Storage Characteristics:**
- **Partition-Based:** Stored in dedicated partition
- **Filesystem-Protected:** Protected by filesystem
- **Updateable:** Can be updated securely
- **Fallback:** Fallback when secure hardware unavailable

#### Storage Location

**Storage Location:**
- Varies by device
- Usually in `misc` partition
- Or in secure hardware
- Device-specific

**Location Examples:**
- `/misc` partition
- Secure element
- Trusted Execution Environment (TEE)
- Device-specific location

### Rollback Index Management

#### Index Incrementing

**Index Incrementing:**
- Index incremented with each update
- Incremented per partition
- Monotonic increase
- Never decreases

**Incrementing Process:**
```
1. Current index: N
2. New update: N+1
3. Update partition with new index
4. After successful boot: Update stored index to N+1
```

**Incrementing Example:**
```bash
# Current index: 5
# Build new image with index 6
avbtool add_hash_footer \
    --image system.img \
    --partition_name system \
    --rollback_index 6

# After successful boot, stored index updated to 6
```

#### Index Checking

**Index Checking:**
- Bootloader checks index during boot
- Compares partition index with stored index
- Accepts if partition index >= stored index
- Rejects if partition index < stored index

**Checking Process:**
```
1. Bootloader loads partition
2. Bootloader reads partition rollback index
3. Bootloader reads stored rollback index
4. Bootloader compares indexes
5. If partition index >= stored index: Accept
6. If partition index < stored index: Reject
```

### Rollback Index in AVB

#### AVB Footer Integration

**AVB Footer Integration:**
- Rollback index stored in AVB footer
- Part of AVB metadata
- Verified with AVB footer
- Protected by AVB signature

**Integration Details:**
- **AVB Footer:** Rollback index in AVB footer
- **Metadata:** Part of AVB metadata
- **Verification:** Verified with AVB footer
- **Protection:** Protected by AVB signature

#### Per-Partition Index

**Per-Partition Index:**
- Each partition has own rollback index
- Independent tracking per partition
- Allows different versions per partition
- Flexible version management

**Per-Partition Characteristics:**
- **Independent:** Each partition independent
- **Separate Tracking:** Separate tracking per partition
- **Flexible:** Flexible version management
- **Granular:** Granular version control

### Rollback Protection with A/B Partitions

#### A/B Partition Support

**A/B Partition Support:**
- Each slot has own rollback index
- Independent tracking per slot
- Allows different versions per slot
- Seamless updates

**A/B Characteristics:**
- **Per-Slot:** Each slot has own index
- **Independent:** Independent tracking
- **Flexible:** Flexible version management
- **Seamless:** Seamless updates

#### Update Process

**Update Process:**
```
1. Device on slot A (index 5)
2. Update installs to slot B (index 6)
3. Slot B verified (index 6 >= 5) âœ“
4. Device reboots to slot B
5. Slot B becomes active
6. Rollback index updated to 6
```

**Update Characteristics:**
- **Dual Slot:** Both slots protected
- **Independent:** Independent verification
- **Seamless:** Seamless update process
- **Protected:** Both slots protected

### Rollback Index Best Practices

#### Best Practices

**Best Practices:**
- Always increment index with updates
- Store index securely
- Enforce rollback checks
- Test rollback scenarios

**Practice Guidelines:**
- **Increment:** Always increment with updates
- **Secure Storage:** Store index securely
- **Enforcement:** Enforce rollback checks
- **Testing:** Test rollback scenarios

### Rollback Index Management Tools

#### avbtool

**avbtool:**
- Tool for managing rollback indexes
- Add rollback index to images
- View rollback index in images
- Manage AVB metadata

**Tool Usage:**
```bash
# Add rollback index to image
avbtool add_hash_footer \
    --image boot.img \
    --partition_name boot \
    --rollback_index 6

# View rollback index
avbtool info_image --image boot.img
```

### Debugging Rollback Index

#### Debugging Tools

**Debugging Tools:**
- `avbtool` - View rollback index
- Boot logs - Check verification
- Fastboot commands - Check status
- Verification logs

**Debugging Commands:**
```bash
# View rollback index in image
avbtool info_image --image system.img

# Check AVB status
fastboot getvar vbmeta

# View boot logs
adb shell dmesg | grep rollback
```

#### Common Issues

**Common Issues:**
- Rollback index mismatches
- Index not incremented
- Index not updated
- Verification failures

**Debugging Steps:**
1. Check rollback index in image
2. Check stored rollback index
3. Verify index comparison
4. Review boot logs
5. Verify index update

## Key Takeaways

1. **Rollback index** is a security mechanism in Android Verified Boot (AVB) that prevents version downgrade attacks by tracking the version of each partition and ensuring that only newer or equal versions can be installed.

2. **Rollback protection concept** includes downgrade attack prevention (prevents installing older versions, older versions may have vulnerabilities, attackers might try to downgrade), version tracking (each partition version tracked, index increments with each update, stored value tracks current version), and tracking mechanism.

3. **Rollback index verification** includes verification process (read index from partition, read stored index, compare indexes, accept if partition index >= stored index), verification steps, verification example, and verification characteristics.

4. **Rollback index storage** includes secure hardware storage (stored in secure element, tamper-resistant, cannot be modified by software, best security), persistent storage (stored in dedicated partition, protected by filesystem, can be updated securely, fallback option), storage location (varies by device, usually in misc partition, or in secure hardware), and storage characteristics.

5. **Rollback index management** includes index incrementing (index incremented with each update, incremented per partition, monotonic increase), index checking (bootloader checks index during boot, compares partition index with stored index, accepts if partition index >= stored index), incrementing process, and checking process.

6. **Rollback index in AVB** includes AVB footer integration (rollback index stored in AVB footer, part of AVB metadata, verified with AVB footer), per-partition index (each partition has own rollback index, independent tracking per partition, allows different versions per partition), and integration details.

7. **Rollback protection with A/B partitions** includes A/B partition support (each slot has own rollback index, independent tracking per slot, allows different versions per slot), update process (device on slot A, update installs to slot B, slot B verified, device reboots to slot B), and A/B characteristics.

8. **Rollback index best practices** include best practices (always increment index with updates, store index securely, enforce rollback checks, test rollback scenarios), practice guidelines, and management practices.

9. **Understanding rollback index** is essential for AOSP development, enabling rollback protection, version control, security update enforcement, and proper rollback index management.

## Related Topics

- **Verified Boot (AVB):** Verified boot details
- **Boot verification flow:** Boot verification process
- **dm-verity:** Device mapper verity
- **Android Verified Boot 2.0 (AVB):** AVB 2.0 details

