---
number: 150
title: systrace & perfetto
slug: systrace-perfetto
level: advanced
tags:
  - aosp
  - debugging
  - systrace
  - perfetto
  - tracing
  - performance-profiling
  - system-tracing
prerequisites:
  - android-architecture-complete-overview
  - system-server-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-150
---

# systrace & perfetto

## Overview

systrace and perfetto are system tracing tools that capture low-level system events, CPU scheduling, kernel events, and application behavior to provide detailed performance analysis and debugging capabilities. systrace is the legacy tracing tool, while perfetto is the modern replacement with improved performance, better UI, and more event types. Understanding systrace and perfetto is essential for AOSP development, as it explains how to record system traces, how to analyze trace files, how to identify performance bottlenecks, how to debug frame drops, and how system tracing provides system-level visibility. This guide provides a comprehensive overview of systrace and perfetto, trace recording, trace analysis, performance debugging, and tracing best practices.

Think of systrace and perfetto like a high-speed camera for system execution: just as a high-speed camera can capture detailed frames of fast-moving events (ball movement, water droplets, mechanical motion), systrace and perfetto can capture detailed frames of system execution (CPU scheduling, thread execution, system calls, frame rendering), allowing you to analyze what happened at a microscopic level.

## Deep Explanation

### What are systrace and perfetto?

systrace and perfetto are system tracing tools that capture low-level system events, CPU scheduling, kernel events, and application behavior to provide detailed performance analysis and debugging capabilities. These tools provide visibility into system-level execution that is not available through high-level profilers.

**Key Characteristics:**
- **Low-Level:** Captures low-level system events
- **Detailed:** Detailed execution information
- **Performance:** Performance analysis
- **Debugging:** System-level debugging
- **Visualization:** Visual trace analysis

**Why systrace and perfetto?**
- **Performance Analysis:** Analyze system performance
- **Bottleneck Identification:** Identify performance bottlenecks
- **Frame Drop Debugging:** Debug frame drops
- **System Visibility:** System-level visibility

### systrace Overview

#### What is systrace?

**systrace:**
- Legacy tracing tool
- Text-based trace files
- HTML visualization
- Good for quick analysis
- Still useful for specific cases

**systrace Characteristics:**
- **Legacy:** Legacy tool (being phased out)
- **Text-Based:** Text-based trace files
- **HTML Visualization:** HTML visualization
- **Quick Analysis:** Good for quick analysis

#### systrace Usage

**Basic systrace Usage:**
```bash
# Basic trace (10 seconds)
python systrace.py -t 10 -o trace.html

# Trace specific categories
python systrace.py -t 10 -o trace.html sched freq idle am wm gfx view binder_driver

# Trace specific app
python systrace.py -t 10 -o trace.html -a com.example.app

# List available categories
python systrace.py --list-categories
```

**Common Categories:**
- **sched:** CPU scheduling
- **freq:** CPU frequency scaling
- **idle:** CPU idle states
- **am:** Activity Manager
- **wm:** Window Manager
- **gfx:** Graphics (most important for UI)
- **view:** View system
- **binder_driver:** Inter-process communication
- **hal:** Hardware Abstraction Layer
- **art:** ART runtime
- **input:** Touch/input events

### perfetto Overview

#### What is perfetto?

**perfetto:**
- Modern tracing system
- Replaces systrace
- Web-based UI
- Rich visualization
- Better performance
- More event types

**perfetto Characteristics:**
- **Modern:** Modern tracing system
- **Web-Based:** Web-based UI
- **Rich Events:** More event types
- **Better Performance:** Lower overhead
- **Recommended:** Recommended tool

#### perfetto Usage

**Method 1: Android Studio**
```
1. View → Tool Windows → Profiler
2. Click "+" → Select device
3. Click "System Trace" button
4. Click "Record"
5. Perform operation
6. Click "Stop"
7. Trace opens in Perfetto UI
```

**Method 2: Command Line**
```bash
# Record trace
adb shell perfetto -t 10s -o /data/misc/perfetto-traces/trace.pb \
  -c - --txt \
  -s sched freq idle am wm gfx view binder_driver hal art input

# Pull trace
adb pull /data/misc/perfetto-traces/trace.pb

# Open in Perfetto UI
# Visit https://ui.perfetto.dev
# Upload trace.pb
```

**Method 3: Perfetto Config File**
```bash
# Create config file
cat > config.pbtxt << EOF
buffers: {
    size_kb: 63488
    fill_policy: DISCARD
}
data_sources: {
    config {
        name: "linux.ftrace"
        ftrace_config {
            ftrace_events: "sched/sched_switch"
            ftrace_events: "sched/sched_wakeup"
            ftrace_events: "power/cpu_frequency"
        }
    }
}
EOF

# Record with config
adb shell perfetto -c config.pbtxt -o /data/misc/perfetto-traces/trace.pb
```

### Trace Analysis

#### Understanding Trace Files

**Trace File Structure:**
- Timeline view
- CPU cores
- Threads
- Events
- Metrics

**Trace Visualization:**
- **Timeline:** Horizontal timeline
- **CPU Cores:** One row per CPU core
- **Threads:** Thread execution bars
- **Events:** Event markers
- **Metrics:** Performance metrics

#### Thread States

**Thread States:**
- **Running (Green):** Thread is executing on CPU
- **Runnable (Blue):** Ready to run, waiting for CPU
- **Sleeping (Purple):** Blocked (I/O, locks, etc.)
- **Uninterruptible Sleep (Red):** Kernel blocking

**State Interpretation:**
- **Green:** Thread actively executing
- **Blue:** Thread ready but waiting for CPU
- **Purple:** Thread blocked, not executing
- **Red:** Thread blocked in kernel

#### CPU Scheduling Analysis

**CPU Scheduling:**
- Which threads run on which CPUs
- Thread migration between CPUs
- CPU frequency scaling
- CPU idle states

**Scheduling Insights:**
- **Thread Distribution:** How threads are distributed across CPUs
- **Migration:** Thread migration patterns
- **Frequency:** CPU frequency changes
- **Idle Time:** CPU idle time

### Performance Debugging

#### Finding Frame Drops

**Frame Drop Indicators:**
- Main thread bars longer than 16ms (60fps)
- Gaps in RenderThread
- VSync lines without corresponding frames
- "Choreographer#doFrame" taking >16ms

**Frame Drop Analysis:**
```
Look for:
1. Main thread execution > 16ms
2. RenderThread gaps
3. Missing frames at VSync
4. Long-running operations on main thread
```

#### Finding CPU Bottlenecks

**CPU Bottleneck Indicators:**
- Threads running for long periods
- CPU frequency scaling down
- Threads waiting for CPU (runnable state)
- CPU cores staying idle when work exists

**Bottleneck Analysis:**
```
Look for:
1. Long-running threads
2. CPU frequency drops
3. Runnable threads waiting
4. Underutilized CPUs
```

#### Finding I/O Bottlenecks

**I/O Bottleneck Indicators:**
- Long purple (sleeping) periods
- I/O wait events
- Disk read/write operations
- Network operations

**I/O Analysis:**
```
Look for:
1. Long sleeping periods
2. I/O wait events
3. Disk operations
4. Network latency
```

### Trace Categories

#### CPU Categories

**CPU Categories:**
- **sched:** CPU scheduling events
- **freq:** CPU frequency scaling
- **idle:** CPU idle states
- **cpu:** CPU-specific events

#### Graphics Categories

**Graphics Categories:**
- **gfx:** Graphics rendering
- **view:** View system
- **wm:** Window Manager
- **input:** Input events

#### System Categories

**System Categories:**
- **am:** Activity Manager
- **wm:** Window Manager
- **binder_driver:** Binder IPC
- **hal:** Hardware Abstraction Layer
- **art:** ART runtime

### Tracing Best Practices

#### Best Practices

**Best Practices:**
- Use perfetto (modern tool)
- Enable relevant categories
- Keep trace duration reasonable
- Analyze systematically
- Compare before/after traces

**Practice Guidelines:**
- **Tool Choice:** Use perfetto for new traces
- **Categories:** Enable only needed categories
- **Duration:** Keep traces short (10-30 seconds)
- **Analysis:** Analyze systematically
- **Comparison:** Compare before/after traces

### Advanced Techniques

#### Custom Events

**Custom Events:**
- Add custom trace events
- Application-specific events
- Performance markers
- Debug markers

**Custom Event Example:**
```java
// In application code
Trace.beginSection("my_operation");
// ... operation code ...
Trace.endSection();
```

#### Trace Filtering

**Trace Filtering:**
- Filter by process
- Filter by thread
- Filter by time range
- Focus on specific areas

**Filtering in Perfetto UI:**
- Use search box
- Select time range
- Filter by process/thread
- Focus on specific events

### Debugging with Traces

#### Common Debugging Scenarios

**Scenario 1: Frame Drops**
```bash
# Record trace during UI interaction
adb shell perfetto -t 10s -o /data/misc/perfetto-traces/trace.pb \
  -c - --txt -s gfx view sched

# Analyze in Perfetto UI
# Look for main thread > 16ms
# Check RenderThread gaps
```

**Scenario 2: ANR Issues**
```bash
# Record trace during ANR
adb shell perfetto -t 30s -o /data/misc/perfetto-traces/trace.pb \
  -c - --txt -s sched am binder_driver

# Analyze in Perfetto UI
# Look for blocked main thread
# Check binder transactions
```

**Scenario 3: Performance Issues**
```bash
# Record trace during performance issue
adb shell perfetto -t 20s -o /data/misc/perfetto-traces/trace.pb \
  -c - --txt -s sched freq idle

# Analyze in Perfetto UI
# Look for CPU bottlenecks
# Check frequency scaling
```

## Key Takeaways

1. **systrace and perfetto** are system tracing tools that capture low-level system events, CPU scheduling, kernel events, and application behavior to provide detailed performance analysis and debugging capabilities.

2. **systrace overview** includes what is systrace (legacy tracing tool, text-based trace files, HTML visualization), systrace usage (basic usage, common categories, trace commands), and systrace characteristics.

3. **perfetto overview** includes what is perfetto (modern tracing system, replaces systrace, web-based UI, rich visualization), perfetto usage (Android Studio method, command line method, config file method), and perfetto characteristics.

4. **Trace analysis** includes understanding trace files (trace file structure, trace visualization), thread states (running, runnable, sleeping, uninterruptible sleep), CPU scheduling analysis (thread distribution, migration, frequency, idle time), and analysis techniques.

5. **Performance debugging** includes finding frame drops (frame drop indicators, frame drop analysis), finding CPU bottlenecks (CPU bottleneck indicators, bottleneck analysis), finding I/O bottlenecks (I/O bottleneck indicators, I/O analysis), and debugging techniques.

6. **Trace categories** include CPU categories (sched, freq, idle, cpu), graphics categories (gfx, view, wm, input), system categories (am, wm, binder_driver, hal, art), and category usage.

7. **Tracing best practices** include best practices (use perfetto, enable relevant categories, keep trace duration reasonable, analyze systematically, compare before/after traces), practice guidelines, and implementation practices.

8. **Advanced techniques** include custom events (add custom trace events, application-specific events), trace filtering (filter by process, filter by thread, filter by time range), and advanced usage.

9. **Understanding systrace and perfetto** is essential for AOSP development, enabling performance analysis, bottleneck identification, frame drop debugging, and proper system tracing usage.

## Related Topics

- **ftrace:** Kernel function tracing
- **atrace:** Application tracing
- **binder tracing:** Binder IPC tracing

