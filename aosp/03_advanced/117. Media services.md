---
number: 117
title: Media services
slug: media-services
level: advanced
tags:
  - aosp
  - framework
  - media
  - media-services
  - audio
  - video
  - media-framework
prerequisites:
  - system-server-overview
  - binder-ipc-basics
  - android-architecture-complete-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-117
---

# Media services

## Overview

Media services are system services responsible for managing audio, video, and media playback in Android, including audio playback, video playback, media codec management, media session management, and media routing. Understanding media services is essential for AOSP development, as it explains how audio and video are played, how media codecs are managed, how media sessions work, how media routing is handled, and how the media framework operates. This guide provides a comprehensive overview of media services, architecture, audio services, video services, media codec services, media session management, and debugging.

Think of media services like a media center: just as a media center manages audio playback (audio services), video playback (video services), media codecs (codec management), and media routing (audio routing), media services manage audio/video playback, codec management, media sessions, and media routing in Android.

## Deep Explanation

### What are Media Services?

Media services are system services responsible for managing audio, video, and media playback in Android, including audio playback, video playback, media codec management, media session management, and media routing. Media services run in separate processes and coordinate with the media framework to provide media functionality.

**Key Characteristics:**
- **Audio Services:** Manage audio playback
- **Video Services:** Manage video playback
- **Codec Services:** Manage media codecs
- **Session Management:** Manage media sessions
- **Media Routing:** Route media to devices

**Why Media Services?**
- **Media Functionality:** Enable audio/video playback
- **Codec Management:** Manage media codecs
- **Session Management:** Coordinate media sessions
- **Device Routing:** Route media to appropriate devices

### Media Services Architecture

#### Service Organization

**Media Services:**
- **AudioService:** Audio playback and routing
- **MediaCodecService:** Media codec management
- **MediaSessionService:** Media session management
- **AudioPolicyService:** Audio policy management

**Service Location:**
- Some services in SystemServer
- Some services in separate processes
- Native services (AudioPolicyService)
- Java services (MediaSessionService)

#### Service Processes

**Service Processes:**
```
SystemServer Process:
├── MediaSessionService
└── (Other media-related services)

audioserver Process:
├── AudioPolicyService
└── AudioFlinger

mediaserver Process:
└── MediaCodecService (if separate)
```

### Audio Services

#### AudioService

**AudioService:**
- Manages audio playback
- Handles audio routing
- Manages audio streams
- Coordinates with AudioPolicyService

**AudioService Responsibilities:**
- Audio stream management
- Audio device routing
- Audio volume control
- Audio focus management

**AudioService Location:**
- Runs in SystemServer
- Part of SystemServer
- Registered with ServiceManager

#### AudioPolicyService

**AudioPolicyService:**
- Manages audio policy
- Handles audio routing decisions
- Manages audio devices
- Coordinates audio streams

**AudioPolicyService Responsibilities:**
- Audio routing decisions
- Audio device management
- Audio policy enforcement
- Audio stream coordination

**AudioPolicyService Location:**
- Runs in `audioserver` process
- Native C++ service
- Started by init
- Registered with ServiceManager

#### AudioFlinger

**AudioFlinger:**
- Low-level audio playback
- Audio hardware interface
- Audio mixing
- Audio effects

**AudioFlinger Responsibilities:**
- Audio hardware control
- Audio mixing
- Audio effects processing
- Audio buffer management

**AudioFlinger Location:**
- Runs in `audioserver` process
- Native C++ service
- Part of AudioPolicyService process

### Video Services

#### MediaCodecService

**MediaCodecService:**
- Manages media codecs
- Codec allocation
- Codec lifecycle
- Codec resource management

**MediaCodecService Responsibilities:**
- Codec discovery
- Codec allocation
- Codec lifecycle management
- Codec resource management

**MediaCodecService Location:**
- May run in SystemServer or separate process
- Registered with ServiceManager

#### Video Playback

**Video Playback:**
- MediaPlayer service
- Video codec management
- Video surface management
- Video synchronization

**Video Playback Flow:**
```
1. App requests video playback
2. MediaPlayer service created
3. MediaCodec allocated
4. Video decoded
5. Video rendered to surface
6. Audio synchronized
```

### Media Codec Management

#### Codec Discovery

**Codec Discovery:**
- Discover available codecs
- Query codec capabilities
- Match codec to format
- Allocate codec

**Codec Discovery Process:**
```java
// Codec discovery
MediaCodecList codecList = new MediaCodecList(MediaCodecList.REGULAR_CODECS);
MediaCodecInfo[] codecs = codecList.getCodecInfos();

// Find codec for format
String codecName = codecList.findDecoderForFormat(format);
```

#### Codec Allocation

**Codec Allocation:**
- Allocate codec instance
- Configure codec
- Start codec
- Manage codec lifecycle

**Codec Allocation Process:**
```java
// Allocate codec
MediaCodec codec = MediaCodec.createByCodecName(codecName);

// Configure codec
codec.configure(format, surface, null, 0);

// Start codec
codec.start();
```

#### Codec Lifecycle

**Codec Lifecycle:**
- **Allocated:** Codec allocated
- **Configured:** Codec configured
- **Started:** Codec started
- **Running:** Codec processing
- **Stopped:** Codec stopped
- **Released:** Codec released

**Lifecycle Management:**
```java
// Codec lifecycle
codec.start();        // Start
// ... process frames ...
codec.stop();        // Stop
codec.release();     // Release
```

### Media Session Management

#### MediaSessionService

**MediaSessionService:**
- Manages media sessions
- Session lifecycle
- Session coordination
- Media button handling

**MediaSessionService Responsibilities:**
- Create media sessions
- Manage session lifecycle
- Coordinate sessions
- Handle media buttons

**MediaSessionService Location:**
- Runs in SystemServer
- Part of SystemServer
- Registered with ServiceManager

#### Media Session

**Media Session:**
- Represents media playback session
- Tracks playback state
- Handles media controls
- Manages metadata

**Media Session Characteristics:**
- Playback state
- Media metadata
- Media controls
- Session ID

**Media Session Example:**
```java
// Create media session
MediaSession session = new MediaSession(context, "MySession");

// Set playback state
session.setPlaybackState(new PlaybackState.Builder()
    .setState(PlaybackState.STATE_PLAYING, position, 1.0f)
    .build());

// Set metadata
session.setMetadata(new MediaMetadata.Builder()
    .putString(MediaMetadata.METADATA_KEY_TITLE, "Song Title")
    .build());
```

#### Session Coordination

**Session Coordination:**
- Multiple sessions
- Active session management
- Session priority
- Session focus

**Coordination Process:**
```
1. App creates media session
2. Session registered with MediaSessionService
3. MediaSessionService manages sessions
4. Active session receives media buttons
5. Session focus managed
```

### Audio Routing

#### Audio Device Management

**Audio Device Management:**
- Discover audio devices
- Manage device connections
- Route audio to devices
- Handle device changes

**Device Types:**
- **Speaker:** Built-in speaker
- **Headphone:** Wired headphones
- **Bluetooth:** Bluetooth audio
- **USB:** USB audio
- **HDMI:** HDMI audio

#### Audio Routing

**Audio Routing:**
- Route audio to device
- Handle routing changes
- Manage routing policies
- Coordinate with AudioPolicyService

**Routing Process:**
```
1. Audio device connected
2. AudioPolicyService notified
3. Routing decision made
4. Audio routed to device
5. App notified of routing change
```

### Media Framework Integration

#### Media Framework

**Media Framework:**
- MediaPlayer API
- MediaCodec API
- AudioManager API
- MediaSession API

**Framework Integration:**
- Apps use framework APIs
- Framework calls media services
- Services handle operations
- Results returned to apps

#### Service Coordination

**Service Coordination:**
- Media services coordinate
- Audio and video synchronized
- Codec resources shared
- Session management coordinated

**Coordination Example:**
```
App → MediaPlayer → MediaCodecService → Codec
                → AudioService → AudioPolicyService → AudioFlinger
                → MediaSessionService → Session Management
```

### Performance Optimization

#### Codec Resource Management

**Resource Management:**
- Codec pool management
- Codec reuse
- Resource allocation
- Resource cleanup

**Resource Optimization:**
- Reuse codecs when possible
- Efficient codec allocation
- Proper resource cleanup
- Memory management

#### Audio Performance

**Audio Performance:**
- Low-latency audio
- Audio buffer management
- Audio thread optimization
- Audio effect optimization

**Performance Techniques:**
- Minimize audio latency
- Optimize buffer sizes
- Efficient audio processing
- Hardware acceleration

### Debugging Media Services

#### Service Dumps

**Dump Service State:**
```bash
# Dump audio service
adb shell dumpsys audio

# Dump media session service
adb shell dumpsys media_session

# Dump media codec service
adb shell dumpsys media.codec_list
```

#### Logging

**Media Service Logs:**
```bash
# Audio service logs
adb logcat | grep AudioService

# Media codec logs
adb logcat | grep MediaCodec

# Media session logs
adb logcat | grep MediaSession
```

#### Common Issues

**Common Issues:**
- Audio not playing
- Video not playing
- Codec allocation failures
- Routing issues

**Debugging Steps:**
1. Check service state
2. Verify codec availability
3. Check audio routing
4. Review service logs
5. Check permissions

## Key Takeaways

1. **Media services** are system services managing audio, video, and media playback, including audio services, video services, codec management, and media session management.

2. **Media services architecture** includes service organization (AudioService, MediaCodecService, MediaSessionService, AudioPolicyService), service processes (SystemServer, audioserver, mediaserver), and service coordination.

3. **Audio services** include AudioService (manages audio playback, routing, streams), AudioPolicyService (manages audio policy, routing decisions), and AudioFlinger (low-level audio playback, hardware interface).

4. **Video services** include MediaCodecService (manages media codecs, codec allocation), video playback (MediaPlayer service, video codec management), and video surface management.

5. **Media codec management** includes codec discovery (discover available codecs, query capabilities), codec allocation (allocate codec, configure, start), and codec lifecycle (allocated, configured, started, running, stopped, released).

6. **Media session management** includes MediaSessionService (manages media sessions, session lifecycle), media session (represents playback session, tracks state), and session coordination (multiple sessions, active session management).

7. **Audio routing** includes audio device management (discover devices, manage connections), audio routing (route audio to devices, handle routing changes), and routing coordination (with AudioPolicyService).

8. **Media framework integration** includes media framework (MediaPlayer, MediaCodec, AudioManager, MediaSession APIs), framework integration (apps use framework APIs, framework calls services), and service coordination (services coordinate, audio/video synchronized).

9. **Performance optimization** includes codec resource management (codec pool, codec reuse), audio performance (low-latency, buffer management), and performance techniques (minimize latency, optimize buffers).

10. **Understanding media services** is essential for AOSP development, enabling audio/video playback, codec management, media session management, and media routing.

## Related Topics

- **System Server Overview:** How system services are organized
- **Audio HAL architecture:** Audio hardware abstraction
- **Binder IPC Basics:** How media services communicate
- **Service lifecycle:** How services go through lifecycle phases

