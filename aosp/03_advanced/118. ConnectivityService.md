---
number: 118
title: ConnectivityService
slug: connectivityservice
level: advanced
tags:
  - aosp
  - framework
  - connectivity
  - network
  - wifi
  - cellular
  - network-management
prerequisites:
  - system-server-overview
  - binder-ipc-basics
  - android-architecture-complete-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-118
---

# ConnectivityService

## Overview

ConnectivityService is a core system service responsible for managing network connectivity in Android, including Wi-Fi, cellular, Ethernet, and other network types. ConnectivityService coordinates network interfaces, manages network state, handles network requests, and provides network information to applications. Understanding ConnectivityService is essential for AOSP development, as it explains how network connectivity is managed, how network requests are handled, how network state is tracked, how network policies are enforced, and how the network framework operates. This guide provides a comprehensive overview of ConnectivityService, architecture, network management, network requests, network state tracking, network policies, and debugging.

Think of ConnectivityService like a network traffic controller: just as a traffic controller manages multiple roads (network interfaces), coordinates traffic flow (network requests), monitors road conditions (network state), and enforces traffic rules (network policies), ConnectivityService manages network interfaces, coordinates network requests, monitors network state, and enforces network policies.

## Deep Explanation

### What is ConnectivityService?

ConnectivityService is a core system service running in the SystemServer process that manages network connectivity in Android, including Wi-Fi, cellular, Ethernet, Bluetooth tethering, and other network types. ConnectivityService coordinates with network managers, tracks network state, handles network requests, and enforces network policies.

**Key Characteristics:**
- **Network Management:** Manages all network types
- **State Tracking:** Tracks network connectivity state
- **Request Handling:** Handles network requests from apps
- **Policy Enforcement:** Enforces network policies
- **Coordination:** Coordinates with network managers

**Why ConnectivityService?**
- **Centralized Management:** Single point for network management
- **State Coordination:** Coordinates network state across system
- **Request Handling:** Handles network requests efficiently
- **Policy Enforcement:** Enforces network policies consistently

### ConnectivityService Architecture

#### Service Location

**ConnectivityService Location:**
- Runs in `system_server` process
- Part of SystemServer
- Started early in boot sequence
- Registered with ServiceManager

**Service Registration:**
```java
// In SystemServer
ConnectivityService connectivityService = new ConnectivityService(...);
ServiceManager.addService(Context.CONNECTIVITY_SERVICE, connectivityService);
```

**Access from Apps:**
```java
// Apps access via ConnectivityManager
ConnectivityManager cm = (ConnectivityManager) context.getSystemService(
    Context.CONNECTIVITY_SERVICE);
```

#### Internal Components

**ConnectivityService Components:**
- **NetworkFactory:** Creates network connections
- **NetworkAgent:** Represents network connection
- **NetworkRequest:** Represents network request
- **NetworkStateTracker:** Tracks network state
- **NetworkPolicyManager:** Manages network policies

### Network Management

#### Network Types

**Network Types:**
- **Wi-Fi:** Wireless local area network
- **Cellular:** Mobile data network
- **Ethernet:** Wired network
- **Bluetooth:** Bluetooth tethering
- **VPN:** Virtual private network
- **Wi-Fi Direct:** Direct Wi-Fi connection

**Network Type Management:**
```java
// Network types
public static final int TYPE_WIFI = ConnectivityManager.TYPE_WIFI;
public static final int TYPE_MOBILE = ConnectivityManager.TYPE_MOBILE;
public static final int TYPE_ETHERNET = ConnectivityManager.TYPE_ETHERNET;
public static final int TYPE_BLUETOOTH = ConnectivityManager.TYPE_BLUETOOTH;
public static final int TYPE_VPN = ConnectivityManager.TYPE_VPN;
```

#### Network Interfaces

**Network Interface Management:**
- Discover network interfaces
- Manage interface state
- Handle interface changes
- Coordinate interface usage

**Interface Management:**
```java
// Network interface management
void ConnectivityService::manageNetworkInterface(NetworkInterface iface) {
    // Manage interface
    iface.setUp();
    // Track interface state
    trackInterfaceState(iface);
}
```

### Network Requests

#### Network Request Concept

**Network Request:**
- App requests specific network
- Specifies network requirements
- Network capabilities
- Network callbacks

**Network Request Characteristics:**
- **Capabilities:** Required network capabilities
- **Transport:** Preferred transport type
- **Bandwidth:** Required bandwidth
- **Callbacks:** Network state callbacks

#### Creating Network Requests

**Network Request Creation:**
```java
// Create network request
NetworkRequest request = new NetworkRequest.Builder()
    .addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET)
    .addTransportType(NetworkCapabilities.TRANSPORT_WIFI)
    .build();

// Register network callback
ConnectivityManager.NetworkCallback callback = 
    new ConnectivityManager.NetworkCallback() {
        @Override
        public void onAvailable(Network network) {
            // Network available
        }
        
        @Override
        public void onLost(Network network) {
            // Network lost
        }
    };

// Register request
connectivityManager.requestNetwork(request, callback);
```

#### Network Request Handling

**Request Handling Process:**
```
1. App creates network request
2. ConnectivityService receives request
3. ConnectivityService evaluates request
4. ConnectivityService matches request to network
5. ConnectivityService notifies app of network
6. App uses network
```

**Request Evaluation:**
- Check network capabilities
- Match request to available networks
- Select best network
- Notify app of network

### Network State Tracking

#### Network State

**Network State:**
- **CONNECTING:** Network connecting
- **CONNECTED:** Network connected
- **DISCONNECTING:** Network disconnecting
- **DISCONNECTED:** Network disconnected
- **SUSPENDED:** Network suspended

**State Tracking:**
```java
// Network state
enum NetworkState {
    CONNECTING,
    CONNECTED,
    DISCONNECTING,
    DISCONNECTED,
    SUSPENDED
}

// Track network state
void trackNetworkState(Network network, NetworkState state) {
    mNetworkStates.put(network, state);
    notifyNetworkStateChange(network, state);
}
```

#### Active Network

**Active Network:**
- Currently active network
- Used for default network operations
- May change based on priority
- Apps can query active network

**Active Network Management:**
```java
// Get active network
Network activeNetwork = connectivityManager.getActiveNetwork();

// Get network capabilities
NetworkCapabilities capabilities = 
    connectivityManager.getNetworkCapabilities(activeNetwork);

// Check if network has internet
boolean hasInternet = capabilities.hasCapability(
    NetworkCapabilities.NET_CAPABILITY_INTERNET);
```

### Network Capabilities

#### Network Capabilities

**Network Capabilities:**
- **INTERNET:** Internet connectivity
- **VALIDATED:** Network validated
- **NOT_METERED:** Not metered network
- **NOT_ROAMING:** Not roaming
- **NOT_VPN:** Not VPN network

**Capability Management:**
```java
// Network capabilities
NetworkCapabilities capabilities = new NetworkCapabilities();
capabilities.addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET);
capabilities.addCapability(NetworkCapabilities.NET_CAPABILITY_VALIDATED);
capabilities.addTransportType(NetworkCapabilities.TRANSPORT_WIFI);
```

#### Capability Validation

**Capability Validation:**
- Validate network capabilities
- Check network connectivity
- Verify network functionality
- Update capability state

**Validation Process:**
```
1. Network connects
2. ConnectivityService validates network
3. ConnectivityService checks internet connectivity
4. ConnectivityService updates capabilities
5. ConnectivityService notifies apps
```

### Network Policies

#### Network Policy Management

**Network Policy:**
- Rules for network usage
- Data usage limits
- Network restrictions
- Policy enforcement

**Policy Types:**
- **Data Usage Limits:** Limit data usage
- **Network Restrictions:** Restrict network access
- **Background Restrictions:** Restrict background usage
- **Roaming Policies:** Roaming restrictions

#### Policy Enforcement

**Policy Enforcement:**
- Enforce network policies
- Monitor network usage
- Apply restrictions
- Notify apps of restrictions

**Enforcement Process:**
```java
// Enforce network policy
void enforceNetworkPolicy(Network network, NetworkPolicy policy) {
    // Check policy
    if (policy.isRestricted(network)) {
        // Apply restriction
        restrictNetwork(network);
        // Notify apps
        notifyNetworkRestricted(network);
    }
}
```

### Network Callbacks

#### Network Callback Types

**Network Callback Types:**
- **onAvailable:** Network available
- **onLost:** Network lost
- **onCapabilitiesChanged:** Capabilities changed
- **onLinkPropertiesChanged:** Link properties changed
- **onBlockedStatusChanged:** Blocked status changed

**Callback Implementation:**
```java
// Network callback
ConnectivityManager.NetworkCallback callback = 
    new ConnectivityManager.NetworkCallback() {
        @Override
        public void onAvailable(Network network) {
            // Network available
            Log.d(TAG, "Network available: " + network);
        }
        
        @Override
        public void onLost(Network network) {
            // Network lost
            Log.d(TAG, "Network lost: " + network);
        }
        
        @Override
        public void onCapabilitiesChanged(Network network, 
                                         NetworkCapabilities capabilities) {
            // Capabilities changed
            Log.d(TAG, "Capabilities changed: " + capabilities);
        }
    };
```

### Network Coordination

#### Coordination with Network Managers

**Network Manager Coordination:**
- Wi-Fi Manager
- Telephony Manager
- Ethernet Manager
- VPN Manager

**Coordination Process:**
```
1. Network manager detects network change
2. Network manager notifies ConnectivityService
3. ConnectivityService updates network state
4. ConnectivityService notifies apps
```

#### Network Priority

**Network Priority:**
- Networks have priority
- Higher priority networks preferred
- Priority determines active network
- Priority can change

**Priority Management:**
```java
// Network priority
int getNetworkPriority(Network network) {
    // Calculate priority
    // Wi-Fi typically higher than cellular
    // Ethernet typically highest
    return priority;
}
```

### Network Validation

#### Network Validation

**Network Validation:**
- Validate network connectivity
- Check internet connectivity
- Verify network functionality
- Update validation state

**Validation Process:**
```
1. Network connects
2. ConnectivityService validates network
3. ConnectivityService checks internet
4. ConnectivityService updates validation state
5. ConnectivityService notifies apps
```

**Validation Implementation:**
```java
// Validate network
void validateNetwork(Network network) {
    // Check internet connectivity
    boolean hasInternet = checkInternetConnectivity(network);
    
    // Update capabilities
    NetworkCapabilities capabilities = getNetworkCapabilities(network);
    if (hasInternet) {
        capabilities.addCapability(
            NetworkCapabilities.NET_CAPABILITY_VALIDATED);
    }
    
    // Notify apps
    notifyCapabilitiesChanged(network, capabilities);
}
```

### Debugging ConnectivityService

#### Service Dumps

**Dump ConnectivityService State:**
```bash
# Dump connectivity service state
adb shell dumpsys connectivity

# Dump network information
adb shell dumpsys connectivity | grep Network

# Dump network requests
adb shell dumpsys connectivity | grep Request
```

#### Network Monitoring

**Network Monitoring:**
```bash
# Monitor network state
adb shell dumpsys connectivity

# Check active network
adb shell dumpsys connectivity | grep "Active network"

# Check network interfaces
adb shell ip addr show
```

#### Common Issues

**Common Issues:**
- Network not connecting
- Network requests not working
- Network state not updating
- Policy enforcement issues

**Debugging Steps:**
1. Check ConnectivityService logs
2. Verify network state
3. Check network requests
4. Review network policies
5. Check network manager coordination

## Key Takeaways

1. **ConnectivityService** is a core system service managing network connectivity, including Wi-Fi, cellular, Ethernet, and other network types.

2. **ConnectivityService architecture** includes service location (runs in system_server), internal components (NetworkFactory, NetworkAgent, NetworkRequest, NetworkStateTracker), and service registration.

3. **Network management** includes network types (Wi-Fi, cellular, Ethernet, Bluetooth, VPN), network interface management (discover, manage, handle changes), and network coordination.

4. **Network requests** include network request concept (app requests specific network), creating network requests (specify capabilities, transport, callbacks), and request handling (evaluate, match, notify).

5. **Network state tracking** includes network state (CONNECTING, CONNECTED, DISCONNECTING, DISCONNECTED, SUSPENDED), active network (currently active network, used for default operations), and state management (track state, notify changes).

6. **Network capabilities** include network capabilities (INTERNET, VALIDATED, NOT_METERED, etc.), capability management (add/remove capabilities), and capability validation (validate network, update capabilities).

7. **Network policies** include network policy management (rules for network usage), policy enforcement (enforce policies, apply restrictions), and policy types (data limits, restrictions, roaming policies).

8. **Network callbacks** include callback types (onAvailable, onLost, onCapabilitiesChanged, etc.), callback implementation (handle network state changes), and callback registration (register for network events).

9. **Network coordination** includes coordination with network managers (Wi-Fi, Telephony, Ethernet, VPN), network priority (networks have priority, determines active network), and coordination process (managers notify ConnectivityService).

10. **Understanding ConnectivityService** is essential for AOSP development, enabling network management, network request handling, network state tracking, and network policy enforcement.

## Related Topics

- **System Server Overview:** How system services are organized
- **Binder IPC Basics:** How ConnectivityService communicates
- **Service lifecycle:** How services go through lifecycle phases
- **Network Management:** Network management concepts

