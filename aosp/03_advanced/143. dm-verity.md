---
number: 143
title: dm-verity
slug: dm-verity
level: advanced
tags:
  - aosp
  - security
  - dm-verity
  - device-mapper-verity
  - runtime-verification
  - hash-tree
  - partition-verification
prerequisites:
  - verified-boot-avb
  - boot-verification-flow
  - rollback-index
  - android-partitions
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-143
---

# dm-verity

## Overview

dm-verity (Device Mapper Verity) is a Linux kernel feature that provides transparent block-level integrity verification of read-only partitions using a Merkle hash tree. dm-verity enables runtime verification of partition integrity, detecting any modifications to partition blocks and preventing access to corrupted or tampered data. Understanding dm-verity is essential for AOSP development, as it explains how runtime partition verification works, how hash trees enable block-level verification, how dm-verity integrates with AVB, how verification failures are handled, and how dm-verity provides security. This guide provides a comprehensive overview of dm-verity, hash tree structure, verification process, integration with AVB, and dm-verity management.

Think of dm-verity like a security scanner: just as a security scanner checks items as they pass through (block-by-block verification), dm-verity checks partition blocks as they are read (block-by-block verification), ensuring that each block is authentic and unmodified.

## Deep Explanation

### What is dm-verity?

dm-verity (Device Mapper Verity) is a Linux kernel feature that provides transparent block-level integrity verification of read-only partitions using a Merkle hash tree. dm-verity enables runtime verification of partition integrity, detecting any modifications to partition blocks and preventing access to corrupted or tampered data.

**Key Characteristics:**
- **Block-Level:** Verifies individual blocks
- **Transparent:** Transparent to applications
- **Runtime:** Verification at runtime
- **Hash Tree:** Uses Merkle hash tree
- **Read-Only:** Protects read-only partitions

**Why dm-verity?**
- **Security:** Detects tampering
- **Integrity:** Ensures partition integrity
- **Runtime:** Runtime verification
- **Transparent:** Transparent to applications

### Hash Tree Structure

#### Merkle Tree Concept

**Merkle Tree:**
- Tree structure of hashes
- Each node is hash of children
- Root hash represents entire tree
- Enables efficient block verification

**Tree Structure:**
```
Root Hash
├── Hash(Block 0-1)
│   ├── Hash(Block 0)
│   └── Hash(Block 1)
├── Hash(Block 2-3)
│   ├── Hash(Block 2)
│   └── Hash(Block 3)
└── ...
```

**Tree Characteristics:**
- **Hierarchical:** Hierarchical hash structure
- **Efficient:** Efficient block verification
- **Verifiable:** Verifiable root hash
- **Scalable:** Scales to large partitions

#### Hash Tree Construction

**Hash Tree Construction:**
- Calculate hash of each data block
- Combine block hashes into tree nodes
- Calculate hash of tree nodes
- Build tree up to root hash

**Construction Process:**
```
1. Calculate hash of each data block
2. Combine block hashes (2 blocks per node)
3. Calculate hash of combined hashes
4. Repeat until root hash
5. Store hash tree in partition
```

### dm-verity Setup

#### Setup Process

**Setup Process:**
- Kernel sets up dm-verity device
- Hash tree loaded from partition
- Root hash verified
- Device mapper created

**Setup Steps:**
```
1. Kernel mounts partition
2. Kernel reads hash tree from partition
3. Kernel verifies root hash
4. Kernel creates dm-verity device
5. dm-verity device ready for use
```

#### dm-verity Table

**dm-verity Table:**
- Configuration for dm-verity device
- Specifies data device and hash device
- Specifies hash algorithm and block size
- Specifies root hash

**Table Format:**
```
<version> <data_dev> <hash_dev> <data_block_size> <hash_block_size> <num_data_blocks> <hash_start_block> <algorithm> <digest> <salt>
```

**Table Example:**
```
1 /dev/block/sda1 /dev/block/sda1 4096 4096 32768 1 sha256 <root_hash> <salt>
```

### Verification Process

#### Block Verification

**Block Verification:**
- When block is read, verify its hash
- Compare with hash in tree
- If valid: Return block data
- If invalid: Return I/O error

**Verification Steps:**
```
1. Application reads block
2. dm-verity intercepts read
3. dm-verity calculates block hash
4. dm-verity looks up hash in tree
5. dm-verity compares hashes
6. If match: Return block data
7. If mismatch: Return I/O error
```

#### Hash Tree Verification

**Hash Tree Verification:**
- Verify hash tree integrity
- Verify root hash
- Verify tree structure
- Ensure tree is valid

**Tree Verification:**
- **Root Hash:** Verify root hash matches
- **Tree Structure:** Verify tree structure
- **Tree Integrity:** Verify tree integrity
- **Tree Validity:** Ensure tree is valid

### dm-verity Integration

#### AVB Integration

**AVB Integration:**
- dm-verity works with AVB
- AVB hashtree descriptor provides root hash
- Kernel sets up dm-verity with root hash
- Runtime verification enabled

**Integration Process:**
```
1. Bootloader verifies AVB footer
2. Bootloader extracts hashtree descriptor
3. Bootloader passes root hash to kernel
4. Kernel sets up dm-verity with root hash
5. Runtime verification active
```

#### Partition Integration

**Partition Integration:**
- dm-verity protects read-only partitions
- System partition protected
- Vendor partition protected
- Product partition protected

**Protected Partitions:**
- **System:** System partition
- **Vendor:** Vendor partition
- **Product:** Product partition
- **Read-Only:** Read-only partitions

### Hash Tree Storage

#### Tree Location

**Tree Location:**
- Hash tree stored in partition
- Appended to data blocks
- Separate hash device (optional)
- Tree size depends on partition size

**Storage Characteristics:**
- **In Partition:** Stored in same partition
- **Appended:** Appended to data blocks
- **Separate Device:** Can use separate device
- **Size:** Tree size depends on data size

#### Tree Size Calculation

**Tree Size Calculation:**
- Tree size depends on data size
- Block size affects tree size
- Tree grows logarithmically
- Typical overhead: 1-2% of data size

**Size Characteristics:**
- **Data-Dependent:** Depends on data size
- **Block-Size Dependent:** Depends on block size
- **Logarithmic Growth:** Grows logarithmically
- **Low Overhead:** Low storage overhead

### Verification Modes

#### Enforcing Mode

**Enforcing Mode:**
- Verification enforced
- I/O errors on verification failure
- Production mode
- Maximum security

**Mode Characteristics:**
- **Enforced:** Verification enforced
- **Fail-Safe:** I/O errors on failure
- **Production:** Production mode
- **Security:** Maximum security

#### Restart Mode

**Restart Mode:**
- Device restarts on verification failure
- More aggressive than enforcing
- Prevents continued operation
- Maximum protection

**Mode Characteristics:**
- **Restart:** Device restarts on failure
- **Aggressive:** More aggressive protection
- **Prevention:** Prevents continued operation
- **Protection:** Maximum protection

### dm-verity Benefits

#### Security Benefits

**Security Benefits:**
- Detects any modification
- Prevents rootkits
- Ensures system integrity
- Protects read-only partitions

**Security Features:**
- **Tamper Detection:** Detects tampering
- **Rootkit Prevention:** Prevents rootkits
- **Integrity:** Ensures integrity
- **Protection:** Protects partitions

#### Performance Benefits

**Performance Benefits:**
- Transparent to applications
- No performance impact for reads
- Efficient hash tree verification
- Minimal overhead

**Performance Characteristics:**
- **Transparent:** Transparent to applications
- **Efficient:** Efficient verification
- **Low Overhead:** Minimal overhead
- **Fast:** Fast verification

### dm-verity Management

#### Status Checking

**Status Checking:**
- Check dm-verity device status
- View verification statistics
- Monitor verification failures
- Debug verification issues

**Status Commands:**
```bash
# Check dm-verity status
adb shell dmsetup status system

# View verification statistics
adb shell dmesg | grep dm-verity

# Check device mapper
adb shell ls -l /dev/mapper/
```

#### Troubleshooting

**Troubleshooting:**
- Check hash tree integrity
- Verify root hash
- Check block verification
- Review verification logs

**Troubleshooting Steps:**
1. Check dm-verity status
2. Review verification logs
3. Verify hash tree integrity
4. Check root hash
5. Verify block verification

### Debugging dm-verity

#### Debugging Tools

**Debugging Tools:**
- `dmsetup` - Device mapper management
- `dmesg` - Kernel messages
- Verification logs
- Status commands

**Debugging Commands:**
```bash
# View dm-verity status
adb shell dmsetup status system

# View kernel messages
adb shell dmesg | grep dm-verity

# Check device mapper table
adb shell dmsetup table system
```

#### Common Issues

**Common Issues:**
- Verification failures
- Hash tree corruption
- Root hash mismatches
- Block verification failures

**Debugging Steps:**
1. Check dm-verity status
2. Review verification logs
3. Verify hash tree integrity
4. Check root hash
5. Verify AVB integration

## Key Takeaways

1. **dm-verity** is a Linux kernel feature that provides transparent block-level integrity verification of read-only partitions using a Merkle hash tree.

2. **Hash tree structure** includes Merkle tree concept (tree structure of hashes, each node is hash of children, root hash represents entire tree), hash tree construction (calculate hash of each data block, combine block hashes into tree nodes, build tree up to root hash), and tree characteristics.

3. **dm-verity setup** includes setup process (kernel sets up dm-verity device, hash tree loaded from partition, root hash verified, device mapper created), dm-verity table (configuration for dm-verity device, specifies data device and hash device, specifies hash algorithm and block size), and setup steps.

4. **Verification process** includes block verification (when block is read, verify its hash, compare with hash in tree, if valid return block data, if invalid return I/O error), hash tree verification (verify hash tree integrity, verify root hash, verify tree structure), and verification steps.

5. **dm-verity integration** includes AVB integration (dm-verity works with AVB, AVB hashtree descriptor provides root hash, kernel sets up dm-verity with root hash), partition integration (dm-verity protects read-only partitions, system/vendor/product partitions protected), and integration process.

6. **Hash tree storage** includes tree location (hash tree stored in partition, appended to data blocks, separate hash device optional), tree size calculation (tree size depends on data size, block size affects tree size, tree grows logarithmically, typical overhead 1-2%), and storage characteristics.

7. **Verification modes** include enforcing mode (verification enforced, I/O errors on verification failure, production mode), restart mode (device restarts on verification failure, more aggressive protection), and mode characteristics.

8. **dm-verity benefits** include security benefits (detects any modification, prevents rootkits, ensures system integrity), performance benefits (transparent to applications, no performance impact for reads, efficient hash tree verification), and benefit characteristics.

9. **Understanding dm-verity** is essential for AOSP development, enabling runtime partition verification, tamper detection, system integrity, and proper dm-verity implementation.

## Related Topics

- **Verified Boot (AVB):** Verified boot details
- **Boot verification flow:** Boot verification process
- **rollback index:** Rollback index details
- **Android Partitions:** Partition details

