---
number: 171
title: APEX package structure
slug: apex-package-structure
level: advanced
tags:
  - aosp
  - apex
  - package-structure
  - mainline
  - modules
prerequisites:
  - mainline-modules-apex-apks-in-system
  - modular-system-components
  - android-architecture-complete-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-171
---

# APEX package structure

## Overview

APEX package structure refers to the internal organization and format of APEX (Android Pony EXpress) packages, which are the package format used for updatable system components in Android. Understanding APEX package structure is essential for AOSP development, as it explains how APEX packages are organized, what components they contain, how they're structured, how they're mounted, and how they integrate with the Android system. This guide provides a comprehensive overview of APEX package structure, package components, file organization, manifest structure, mounting mechanism, and package format details.

Think of APEX package structure like a container format: just as a shipping container has a specific structure (container walls, doors, internal organization, labels, and manifest), an APEX package has a specific structure (package format, mountable image, manifest files, metadata) that defines how system components are packaged, verified, and mounted in the Android system.

## Deep Explanation

### What is APEX Package Structure?

APEX package structure refers to the internal organization and format of APEX packages, which are the package format used for updatable system components in Android. APEX packages contain system components that can be updated independently.

**Key Characteristics:**
- **Package Format:** Standardized package format
- **Mountable Image:** Contains mountable filesystem image
- **Manifest Files:** Contains manifest and metadata
- **Versioned:** Versioned packages
- **Verified:** Verified before installation

**Why APEX Package Structure?**
- **Packaging:** Standardized component packaging
- **Updates:** Enable component updates
- **Mounting:** Mount-based activation
- **Verification:** Package verification support

### APEX Package Format

#### Package File Structure

**APEX Package:**
```
com.android.media.apex
├── apex_payload.img    - Mountable filesystem image
├── apex_manifest.pb    - Protobuf manifest
├── AndroidManifest.xml - APK-style manifest
└── META-INF/           - Signing metadata
    ├── MANIFEST.MF
    ├── CERT.SF
    └── CERT.RSA
```

**Package Components:**
- **apex_payload.img:** Mountable filesystem image
- **apex_manifest.pb:** Package manifest (protobuf)
- **AndroidManifest.xml:** APK-style manifest
- **META-INF/:** Signing metadata

#### Package File Types

**File Types:**
- **apex_payload.img:** Ext4 filesystem image
- **apex_manifest.pb:** Protobuf manifest
- **AndroidManifest.xml:** XML manifest
- **META-INF/:** Signing files

**File Characteristics:**
- Mountable image format
- Protobuf binary format
- XML text format
- JAR signing format

### apex_payload.img

#### Image Structure

**apex_payload.img:**
- Ext4 filesystem image
- Contains module files
- Mountable at runtime
- Read-only filesystem

**Image Contents:**
```
apex_payload.img (ext4 filesystem)
├── lib/              - Native libraries
│   ├── arm64/       - 64-bit ARM libraries
│   └── arm/         - 32-bit ARM libraries
├── bin/              - Native binaries
├── etc/              - Configuration files
└── ...               - Other module files
```

**Image Characteristics:**
- Ext4 filesystem format
- Read-only filesystem
- Mounted at `/apex/<module-name>/`
- Contains module components

#### Image Creation

**Image Creation Process:**
```
1. Prepare module files
2. Create ext4 filesystem
3. Copy files to filesystem
4. Create sparse image
5. Package into APEX
```

**Creation Tools:**
- `make_ext4fs` - Create ext4 image
- `mke2fs` - Create ext4 filesystem
- `img2simg` - Convert to sparse format

### apex_manifest.pb

#### Manifest Structure

**apex_manifest.pb:**
- Protobuf binary format
- Package metadata
- Module information
- Version information

**Manifest Contents:**
- Package name
- Version information
- Module type
- Dependencies
- Metadata

#### Manifest Fields

**Key Fields:**
- `name` - Package name
- `version` - Package version
- `versionName` - Version string
- `provideNativeLibs` - Native libraries provided
- `requireNativeLibs` - Native libraries required

**Field Characteristics:**
- Package identification
- Version management
- Dependency information
- Library information

### AndroidManifest.xml

#### Manifest Structure

**AndroidManifest.xml:**
- APK-style XML manifest
- Package declaration
- Component declarations
- Permission declarations

**Manifest Contents:**
```xml
<manifest package="com.android.media"
          versionCode="1"
          versionName="1.0">
    <application>
        <!-- Application components -->
    </application>
</manifest>
```

**Manifest Characteristics:**
- XML format
- Package declaration
- Version information
- Component declarations

#### Manifest Elements

**Key Elements:**
- `<manifest>` - Root element
- `<application>` - Application declaration
- `<uses-library>` - Library dependencies
- `<uses-native-library>` - Native library dependencies

**Element Characteristics:**
- Package identification
- Component declarations
- Dependency declarations
- Metadata

### Package Mounting

#### Mount Process

**Mount Process:**
```
1. APEX package installed
2. System extracts apex_payload.img
3. System mounts image at /apex/<module-name>/
4. Module files accessible
5. Module activated
```

**Mount Characteristics:**
- Mount-based activation
- Filesystem mounting
- Path-based access
- Runtime mounting

#### Mount Points

**Mount Point Structure:**
```
/apex/
├── com.android.media/
│   ├── lib/
│   ├── bin/
│   └── etc/
├── com.android.runtime/
│   └── ...
└── ...
```

**Mount Point Characteristics:**
- `/apex/<module-name>/` format
- Module-specific paths
- Filesystem access
- Library loading paths

### Package Organization

#### Directory Structure

**Internal Structure:**
```
apex_payload.img (mounted at /apex/<module-name>/)
├── lib/
│   ├── arm64/       - 64-bit ARM libraries
│   └── arm/         - 32-bit ARM libraries
├── lib64/           - 64-bit libraries (legacy)
├── lib32/           - 32-bit libraries (legacy)
├── bin/             - Native binaries
├── etc/             - Configuration files
└── ...              - Other files
```

**Structure Characteristics:**
- Standard directory layout
- Architecture-specific paths
- Binary and library organization
- Configuration file locations

#### File Organization

**File Organization:**
- Libraries in `lib/` or `lib64/`
- Binaries in `bin/`
- Configuration in `etc/`
- Metadata in manifest files

**Organization Characteristics:**
- Standard Linux layout
- Architecture separation
- Component organization
- Clear file structure

### Package Metadata

#### Version Information

**Version Metadata:**
- Version code (integer)
- Version name (string)
- Build information
- Release information

**Version Characteristics:**
- Numeric version code
- Human-readable version name
- Build metadata
- Release information

#### Dependency Information

**Dependency Metadata:**
- Required APEX modules
- Required native libraries
- Version requirements
- Compatibility information

**Dependency Characteristics:**
- Module dependencies
- Library dependencies
- Version requirements
- Compatibility rules

### Package Signing

#### Signing Structure

**Signing Files:**
```
META-INF/
├── MANIFEST.MF      - File manifest
├── CERT.SF          - Signature file
└── CERT.RSA         - Certificate
```

**Signing Characteristics:**
- JAR signing format
- Cryptographic signatures
- Certificate chain
- Integrity verification

#### Signature Verification

**Verification Process:**
```
1. Read META-INF/MANIFEST.MF
2. Verify file hashes
3. Read CERT.SF
4. Verify signature
5. Verify certificate chain
6. Check certificate validity
```

**Verification Characteristics:**
- Hash verification
- Signature verification
- Certificate validation
- Integrity checking

### Package Installation

#### Installation Process

**Installation Steps:**
```
1. Verify package signature
2. Verify package integrity
3. Extract apex_payload.img
4. Mount image at /apex/<module-name>/
5. Register module
6. Activate module
```

**Installation Characteristics:**
- Signature verification
- Integrity verification
- Image extraction
- Mount-based activation

#### Installation Location

**Installation Paths:**
- `/apex/<module-name>/` - Mount point
- `/data/apex/active/` - Active modules
- `/data/apex/sessions/` - Installation sessions

**Location Characteristics:**
- Mount-based access
- Active module tracking
- Session management
- Module registration

### Package Best Practices

#### Best Practices

**Best Practices:**
- Follow standard directory structure
- Use proper file organization
- Include complete metadata
- Sign packages properly
- Version packages correctly

**Practice Guidelines:**
- **Structure:** Follow standard directory structure
- **Organization:** Use proper file organization
- **Metadata:** Include complete metadata
- **Signing:** Sign packages properly
- **Versioning:** Version packages correctly

## Key Takeaways

1. **APEX package structure** refers to the internal organization and format of APEX packages, which are the package format used for updatable system components in Android.

2. **APEX package format** includes package file structure (apex_payload.img, apex_manifest.pb, AndroidManifest.xml, META-INF/), package file types (mountable image format, protobuf binary format, XML text format, JAR signing format), and format characteristics.

3. **apex_payload.img** includes image structure (ext4 filesystem image, contains module files, mountable at runtime, read-only filesystem), image contents (lib/, bin/, etc/, other module files), image creation (prepare module files, create ext4 filesystem, copy files, create sparse image, package into APEX), and image characteristics.

4. **apex_manifest.pb** includes manifest structure (protobuf binary format, package metadata, module information, version information), manifest fields (name, version, versionName, provideNativeLibs, requireNativeLibs), and manifest characteristics.

5. **AndroidManifest.xml** includes manifest structure (APK-style XML manifest, package declaration, component declarations, permission declarations), manifest elements (manifest, application, uses-library, uses-native-library), and manifest characteristics.

6. **Package mounting** includes mount process (APEX package installed, system extracts apex_payload.img, system mounts image at /apex/<module-name>/, module files accessible, module activated), mount points (/apex/<module-name>/ format, module-specific paths, filesystem access, library loading paths), and mounting characteristics.

7. **Package organization** includes directory structure (lib/, lib64/, bin/, etc/, standard Linux layout), file organization (libraries in lib/ or lib64/, binaries in bin/, configuration in etc/, metadata in manifest files), and organization characteristics.

8. **Package metadata** includes version information (version code, version name, build information, release information), dependency information (required APEX modules, required native libraries, version requirements, compatibility information), and metadata characteristics.

9. **Understanding APEX package structure** is essential for AOSP development, enabling proper package creation, module organization, system integration, and proper APEX package implementation.

## Related Topics

- **Mainline modules (APEX, APKs in system):** Mainline modules details
- **Pre-installation verification:** Verification details
- **ADB installation of APEX:** Installation details

