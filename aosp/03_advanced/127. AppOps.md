---
number: 127
title: AppOps
slug: appops
level: advanced
tags:
  - aosp
  - framework
  - appops
  - permissions
  - operation-control
  - security
  - privacy
prerequisites:
  - permissions-system
  - permissions-service
  - runtime-permissions
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-127
---

# AppOps

## Overview

AppOps (Application Operations) is a fine-grained operation control system in Android that provides additional control over permission-based operations beyond the standard permission system. AppOps allows users and system administrators to control specific operations (like camera access, location access, etc.) independently of permission grants, providing more granular control and privacy protection. Understanding AppOps is essential for AOSP development, as it explains how AppOps works, how operations are controlled, how AppOps integrates with the permission system, how AppOps modes are managed, and how AppOps provides fine-grained access control. This guide provides a comprehensive overview of AppOps, architecture, operation modes, operation control, AppOpsManager, integration with permissions, and debugging.

Think of AppOps like a fine-grained access control system: just as a building might have different access levels for different areas (permissions) and also time-based restrictions or usage limits (AppOps), AppOps provides additional control over operations beyond just permission grants, allowing fine-grained control over when and how operations can be performed.

## Deep Explanation

### What is AppOps?

AppOps (Application Operations) is a fine-grained operation control system in Android that provides additional control over permission-based operations beyond the standard permission system. AppOps allows users and system administrators to control specific operations independently of permission grants, providing more granular control and privacy protection.

**Key Characteristics:**
- **Operation Control:** Controls specific operations
- **Fine-Grained:** More granular than permissions
- **Independent:** Independent of permission grants
- **User Control:** User can control operations
- **Privacy:** Enhanced privacy protection

**Why AppOps?**
- **Fine-Grained Control:** More granular than permissions
- **Privacy:** Enhanced privacy protection
- **Flexibility:** Flexible operation control
- **User Control:** User controls operations

### AppOps Architecture

#### System Components

**AppOps Components:**
- **AppOpsService:** Manages AppOps operations
- **AppOpsManager:** Framework API for AppOps
- **Operation Registry:** Registry of operations
- **Mode Storage:** Stores operation modes
- **Policy Enforcement:** Enforces operation policies

**AppOps Location:**
- AppOpsService runs in SystemServer
- AppOpsManager in framework
- Integrated with permission system
- Coordinated with system services

#### Operation Concept

**Operations:**
- Specific actions apps can perform
- Mapped to permissions
- Controlled independently
- Mode-based control

**Operation Examples:**
- **OP_CAMERA:** Camera access
- **OP_COARSE_LOCATION:** Coarse location
- **OP_FINE_LOCATION:** Fine location
- **OP_READ_CONTACTS:** Read contacts
- **OP_WRITE_CONTACTS:** Write contacts

### AppOps Modes

#### Mode Types

**AppOps Modes:**
- **MODE_ALLOWED:** Operation allowed
- **MODE_IGNORED:** Operation ignored (denied)
- **MODE_ERRORED:** Operation causes error
- **MODE_DEFAULT:** Use default behavior

**Mode Characteristics:**
- **ALLOWED:** Operation can proceed
- **IGNORED:** Operation denied silently
- **ERRORED:** Operation causes error
- **DEFAULT:** Follows permission state

#### Mode Management

**Mode Management:**
- Set operation mode per app
- Mode stored persistently
- Mode checked on operation
- Mode can be changed

**Mode Setting:**
```java
// Set AppOps mode
AppOpsManager appOps = (AppOpsManager) context.getSystemService(
    Context.APP_OPS_SERVICE);

appOps.setMode(
    AppOpsManager.OP_CAMERA,
    uid,
    packageName,
    AppOpsManager.MODE_IGNORED
);
```

### Operation Control

#### Operation Checking

**Operation Check:**
- Check operation mode before allowing
- Query AppOpsService
- Enforce operation mode
- Return appropriate result

**Check Process:**
```
1. App attempts operation
2. System checks AppOps mode
3. If MODE_ALLOWED: Allow operation
4. If MODE_IGNORED: Deny silently
5. If MODE_ERRORED: Return error
6. If MODE_DEFAULT: Check permission
```

**Check Implementation:**
```java
// Check AppOps mode
int mode = appOps.checkOp(
    AppOpsManager.OP_CAMERA,
    Process.myUid(),
    packageName
);

if (mode != AppOpsManager.MODE_ALLOWED) {
    // Operation not allowed
    return;
}

// Operation allowed
performOperation();
```

#### Operation Enforcement

**Enforcement Points:**
- System service calls
- Framework API calls
- Resource access
- Operation execution

**Enforcement:**
- Automatic enforcement
- Transparent to apps
- Consistent across system
- Privacy guaranteed

### AppOpsManager

#### AppOpsManager API

**AppOpsManager:**
- Framework API for AppOps
- Provides operation control
- Manages operation modes
- Queries operation state

**AppOpsManager Usage:**
```java
// Get AppOpsManager
AppOpsManager appOps = (AppOpsManager) context.getSystemService(
    Context.APP_OPS_SERVICE);

// Check operation
int mode = appOps.checkOp(
    AppOpsManager.OP_CAMERA,
    Process.myUid(),
    packageName
);

// Set mode
appOps.setMode(
    AppOpsManager.OP_CAMERA,
    uid,
    packageName,
    AppOpsManager.MODE_IGNORED
);
```

#### Operation Constants

**Operation Constants:**
- `OP_CAMERA` - Camera access
- `OP_COARSE_LOCATION` - Coarse location
- `OP_FINE_LOCATION` - Fine location
- `OP_READ_CONTACTS` - Read contacts
- `OP_WRITE_CONTACTS` - Write contacts
- `OP_READ_PHONE_STATE` - Read phone state
- `OP_CALL_PHONE` - Make phone calls
- `OP_READ_SMS` - Read SMS
- `OP_SEND_SMS` - Send SMS
- `OP_WRITE_EXTERNAL_STORAGE` - Write storage
- And many more...

### AppOps Integration

#### Permission Integration

**Permission Integration:**
- AppOps works with permissions
- Operation mode checked first
- Permission checked if MODE_DEFAULT
- Combined access control

**Integration Flow:**
```
Operation Request → Check AppOps Mode → 
If MODE_DEFAULT: Check Permission → 
Allow/Deny Operation
```

**Integration Example:**
```java
// Combined check
int appOpsMode = appOps.checkOp(OP_CAMERA, uid, packageName);

if (appOpsMode == MODE_IGNORED || appOpsMode == MODE_ERRORED) {
    // AppOps denies
    return;
}

if (appOpsMode == MODE_DEFAULT) {
    // Check permission
    if (checkPermission(CAMERA) != GRANTED) {
        return;
    }
}

// Operation allowed
```

#### System Service Integration

**Service Integration:**
- Services check AppOps
- Query AppOpsService
- Enforce operation control
- Coordinate with permissions

**Service Integration Example:**
```java
// Service checks AppOps
public void openCamera(String cameraId) {
    // Check AppOps
    int mode = mAppOpsManager.checkOp(
        AppOpsManager.OP_CAMERA, pid, uid, packageName);
    
    if (mode != AppOpsManager.MODE_ALLOWED) {
        throw new SecurityException("Camera operation denied");
    }
    
    // Check permission (if MODE_DEFAULT)
    if (mode == AppOpsManager.MODE_DEFAULT) {
        if (checkPermission(CAMERA) != GRANTED) {
            throw new SecurityException("Camera permission required");
        }
    }
    
    // Open camera
}
```

### Operation Modes

#### MODE_ALLOWED

**MODE_ALLOWED:**
- Operation allowed
- App can perform operation
- Overrides permission check
- Operation proceeds

**Usage:**
- Explicitly allow operation
- Override permission state
- Enable operation

#### MODE_IGNORED

**MODE_IGNORED:**
- Operation denied silently
- App cannot perform operation
- No error thrown
- Operation fails silently

**Usage:**
- Deny operation silently
- Privacy protection
- No user notification

#### MODE_ERRORED

**MODE_ERRORED:**
- Operation causes error
- App cannot perform operation
- Error thrown
- Operation fails with error

**Usage:**
- Deny operation with error
- App notified of denial
- Error handling required

#### MODE_DEFAULT

**MODE_DEFAULT:**
- Use default behavior
- Follows permission state
- Permission check applies
- Standard permission flow

**Usage:**
- Default operation control
- Follows permissions
- Standard behavior

### AppOps Storage

#### Storage Location

**Storage:**
- `/data/system/appops.xml` - AppOps mode storage
- Per-user storage
- Per-package storage
- Persistent across reboots

**Storage Format:**
```xml
<appops>
    <pkg n="com.example.app">
        <op n="0" m="1" /> <!-- OP_CAMERA = MODE_IGNORED -->
        <op n="1" m="0" /> <!-- OP_COARSE_LOCATION = MODE_ALLOWED -->
    </pkg>
</appops>
```

#### State Management

**State Management:**
- Mode stored persistently
- State restored on boot
- Per-user state
- Per-package state

### AppOps Policies

#### Policy Types

**AppOps Policies:**
- Operation policies
- Mode policies
- Enforcement policies
- User preferences

**Policy Enforcement:**
- System-wide policies
- Per-app policies
- User preferences
- System restrictions

### Debugging AppOps

#### Debugging Tools

**Debugging Tools:**
- AppOps dumps
- State inspection
- Mode queries
- Operation logs

**Debugging Commands:**
```bash
# Dump AppOps state
adb shell dumpsys appops

# Check app AppOps
adb shell dumpsys appops <package-name>

# Set AppOps mode
adb shell appops set <package> <op> <mode>

# Get AppOps mode
adb shell appops get <package> <op>
```

#### Common Issues

**Common Issues:**
- Operation denied unexpectedly
- Mode not applying
- State not updating
- Integration issues

**Debugging Steps:**
1. Check AppOps state
2. Verify operation mode
3. Check AppOps logs
4. Review integration
5. Verify mode storage

## Key Takeaways

1. **AppOps (Application Operations)** is a fine-grained operation control system that provides additional control over permission-based operations beyond the standard permission system.

2. **AppOps architecture** includes system components (AppOpsService, AppOpsManager, operation registry, mode storage), operation concept (specific actions, mapped to permissions, controlled independently), and AppOps location (AppOpsService in SystemServer, AppOpsManager in framework).

3. **AppOps modes** include mode types (MODE_ALLOWED, MODE_IGNORED, MODE_ERRORED, MODE_DEFAULT), mode characteristics (ALLOWED: proceed, IGNORED: deny silently, ERRORED: return error, DEFAULT: follow permission), and mode management (set mode per app, stored persistently, checked on operation).

4. **Operation control** includes operation checking (check mode before allowing, query AppOpsService, enforce mode, return result), operation enforcement (enforcement points, automatic enforcement, transparent, consistent), and check process (check mode, allow/deny based on mode).

5. **AppOpsManager** includes AppOpsManager API (framework API for AppOps, provides operation control, manages modes), operation constants (OP_CAMERA, OP_COARSE_LOCATION, OP_FINE_LOCATION, etc.), and AppOpsManager usage (check operation, set mode, query state).

6. **AppOps integration** includes permission integration (works with permissions, mode checked first, permission checked if DEFAULT, combined control), system service integration (services check AppOps, query AppOpsService, enforce control), and integration flow (operation request → check AppOps → check permission if DEFAULT).

7. **Operation modes** include MODE_ALLOWED (operation allowed, overrides permission), MODE_IGNORED (denied silently, no error), MODE_ERRORED (denied with error, error thrown), MODE_DEFAULT (follows permission state, standard flow), and mode usage.

8. **AppOps storage** includes storage location (/data/system/appops.xml, per-user, per-package, persistent), storage format (XML format, package and operation data), and state management (mode stored persistently, restored on boot, per-user, per-package).

9. **Understanding AppOps** is essential for AOSP development, enabling fine-grained operation control, enhanced privacy protection, flexible access control, and improved user control over app operations.

## Related Topics

- **Permissions system:** Overall permissions system
- **Permissions service:** PermissionManagerService implementation
- **Runtime permissions:** Runtime permission model
- **Android Security Model:** Overall security architecture

