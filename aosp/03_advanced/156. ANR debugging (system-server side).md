---
number: 156
title: ANR debugging (system/server side)
slug: anr-debugging-system-server-side
level: advanced
tags:
  - aosp
  - debugging
  - anr
  - system-server
  - server-side-debugging
  - performance
prerequisites:
  - system-server-overview
  - debugging-anr-at-framework-level
  - activitymanagerservice-ams-internals
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-156
---

# ANR debugging (system/server side)

## Overview

ANR debugging at the system/server side involves analyzing ANR occurrences from the system server perspective, focusing on system server ANRs, service ANRs, and server-side causes of application ANRs. System/server side ANR debugging requires understanding how system server detects ANRs, how system services can cause ANRs, how to analyze system server ANR traces, and how to debug server-side ANR issues. Understanding ANR debugging at the system/server side is essential for AOSP development, as it explains how system server handles ANRs, how services can cause ANRs, how to analyze system server state during ANRs, and how to debug and fix server-side ANR issues. This guide provides a comprehensive overview of ANR debugging at the system/server side, system server ANR detection, service ANR analysis, system server debugging, and server-side ANR resolution.

Think of ANR debugging at the system/server side like investigating a service outage from the server perspective: just as a server administrator investigates service outages by checking server logs (system server logs), analyzing server state (system server state), identifying server issues (service problems), and fixing server problems (server-side fixes), ANR debugging at the system/server side involves checking system server logs, analyzing system server state, identifying service issues, and fixing server-side problems.

## Deep Explanation

### What is System/Server Side ANR Debugging?

ANR debugging at the system/server side involves analyzing ANR occurrences from the system server perspective, focusing on system server ANRs, service ANRs, and server-side causes of application ANRs. This includes understanding how system server detects and handles ANRs, how services can cause ANRs, and how to debug server-side ANR issues.

**Key Characteristics:**
- **System Server Perspective:** System server focus
- **Service Analysis:** Service-level analysis
- **Server State:** System server state analysis
- **Server-Side Causes:** Identifying server-side causes
- **Service Debugging:** Service debugging

**Why System/Server Side ANR Debugging?**
- **Server ANRs:** Debug system server ANRs
- **Service Issues:** Identify service problems
- **Server Optimization:** Optimize system server
- **Service Performance:** Improve service performance

### System Server ANR Detection

#### System Server ANR Types

**System Server ANR Types:**
- **System Server Main Thread ANR:** Main thread blocked
- **Service ANR:** Service operation timeout
- **Binder ANR:** Binder transaction timeout
- **System-Wide ANR:** System-wide unresponsiveness

**ANR Detection:**
- ActivityManagerService monitors ANRs
- Service timeouts detected
- Binder transaction timeouts
- System responsiveness monitoring

#### ANR Detection Mechanism

**Detection Process:**
```
1. System service receives request
2. Service starts processing
3. AMS monitors service response
4. If timeout expires:
   - ANR detected
   - System server ANR
   - Service ANR logged
   - Diagnostics collected
```

**Timeout Values:**
- Service ANR: 20 seconds
- Binder ANR: Variable
- System server ANR: System-wide

### System Server ANR Analysis

#### System Server State Analysis

**System Server State:**
- Main thread state
- Service states
- Binder transaction states
- Memory state
- CPU state

**State Analysis:**
```bash
# Check system server state
adb shell dumpsys activity | grep -A 50 "system_server"

# Check system server threads
adb shell cat /data/anr/traces.txt | grep -A 100 "system_server"

# Check system server memory
adb shell dumpsys meminfo system_server
```

#### System Server Thread Analysis

**Thread Analysis:**
- Main thread state
- Binder thread states
- Service thread states
- Worker thread states

**Thread State Check:**
```bash
# Get system server threads
adb shell cat /data/anr/traces.txt | grep -A 50 "system_server" | grep "prio="

# Check thread states
adb shell ps -T | grep system_server
```

### Service ANR Analysis

#### Service ANR Detection

**Service ANR:**
- Service operation timeout
- Service main thread blocked
- Service deadlock
- Service performance issue

**Service ANR Detection:**
```bash
# Check service ANR
adb shell dumpsys activity services | grep -i anr

# Check specific service
adb shell dumpsys <service_name> | grep -i anr
```

#### Service State Analysis

**Service State:**
- Service running state
- Service operation state
- Service thread state
- Service resource usage

**Service Analysis:**
```bash
# Dump service state
adb shell dumpsys <service_name>

# Check service threads
adb shell cat /data/anr/traces.txt | grep -A 50 "<service_name>"

# Check service logs
adb logcat | grep <service_name>
```

### System Server ANR Causes

#### Main Thread Blocking

**Main Thread Blocking:**
- Synchronous I/O on main thread
- Long computation on main thread
- Blocking network calls
- Deadlock on main thread

**Blocking Examples:**
```java
// BAD: Blocking I/O on main thread
public void serviceMethod() {
    File file = new File("/large/file");
    byte[] data = Files.readAllBytes(file.toPath()); // Blocks!
}

// GOOD: Async I/O
public void serviceMethod() {
    executor.execute(() -> {
        File file = new File("/large/file");
        byte[] data = Files.readAllBytes(file.toPath());
        // Process data
    });
}
```

#### Service Deadlock

**Service Deadlock:**
- Circular service dependencies
- Lock contention
- Resource deadlock
- Binder deadlock

**Deadlock Prevention:**
- Avoid circular dependencies
- Use async operations
- Minimize lock contention
- Use timeout mechanisms

#### Binder Transaction Issues

**Binder Issues:**
- Slow Binder transactions
- Binder transaction deadlock
- Excessive Binder calls
- Large Binder transactions

**Binder Analysis:**
```bash
# Check Binder state
adb shell dumpsys binder

# Check Binder transactions
adb shell dumpsys binder | grep -A 20 "transactions"

# Trace Binder transactions
adb shell setprop debug.binder.trace 1
```

### System Server ANR Debugging

#### ANR Trace Analysis

**System Server Traces:**
```bash
# Get system server ANR trace
adb shell cat /data/anr/traces.txt | grep -A 100 "system_server"

# Filter main thread
adb shell cat /data/anr/traces.txt | grep -A 50 "system_server" | grep "main"

# Check thread states
adb shell cat /data/anr/traces.txt | grep -A 50 "system_server" | grep "Blocked\|Waiting"
```

#### System Server Logs

**System Server Logs:**
```bash
# System server logs
adb logcat | grep SystemServer

# ANR logs
adb logcat | grep -i anr

# Service-specific logs
adb logcat | grep <service_name>
```

#### System Server State Dump

**State Dump:**
```bash
# Full system server dump
adb shell dumpsys activity

# Service dumps
adb shell dumpsys <service_name>

# Memory dump
adb shell dumpsys meminfo system_server

# CPU dump
adb shell dumpsys cpuinfo
```

### Service-Specific ANR Debugging

#### ActivityManagerService ANR

**AMS ANR:**
- Activity lifecycle blocking
- Process management blocking
- Task stack operations blocking

**AMS Debugging:**
```bash
# AMS state
adb shell dumpsys activity

# AMS ANR history
adb shell dumpsys activity | grep -A 50 "ANR"

# AMS threads
adb shell cat /data/anr/traces.txt | grep -A 50 "ActivityManager"
```

#### WindowManagerService ANR

**WMS ANR:**
- Window operations blocking
- Surface operations blocking
- Display operations blocking

**WMS Debugging:**
```bash
# WMS state
adb shell dumpsys window

# WMS ANR
adb shell dumpsys window | grep -i anr

# WMS threads
adb shell cat /data/anr/traces.txt | grep -A 50 "WindowManager"
```

#### PackageManagerService ANR

**PMS ANR:**
- Package operations blocking
- Permission checks blocking
- Component queries blocking

**PMS Debugging:**
```bash
# PMS state
adb shell dumpsys package

# PMS ANR
adb shell dumpsys package | grep -i anr

# PMS threads
adb shell cat /data/anr/traces.txt | grep -A 50 "PackageManager"
```

### System Server Performance Analysis

#### CPU Analysis

**CPU Analysis:**
```bash
# System server CPU usage
adb shell top -p $(adb shell pidof system_server)

# CPU per thread
adb shell cat /proc/$(adb shell pidof system_server)/task/*/stat

# CPU frequency
adb shell dumpsys cpuinfo
```

#### Memory Analysis

**Memory Analysis:**
```bash
# System server memory
adb shell dumpsys meminfo system_server

# Memory per service
adb shell dumpsys meminfo | grep -A 20 system_server

# Memory leaks
adb shell dumpsys meminfo system_server | grep -i leak
```

#### Binder Analysis

**Binder Analysis:**
```bash
# Binder statistics
adb shell dumpsys binder

# Binder transactions
adb shell dumpsys binder | grep -A 20 "transactions"

# Binder deadlock
adb shell dumpsys binder | grep -i deadlock
```

### ANR Prevention at System Server

#### Service Design

**Service Design Guidelines:**
- Fast service operations
- Async operations
- Minimal blocking operations
- Efficient resource usage

**Design Best Practices:**
- Use background threads
- Avoid blocking I/O
- Minimize lock contention
- Use async APIs

#### Performance Optimization

**Optimization Techniques:**
- Optimize service operations
- Reduce Binder calls
- Improve memory usage
- Optimize CPU usage

**Optimization Examples:**
- Cache frequently accessed data
- Batch operations
- Use efficient algorithms
- Minimize allocations

### Debugging Workflow

#### System Server ANR Debugging Steps

**Debugging Process:**
1. Identify ANR type
2. Collect system server state
3. Analyze ANR traces
4. Check service states
5. Identify root cause
6. Fix issue
7. Verify fix

**Step-by-Step:**
```bash
# Step 1: Identify ANR
adb shell dumpsys activity | grep -i anr

# Step 2: Collect state
adb shell dumpsys activity > system_state.txt
adb shell cat /data/anr/traces.txt > anr_traces.txt

# Step 3: Analyze traces
# Review anr_traces.txt for system_server

# Step 4: Check services
adb shell dumpsys activity services

# Step 5: Identify cause
# Analyze blocking operations
# Check deadlocks
# Review service logs

# Step 6: Fix
# Modify service code
# Optimize operations

# Step 7: Verify
# Test fix
# Monitor for ANRs
```

### Best Practices

#### System Server ANR Prevention

**Prevention Guidelines:**
- Keep service operations fast
- Use async operations
- Avoid blocking main thread
- Minimize Binder calls

**Code Guidelines:**
- No blocking I/O on main thread
- Use background threads
- Use async APIs
- Minimize lock contention

#### ANR Debugging Best Practices

**Debugging Guidelines:**
- Collect state immediately
- Analyze traces systematically
- Check all services
- Review logs thoroughly
- Test fixes completely

## Key Takeaways

1. **ANR debugging at the system/server side** involves analyzing ANR occurrences from the system server perspective, focusing on system server ANRs, service ANRs, and server-side causes of application ANRs.

2. **System server ANR detection** includes system server ANR types (system server main thread ANR, service ANR, Binder ANR, system-wide ANR), ANR detection mechanism (system service receives request, service starts processing, AMS monitors service response, timeout detection), and detection types.

3. **System server ANR analysis** includes system server state analysis (main thread state, service states, Binder transaction states, memory state, CPU state), system server thread analysis (main thread state, Binder thread states, service thread states, worker thread states), and analysis methods.

4. **Service ANR analysis** includes service ANR detection (service operation timeout, service main thread blocked, service deadlock), service state analysis (service running state, service operation state, service thread state, service resource usage), and service analysis.

5. **System server ANR causes** include main thread blocking (synchronous I/O on main thread, long computation on main thread, blocking network calls), service deadlock (circular service dependencies, lock contention, resource deadlock), Binder transaction issues (slow Binder transactions, Binder transaction deadlock, excessive Binder calls), and cause analysis.

6. **System server ANR debugging** includes ANR trace analysis (get system server ANR trace, filter main thread, check thread states), system server logs (system server logs, ANR logs, service-specific logs), system server state dump (full system server dump, service dumps, memory dump, CPU dump), and debugging methods.

7. **Service-specific ANR debugging** includes ActivityManagerService ANR (activity lifecycle blocking, process management blocking), WindowManagerService ANR (window operations blocking, surface operations blocking), PackageManagerService ANR (package operations blocking, permission checks blocking), and service debugging.

8. **System server performance analysis** includes CPU analysis (system server CPU usage, CPU per thread, CPU frequency), memory analysis (system server memory, memory per service, memory leaks), Binder analysis (Binder statistics, Binder transactions, Binder deadlock), and performance analysis.

9. **Understanding ANR debugging at the system/server side** is essential for AOSP development, enabling server ANR debugging, service issue identification, server optimization, and proper system/server side ANR debugging.

## Related Topics

- **System Server Overview:** System server details
- **Debugging ANR at framework level:** Framework ANR debugging details
- **ActivityManagerService (AMS) internals:** AMS details

