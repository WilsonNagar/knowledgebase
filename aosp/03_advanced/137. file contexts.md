---
number: 137
title: file contexts
slug: file-contexts
level: advanced
tags:
  - aosp
  - security
  - selinux
  - file-contexts
  - filesystem-labeling
  - context-mapping
prerequisites:
  - sepolicy
  - domain-type-enforcement-rules
  - selinux-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-137
---

# file contexts

## Overview

File contexts are SELinux security labels that map file paths to SELinux security contexts, determining what SELinux type each file or directory has. File contexts are defined in `file_contexts` files and are used during boot to label the filesystem, ensuring that every file has the correct SELinux context for access control decisions. Understanding file contexts is essential for AOSP development, as it explains how files are labeled with SELinux contexts, how file context mappings work, how filesystem labeling is performed, how file contexts are applied, and how file contexts enable access control. This guide provides a comprehensive overview of file contexts, file context format, filesystem labeling, context application, and file context management.

Think of file contexts like address labels: just as addresses label locations to identify where things are located, file contexts label files to identify what security type they have, enabling SELinux to make access control decisions based on file types.

## Deep Explanation

### What are File Contexts?

File contexts are SELinux security labels that map file paths to SELinux security contexts, determining what SELinux type each file or directory has. File contexts are defined in `file_contexts` files and are used during boot to label the filesystem, ensuring that every file has the correct SELinux context for access control decisions.

**Key Characteristics:**
- **Path-Based:** Maps file paths to contexts
- **Regex-Based:** Uses regular expressions for matching
- **Boot-Time:** Applied during boot
- **Persistent:** Contexts persist across reboots
- **Access Control:** Used for access control decisions

**Why File Contexts?**
- **Security:** Enables file-based access control
- **Labeling:** Labels filesystem with contexts
- **Access Control:** Used for access control decisions
- **Isolation:** Isolates different file types

### File Context Format

#### Format Structure

**File Context Format:**
```
path_regex context [file_type]
```

**Format Components:**
- **path_regex:** Regular expression matching file path
- **context:** SELinux security context
- **file_type:** Optional file type specification

**Format Example:**
```
/system/bin/.* u:object_r:system_file:s0
/data/data(/.*)? u:object_r:app_data_file:s0
```

#### Path Regex

**Path Regex:**
- Regular expression matching file paths
- Supports wildcards and patterns
- Matches against full file paths
- First match wins

**Regex Examples:**
```
# Match all files in /system/bin/
/system/bin/.*

# Match /data/data and all subdirectories
/data/data(/.*)?

# Match specific file
/system/build.prop

# Match files with extension
/.*\.so$
```

#### Context Format

**Context Format:**
- Full format: `user:role:type:level`
- Android format: `u:object_r:type:s0`
- Simplified format: `type:s0`

**Context Components:**
- **user:** SELinux user (usually `u`)
- **role:** Object role (usually `object_r`)
- **type:** File type (e.g., `system_file`, `app_data_file`)
- **level:** MLS/MCS level (usually `s0`)

**Context Examples:**
```
u:object_r:system_file:s0
u:object_r:app_data_file:s0
u:object_r:vendor_file:s0
```

#### File Type Specification

**File Type Specification:**
- Optional file type in file_contexts
- Specifies file type (file, dir, etc.)
- Used for type-specific labeling
- Defaults to file if not specified

**File Type Examples:**
```
# Regular file
/system/bin/app_process u:object_r:system_file:s0 -- file

# Directory
/data/data u:object_r:app_data_file:s0 -- dir

# Symbolic link
/system/bin/sh u:object_r:system_file:s0 -- lnk_file
```

### File Context Files

#### File Context File Location

**File Context File Location:**
- Source: `system/sepolicy/private/file_contexts` or `device/*/sepolicy/file_contexts`
- Compiled: `/file_contexts` (initramfs) or `/system/etc/selinux/file_contexts`
- Used during boot for filesystem labeling

**File Locations:**
```
# Source files
system/sepolicy/private/file_contexts
system/sepolicy/public/file_contexts
device/*/sepolicy/file_contexts

# Compiled files
/file_contexts (initramfs)
/system/etc/selinux/file_contexts
/vendor/etc/selinux/file_contexts
```

#### File Context File Structure

**File Context File Structure:**
```
# System files
/system/bin/.* u:object_r:system_file:s0
/system/lib/.* u:object_r:system_file:s0

# App data
/data/data(/.*)? u:object_r:app_data_file:s0

# Vendor files
/vendor/bin/.* u:object_r:vendor_file:s0
```

**File Organization:**
- Comments with `#`
- One entry per line
- Order matters (first match wins)
- Regex patterns for paths

### Filesystem Labeling

#### Labeling Process

**Labeling Process:**
- File contexts applied during boot
- `restorecon` command applies contexts
- Recursive labeling for directories
- Contexts stored in filesystem

**Labeling Steps:**
```
1. Policy loaded
2. File contexts file read
3. Filesystem scanned
4. Contexts matched to paths
5. Contexts applied to files
6. Contexts stored in filesystem
```

#### restorecon Command

**restorecon Command:**
- Applies file contexts to files
- Restores contexts from file_contexts
- Recursive option for directories
- Verbose option for debugging

**Command Usage:**
```bash
# Restore context for file
restorecon /system/bin/app_process

# Restore contexts recursively
restorecon -R /system

# Verbose output
restorecon -v -R /data

# Force restore
restorecon -F /system
```

#### Labeling During Boot

**Labeling During Boot:**
- Performed during early-init phase
- After policy is loaded
- Before enforcing mode
- After partitions are mounted

**Init.rc Usage:**
```
on early-init
    # Label filesystem
    restorecon_recursive /system
    restorecon_recursive /vendor
    restorecon_recursive /data
```

**Labeling Order:**
1. System partition mounted
2. Policy loaded
3. File contexts applied
4. Enforcing mode enabled

### Common File Contexts

#### System File Contexts

**System File Contexts:**
- `system_file` - System partition files
- `system_exec` - System executables
- `system_lib_file` - System libraries
- `system_config_file` - System configuration files

**Examples:**
```
/system/bin/.* u:object_r:system_file:s0
/system/lib/.* u:object_r:system_lib_file:s0
/system/etc/.* u:object_r:system_config_file:s0
```

#### App Data File Contexts

**App Data File Contexts:**
- `app_data_file` - Application data files
- `app_data_file_cache` - Application cache files
- `untrusted_app_data_file` - Untrusted app data files
- `app_data_file_isolated` - Isolated app data files

**Examples:**
```
/data/data(/.*)? u:object_r:app_data_file:s0
/data/data/.*/cache(/.*)? u:object_r:app_data_file_cache:s0
/data/user/0/.* u:object_r:untrusted_app_data_file:s0
```

#### Vendor File Contexts

**Vendor File Contexts:**
- `vendor_file` - Vendor partition files
- `vendor_exec` - Vendor executables
- `vendor_config_file` - Vendor configuration files

**Examples:**
```
/vendor/bin/.* u:object_r:vendor_file:s0
/vendor/lib/.* u:object_r:vendor_file:s0
/vendor/etc/.* u:object_r:vendor_config_file:s0
```

### File Context Matching

#### Matching Rules

**Matching Rules:**
- First match wins
- Regex patterns matched against full path
- Order matters in file_contexts
- More specific patterns should come first

**Matching Process:**
```
1. File path checked against regex patterns
2. Patterns checked in order
3. First matching pattern used
4. Context from matching pattern applied
```

#### Matching Examples

**Matching Examples:**
```
# Specific path (matches first)
/data/myapp/config.txt u:object_r:my_config_file:s0

# General pattern (matches if specific doesn't)
/data/.* u:object_r:app_data_file:s0

# In this case, /data/myapp/config.txt matches first pattern
```

### File Context Application

#### Context Application

**Context Application:**
- Contexts applied during boot
- Contexts applied when files created
- Contexts can be changed with restorecon
- Contexts persist across reboots

**Application Process:**
```
1. File created or accessed
2. File path matched against file_contexts
3. Context from matching pattern applied
4. Context stored in filesystem
5. Context used for access control
```

#### Context Persistence

**Context Persistence:**
- Contexts stored in filesystem
- Persist across reboots
- Preserved during file operations
- Can be restored with restorecon

**Persistence Characteristics:**
- **Stored:** Contexts stored in filesystem
- **Persistent:** Persist across reboots
- **Preserved:** Preserved during operations
- **Restorable:** Can be restored

### File Context Management

#### Adding File Contexts

**Adding File Contexts:**
- Add entries to file_contexts file
- Use appropriate regex patterns
- Specify correct context
- Rebuild and apply

**Adding Process:**
```
1. Edit file_contexts file
2. Add new entry with regex and context
3. Rebuild policy
4. Apply contexts with restorecon
```

#### Updating File Contexts

**Updating File Contexts:**
- Update entries in file_contexts
- Modify regex patterns if needed
- Update contexts if needed
- Rebuild and reapply

**Updating Process:**
```
1. Edit file_contexts file
2. Update entry
3. Rebuild policy
4. Reapply contexts
```

### File Context Best Practices

#### Best Practices

**Best Practices:**
- Use specific patterns when possible
- Order patterns from specific to general
- Document context choices
- Test context changes

**Practice Guidelines:**
- **Specificity:** Use specific patterns
- **Ordering:** Order from specific to general
- **Documentation:** Document context choices
- **Testing:** Test context changes

### Debugging File Contexts

#### Debugging Tools

**Debugging Tools:**
- `ls -Z` - View file contexts
- `restorecon -v` - Verbose restorecon
- `matchpathcon` - Match path to context
- File context inspection

**Debugging Commands:**
```bash
# View file context
ls -Z /system/bin/app_process

# View directory context
ls -dZ /data/data/

# Match path to context
matchpathcon /system/bin/app_process

# Verbose restorecon
restorecon -v /system/bin/app_process
```

#### Common Issues

**Common Issues:**
- Files not labeled correctly
- Context mismatches
- Missing file contexts
- Incorrect regex patterns

**Debugging Steps:**
1. Check file context with `ls -Z`
2. Verify file_contexts entry
3. Check regex pattern matching
4. Apply contexts with restorecon
5. Verify context application

## Key Takeaways

1. **File contexts** are SELinux security labels that map file paths to SELinux security contexts, determining what SELinux type each file or directory has.

2. **File context format** includes format structure (path_regex context [file_type]), path regex (regular expression matching file paths, supports wildcards and patterns), context format (full format: user:role:type:level, Android format: u:object_r:type:s0), and file type specification (optional file type, specifies file type, defaults to file if not specified).

3. **File context files** include file context file location (source files in sepolicy directories, compiled files in /file_contexts or /system/etc/selinux/file_contexts), file context file structure (comments, one entry per line, order matters, regex patterns), and file organization.

4. **Filesystem labeling** includes labeling process (file contexts applied during boot, restorecon command applies contexts, recursive labeling for directories), restorecon command (applies file contexts to files, restores contexts from file_contexts, recursive option for directories), labeling during boot (performed during early-init phase, after policy is loaded, before enforcing mode), and labeling order.

5. **Common file contexts** include system file contexts (system_file, system_exec, system_lib_file, system_config_file), app data file contexts (app_data_file, app_data_file_cache, untrusted_app_data_file, app_data_file_isolated), vendor file contexts (vendor_file, vendor_exec, vendor_config_file), and context examples.

6. **File context matching** includes matching rules (first match wins, regex patterns matched against full path, order matters), matching process (file path checked against regex patterns, first matching pattern used, context from matching pattern applied), and matching examples.

7. **File context application** includes context application (contexts applied during boot, contexts applied when files created, contexts can be changed with restorecon), context persistence (contexts stored in filesystem, persist across reboots, preserved during file operations), and application process.

8. **File context management** includes adding file contexts (add entries to file_contexts file, use appropriate regex patterns, specify correct context, rebuild and apply), updating file contexts (update entries in file_contexts, modify regex patterns if needed, rebuild and reapply), and management process.

9. **Understanding file contexts** is essential for AOSP development, enabling filesystem labeling, file-based access control, security context management, and proper SELinux file context implementation.

## Related Topics

- **sepolicy:** SELinux policy details
- **domain, type enforcement rules:** Type enforcement details
- **audit logs:** SELinux audit logging
- **SELinux Policy Initialization:** Policy initialization process

