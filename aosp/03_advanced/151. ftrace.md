---
number: 151
title: ftrace
slug: ftrace
level: advanced
tags:
  - aosp
  - debugging
  - ftrace
  - kernel-tracing
  - function-tracing
  - system-tracing
prerequisites:
  - android-architecture-complete-overview
  - systrace-perfetto
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-advanced-151
---

# ftrace

## Overview

ftrace is a Linux kernel function tracer that provides detailed tracing of kernel function calls, kernel events, and system behavior. ftrace is built into the Linux kernel and provides low-level visibility into kernel execution, making it essential for kernel debugging, performance analysis, and understanding system behavior. Understanding ftrace is essential for AOSP development, as it explains how to use ftrace to trace kernel functions, how to enable and configure ftrace, how to analyze ftrace output, how to use ftrace for debugging, and how ftrace provides kernel-level visibility. This guide provides a comprehensive overview of ftrace, ftrace interface, tracing modes, event tracing, and ftrace usage.

Think of ftrace like a microscope for kernel execution: just as a microscope can reveal details invisible to the naked eye (cell structures, microorganisms), ftrace can reveal details of kernel execution (function calls, execution paths, timing) that are invisible to higher-level tools.

## Deep Explanation

### What is ftrace?

ftrace is a Linux kernel function tracer that provides detailed tracing of kernel function calls, kernel events, and system behavior. ftrace is built into the Linux kernel and provides low-level visibility into kernel execution.

**Key Characteristics:**
- **Kernel-Level:** Built into Linux kernel
- **Function Tracing:** Traces kernel function calls
- **Event Tracing:** Traces kernel events
- **Low Overhead:** Low performance overhead
- **Flexible:** Flexible tracing configuration

**Why ftrace?**
- **Kernel Debugging:** Essential kernel debugging tool
- **Performance Analysis:** Kernel performance analysis
- **System Understanding:** Understand system behavior
- **Low-Level Visibility:** Kernel-level visibility

### ftrace Interface

#### Debug Filesystem

**Debug Filesystem:**
- Located at `/sys/kernel/debug/tracing`
- Contains ftrace control files
- Read/write interface
- Kernel-space interface

**Interface Location:**
```bash
# Access ftrace interface
cd /sys/kernel/debug/tracing

# List available files
ls -la
```

#### Key Files

**Key Files:**
- **trace:** Trace output
- **current_tracer:** Current tracer type
- **tracing_on:** Enable/disable tracing
- **set_ftrace_filter:** Filter functions to trace
- **set_ftrace_notrace:** Exclude functions from tracing
- **trace_pipe:** Streaming trace output

**File Usage:**
```bash
# Read trace output
cat /sys/kernel/debug/tracing/trace

# Set tracer type
echo function > /sys/kernel/debug/tracing/current_tracer

# Enable tracing
echo 1 > /sys/kernel/debug/tracing/tracing_on

# Disable tracing
echo 0 > /sys/kernel/debug/tracing/tracing_on
```

### Tracing Modes

#### Function Tracer

**Function Tracer:**
- Traces all function calls
- Function entry/exit
- Function call graph
- Function timing

**Enabling Function Tracer:**
```bash
# Set function tracer
echo function > /sys/kernel/debug/tracing/current_tracer

# Enable tracing
echo 1 > /sys/kernel/debug/tracing/tracing_on

# ... run workload ...

# Disable tracing
echo 0 > /sys/kernel/debug/tracing/tracing_on

# View trace
cat /sys/kernel/debug/tracing/trace
```

#### Function Graph Tracer

**Function Graph Tracer:**
- Shows function call graph
- Function entry and exit
- Nested function calls
- Call depth

**Enabling Function Graph Tracer:**
```bash
# Set function graph tracer
echo function_graph > /sys/kernel/debug/tracing/current_tracer

# Enable tracing
echo 1 > /sys/kernel/debug/tracing/tracing_on

# ... run workload ...

# Disable tracing
echo 0 > /sys/kernel/debug/tracing/tracing_on

# View trace
cat /sys/kernel/debug/tracing/trace
```

#### Event Tracer

**Event Tracer:**
- Traces kernel events
- Predefined events
- Event-specific data
- Lower overhead

**Enabling Event Tracer:**
```bash
# Enable specific event
echo 1 > /sys/kernel/debug/tracing/events/sched/sched_switch/enable

# Enable all scheduler events
echo 1 > /sys/kernel/debug/tracing/events/sched/enable

# Enable tracing
echo 1 > /sys/kernel/debug/tracing/tracing_on

# ... run workload ...

# Disable tracing
echo 0 > /sys/kernel/debug/tracing/tracing_on

# View trace
cat /sys/kernel/debug/tracing/trace
```

### Function Filtering

#### Filtering Functions

**Function Filtering:**
- Filter specific functions
- Exclude functions
- Pattern matching
- Wildcard support

**Filter Examples:**
```bash
# Trace specific function
echo sys_read > /sys/kernel/debug/tracing/set_ftrace_filter

# Trace multiple functions
echo "sys_read sys_write" > /sys/kernel/debug/tracing/set_ftrace_filter

# Exclude functions
echo sys_read > /sys/kernel/debug/tracing/set_ftrace_notrace

# Pattern matching
echo "sys_*" > /sys/kernel/debug/tracing/set_ftrace_filter
```

#### Filtering by Module

**Module Filtering:**
- Filter by kernel module
- Module-specific functions
- Module boundaries
- Module loading/unloading

**Module Filter Example:**
```bash
# Filter by module
echo ":mod:my_module" > /sys/kernel/debug/tracing/set_ftrace_filter
```

### Event Tracing

#### Available Events

**Available Events:**
- Scheduler events
- Power management events
- Interrupt events
- I/O events
- Memory events

**Event Categories:**
- **sched:** Scheduler events
- **power:** Power management
- **irq:** Interrupt events
- **i2c:** I2C bus events
- **mmc:** MMC/SD card events
- **binder:** Binder IPC events

#### Enabling Events

**Enabling Events:**
```bash
# List available events
ls /sys/kernel/debug/tracing/events/

# List events in category
ls /sys/kernel/debug/tracing/events/sched/

# Enable specific event
echo 1 > /sys/kernel/debug/tracing/events/sched/sched_switch/enable

# Enable all events in category
echo 1 > /sys/kernel/debug/tracing/events/sched/enable

# Enable all events
echo 1 > /sys/kernel/debug/tracing/events/enable
```

### ftrace Usage

#### Basic Usage Workflow

**Basic Workflow:**
```
1. Set tracer type
2. Configure filters (optional)
3. Enable tracing
4. Run workload
5. Disable tracing
6. View trace output
7. Analyze results
```

**Example:**
```bash
# Set function graph tracer
echo function_graph > /sys/kernel/debug/tracing/current_tracer

# Filter specific function
echo sys_read > /sys/kernel/debug/tracing/set_ftrace_filter

# Enable tracing
echo 1 > /sys/kernel/debug/tracing/tracing_on

# Run workload
# ... perform operation ...

# Disable tracing
echo 0 > /sys/kernel/debug/tracing/tracing_on

# View trace
cat /sys/kernel/debug/tracing/trace
```

#### Trace Output

**Trace Output Format:**
```
# tracer: function_graph
#
# CPU  DURATION                  FUNCTION CALLS
# |     |   |                     |   |   |   |
 0)               |  sys_read() {
 0)               |    vfs_read() {
 0)   0.123 us    |      file_read() {
 0)   0.456 us    |        do_sync_read();
 0)   1.234 us    |      }
 0)   2.345 us    |    }
 0)   3.456 us    |  }
```

**Output Interpretation:**
- **CPU:** CPU core number
- **DURATION:** Function execution time
- **FUNCTION CALLS:** Function call hierarchy
- **Indentation:** Call depth

### Advanced ftrace Features

#### Trace Options

**Trace Options:**
- Function stack traces
- Function call counts
- Latency measurements
- Graph options

**Option Configuration:**
```bash
# Enable function stack traces
echo 1 > /sys/kernel/debug/tracing/options/func_stack_trace

# Enable function call counts
echo 1 > /sys/kernel/debug/tracing/options/funcgraph-abstime

# Enable latency measurements
echo 1 > /sys/kernel/debug/tracing/options/latency-format
```

#### Trace Buffer Management

**Buffer Management:**
- Buffer size configuration
- Buffer clearing
- Buffer wrapping
- Multiple buffers

**Buffer Commands:**
```bash
# Set buffer size
echo 16384 > /sys/kernel/debug/tracing/buffer_size_kb

# Clear buffer
echo > /sys/kernel/debug/tracing/trace

# Check buffer size
cat /sys/kernel/debug/tracing/buffer_size_kb
```

### ftrace Integration

#### Integration with Perfetto

**Perfetto Integration:**
- ftrace events in Perfetto
- Unified tracing
- Better visualization
- Combined analysis

**Using ftrace with Perfetto:**
```bash
# Perfetto uses ftrace internally
adb shell perfetto -t 10s -o /data/misc/perfetto-traces/trace.pb \
  -c - <<EOF
data_sources: {
    config {
        name: "linux.ftrace"
        ftrace_config {
            ftrace_events: "sched/sched_switch"
            ftrace_events: "sched/sched_wakeup"
        }
    }
}
EOF
```

### Debugging with ftrace

#### Common Debugging Scenarios

**Scenario 1: Kernel Function Calls**
```bash
# Trace specific kernel function
echo my_kernel_function > /sys/kernel/debug/tracing/set_ftrace_filter
echo function_graph > /sys/kernel/debug/tracing/current_tracer
echo 1 > /sys/kernel/debug/tracing/tracing_on
# ... trigger operation ...
echo 0 > /sys/kernel/debug/tracing/tracing_on
cat /sys/kernel/debug/tracing/trace
```

**Scenario 2: Scheduler Behavior**
```bash
# Enable scheduler events
echo 1 > /sys/kernel/debug/tracing/events/sched/enable
echo 1 > /sys/kernel/debug/tracing/tracing_on
# ... run workload ...
echo 0 > /sys/kernel/debug/tracing/tracing_on
cat /sys/kernel/debug/tracing/trace
```

**Scenario 3: Power Management**
```bash
# Enable power events
echo 1 > /sys/kernel/debug/tracing/events/power/enable
echo 1 > /sys/kernel/debug/tracing/tracing_on
# ... trigger power state change ...
echo 0 > /sys/kernel/debug/tracing/tracing_on
cat /sys/kernel/debug/tracing/trace
```

### ftrace Best Practices

#### Best Practices

**Best Practices:**
- Use specific filters
- Keep trace duration short
- Clear buffer before tracing
- Use appropriate tracer type
- Analyze systematically

**Practice Guidelines:**
- **Specific Filters:** Use specific function filters
- **Short Duration:** Keep trace duration short
- **Clear Buffer:** Clear buffer before tracing
- **Appropriate Tracer:** Use appropriate tracer type
- **Systematic Analysis:** Analyze traces systematically

## Key Takeaways

1. **ftrace** is a Linux kernel function tracer that provides detailed tracing of kernel function calls, kernel events, and system behavior, built into the Linux kernel.

2. **ftrace interface** includes debug filesystem (located at `/sys/kernel/debug/tracing`, contains ftrace control files), key files (trace, current_tracer, tracing_on, set_ftrace_filter, set_ftrace_notrace, trace_pipe), and interface usage.

3. **Tracing modes** include function tracer (traces all function calls, function entry/exit, function call graph), function graph tracer (shows function call graph, nested function calls, call depth), event tracer (traces kernel events, predefined events, event-specific data), and tracer usage.

4. **Function filtering** includes filtering functions (filter specific functions, exclude functions, pattern matching, wildcard support), filtering by module (filter by kernel module, module-specific functions), and filter examples.

5. **Event tracing** includes available events (scheduler events, power management events, interrupt events, I/O events, memory events), event categories (sched, power, irq, i2c, mmc, binder), enabling events (list available events, enable specific event, enable all events in category), and event usage.

6. **ftrace usage** includes basic usage workflow (set tracer type, configure filters, enable tracing, run workload, disable tracing, view trace output), trace output (trace output format, output interpretation), and usage examples.

7. **Advanced ftrace features** include trace options (function stack traces, function call counts, latency measurements, graph options), trace buffer management (buffer size configuration, buffer clearing, buffer wrapping), and advanced usage.

8. **ftrace integration** includes integration with Perfetto (ftrace events in Perfetto, unified tracing, better visualization), and integration examples.

9. **Understanding ftrace** is essential for AOSP development, enabling kernel debugging, performance analysis, system understanding, and proper ftrace usage.

## Related Topics

- **systrace & perfetto:** System tracing details
- **atrace:** Application tracing details
- **binder tracing:** Binder IPC tracing details

