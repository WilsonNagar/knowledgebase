---
number: 46
title: 'Device Tree (DT, DTB, DTBO)'
slug: device-tree-dt-dtb-dtbo
level: beginner
tags:
  - aosp
  - device-tree
  - dtb
  - dtbo
  - hardware
  - kernel
  - boot
prerequisites:
  - building-the-kernel
  - bootloader-and-fastboot
  - boot-partitions
estimated_minutes: 85
contributors: []
diagrams: []
examples: []
canonical_id: aosp-beginner-46
---

# Device Tree (DT, DTB, DTBO)

## Overview

Device Tree is a data structure that describes hardware configuration to the kernel, allowing a single kernel binary to support multiple hardware platforms without recompilation. Understanding Device Tree is essential for AOSP development, as it's how Android kernels discover hardware, configure devices, and support multiple device variants. This guide provides a comprehensive overview of Device Tree, Device Tree Source (DTS), Device Tree Blob (DTB), Device Tree Overlays (DTBO), and how they're used in Android.

Think of Device Tree like a hardware blueprint: just as an architect's blueprint describes a building's structure (rooms, doors, windows, electrical), Device Tree describes a device's hardware structure (CPUs, memory, peripherals, interrupts). The kernel reads this blueprint at boot time to understand what hardware exists and how to configure it, enabling one kernel to work with many different devices.

## Deep Explanation

### What is Device Tree?

Device Tree is a data structure that describes the hardware configuration of a system. It's passed from the bootloader to the kernel and allows the kernel to discover and configure hardware without hardcoded information.

**Key Characteristics:**
- **Hardware Description:** Describes all hardware
- **Boot-Time Configuration:** Passed at boot
- **Platform-Agnostic:** Same kernel for multiple devices
- **Hierarchical:** Tree structure

**Why Device Tree?**
- **Flexibility:** One kernel, many devices
- **Maintainability:** Hardware changes don't require kernel rebuild
- **Standardization:** Industry-standard format
- **Modularity:** Overlays for variants

### Device Tree Components

#### Device Tree Source (DTS)

**DTS Files:**
- Human-readable text format
- Describes hardware in tree structure
- Compiled to binary format (DTB)
- Located in kernel source tree

**Location:**
```
arch/<arch>/boot/dts/
arch/<arch>/boot/dts/<vendor>/
```

**Example:**
```
arch/arm64/boot/dts/qcom/sdm845.dts
arch/arm64/boot/dts/samsung/exynos9810.dts
```

#### Device Tree Blob (DTB)

**DTB Files:**
- Binary format (compiled from DTS)
- Loaded by bootloader
- Passed to kernel
- Efficient parsing

**Compilation:**
```bash
dtc -I dts -O dtb -o device.dtb device.dts
```

**Or from kernel build:**
```bash
make ARCH=arm64 dtbs
```

**Output:**
- `*.dtb` files in `arch/<arch>/boot/dts/`
- Device-specific binaries
- Ready for bootloader

#### Device Tree Overlay (DTBO)

**DTBO Files:**
- Additional hardware configuration
- Applied on top of base DTB
- Enables hardware variants
- Stored in `dtbo` partition

**Purpose:**
- Support multiple hardware variants
- Update hardware config without kernel change
- Modular hardware configuration
- Device-specific customization

**Location:**
- `dtbo` partition on device
- Applied by bootloader
- Merged with base DTB at boot

### Device Tree Structure

#### Basic Tree Structure

**Hierarchical Format:**
```dts
/ {
    compatible = "vendor,device";
    
    cpus {
        cpu@0 {
            compatible = "arm,cortex-a53";
            device_type = "cpu";
        };
    };
    
    memory@80000000 {
        device_type = "memory";
        reg = <0x80000000 0x40000000>;
    };
    
    serial@12340000 {
        compatible = "vendor,serial";
        reg = <0x12340000 0x1000>;
        interrupts = <0 10 4>;
    };
};
```

**Key Elements:**
- `/` - Root node
- `compatible` - Device compatibility
- `reg` - Register addresses
- `interrupts` - Interrupt specifications

#### Node Properties

**Standard Properties:**
```dts
compatible = "vendor,device-model";
model = "Device Name";
reg = <address size>;
interrupts = <irq type level>;
clocks = <&clock_ref>;
status = "okay";
```

**Property Types:**
- **Strings:** `"value"`
- **Integers:** `<0x12345678>`
- **Arrays:** `<1 2 3>`
- **Phandles:** `<&reference>`
- **Strings List:** `"first", "second"`

#### Device Tree Syntax

**Node Definition:**
```dts
node-name@address {
    property = value;
    child-node {
        property = value;
    };
};
```

**Labels and References:**
```dts
clock_ref: clock@12340000 {
    compatible = "vendor,clock";
    reg = <0x12340000 0x1000>;
};

device@56780000 {
    clocks = <&clock_ref>;
};
```

### Device Tree in Android

#### Android Device Tree Location

**Kernel Source:**
```
arch/<arch>/boot/dts/
arch/<arch>/boot/dts/<vendor>/
```

**AOSP Integration:**
- Device trees in kernel source
- Vendor-specific trees
- Device-specific configurations
- Build system integration

#### Android Device Tree Example

**Basic Android Device Tree:**
```dts
/dts-v1/;

/ {
    model = "Android Device";
    compatible = "vendor,device", "vendor,platform";
    
    chosen {
        bootargs = "console=ttyMSM0,115200 androidboot.serialno=ABC123";
    };
    
    memory@80000000 {
        device_type = "memory";
        reg = <0x80000000 0x40000000>;
    };
    
    cpus {
        #address-cells = <2>;
        #size-cells = <0>;
        
        cpu@0 {
            device_type = "cpu";
            compatible = "arm,cortex-a53";
            reg = <0x0 0x0>;
        };
    };
};
```

#### Android-Specific Properties

**Android Properties:**
```dts
/ {
    android {
        vbmeta {
            status = "okay";
        };
        
        fstab {
            compatible = "android,fstab";
            vendor {
                compatible = "android,vendor";
                dev = "/dev/block/platform/soc/1d84000.ufshc/by-name/vendor";
                type = "ext4";
                mnt_flags = "ro,barrier=1";
                fsmgr_flags = "wait";
            };
        };
    };
};
```

### Device Tree Compilation

#### Compiling DTS to DTB

**Using dtc (Device Tree Compiler):**
```bash
dtc -I dts -O dtb -o output.dtb input.dts
```

**Options:**
- `-I dts` - Input format (DTS)
- `-O dtb` - Output format (DTB)
- `-o` - Output file
- `-@` - Generate symbols

**From Kernel Build:**
```bash
cd kernel/
make ARCH=arm64 dtbs
```

**Output:**
- Compiled DTB files
- In `arch/arm64/boot/dts/`
- Device-specific binaries

#### Decompiling DTB to DTS

**Extract DTS from DTB:**
```bash
dtc -I dtb -O dts -o output.dts input.dtb
```

**Use Cases:**
- Analyze existing device tree
- Debug device tree issues
- Understand hardware configuration
- Reverse engineering

### Device Tree Overlays (DTBO)

#### What are DTBOs?

**Device Tree Overlays:**
- Additional device tree fragments
- Applied on top of base DTB
- Enable hardware variants
- Stored in `dtbo` partition

**Purpose:**
- Support multiple hardware variants
- Update without kernel change
- Modular configuration
- Device customization

#### DTBO Structure

**Overlay Format:**
```dts
/dts-v1/;
/plugin/;

&target-node {
    new-property = "value";
    new-child {
        property = "value";
    };
};
```

**Overlay Application:**
1. Bootloader loads base DTB
2. Bootloader loads DTBO from `dtbo` partition
3. Overlay applied to base DTB
4. Merged DTB passed to kernel

#### DTBO Partition

**Location:**
- `dtbo` partition on device
- Separate from boot partition
- Can be updated independently
- Multiple overlays possible

**Access:**
```bash
# View DTBO partition
ls -la /dev/block/bootdevice/by-name/dtbo

# Extract DTBO
dd if=/dev/block/bootdevice/by-name/dtbo of=/sdcard/dtbo.img
```

### Device Tree Usage

#### Boot Process

**Device Tree Loading:**
1. Bootloader reads DTB from boot image or partition
2. Bootloader loads DTBO (if present)
3. Overlay applied to base DTB
4. Merged DTB loaded into memory
5. DTB address passed to kernel
6. Kernel parses DTB
7. Kernel discovers and configures hardware

#### Kernel Parsing

**Early Boot:**
- Kernel parses DTB early in boot
- Discovers hardware
- Configures devices
- Sets up memory map

**Device Registration:**
- Kernel matches devices to drivers
- Uses `compatible` property
- Registers devices
- Initializes drivers

### Common Device Tree Nodes

#### CPU Node

**CPU Configuration:**
```dts
cpus {
    #address-cells = <2>;
    #size-cells = <0>;
    
    cpu@0 {
        device_type = "cpu";
        compatible = "arm,cortex-a53";
        reg = <0x0 0x0>;
        enable-method = "psci";
    };
    
    cpu@1 {
        device_type = "cpu";
        compatible = "arm,cortex-a53";
        reg = <0x0 0x1>;
        enable-method = "psci";
    };
};
```

#### Memory Node

**Memory Configuration:**
```dts
memory@80000000 {
    device_type = "memory";
    reg = <0x80000000 0x40000000>;  /* 1GB at 0x80000000 */
};

memory@c0000000 {
    device_type = "memory";
    reg = <0xc0000000 0x40000000>;  /* 1GB at 0xc0000000 */
};
```

#### Serial/UART Node

**Serial Port:**
```dts
serial@12340000 {
    compatible = "vendor,serial";
    reg = <0x12340000 0x1000>;
    interrupts = <0 10 4>;
    clocks = <&uart_clock>;
    status = "okay";
};
```

#### GPIO Node

**GPIO Configuration:**
```dts
gpio@12350000 {
    compatible = "vendor,gpio";
    reg = <0x12350000 0x1000>;
    interrupts = <0 11 4>;
    gpio-controller;
    #gpio-cells = <2>;
};
```

#### I2C Node

**I2C Bus:**
```dts
i2c@12360000 {
    compatible = "vendor,i2c";
    reg = <0x12360000 0x1000>;
    interrupts = <0 12 4>;
    clocks = <&i2c_clock>;
    
    sensor@48 {
        compatible = "vendor,sensor";
        reg = <0x48>;
    };
};
```

### Device Tree Best Practices

#### Organization

**File Structure:**
- One DTS file per device
- Include common files
- Use labels for references
- Document properties

**Naming:**
- Descriptive node names
- Consistent property names
- Clear compatible strings
- Standard conventions

#### Compatibility

**Compatible Strings:**
```dts
compatible = "vendor,device-model", "vendor,platform", "generic-type";
```

**Format:**
- Most specific first
- Platform-specific
- Generic fallback
- Driver matching

#### Documentation

**Comments:**
```dts
/*
 * Device Tree for Android Device
 * Hardware: Vendor Platform
 * Revision: 1.0
 */

// CPU configuration
cpus {
    // ...
};
```

**Property Documentation:**
- Document custom properties
- Explain hardware-specific settings
- Note requirements
- Reference specifications

### Device Tree Debugging

#### Viewing Device Tree

**From Running System:**
```bash
# View device tree
ls /proc/device-tree/

# View specific node
cat /proc/device-tree/compatible

# View property
cat /proc/device-tree/memory@80000000/reg
```

**From Boot Image:**
```bash
# Extract DTB from boot image
unpackbootimg -i boot.img -o output/
dtc -I dtb -O dts -o device.dts output/boot.img-dtb
```

#### Common Issues

**Device Not Detected:**
- Check compatible string
- Verify driver exists
- Check device tree node
- Review kernel logs

**Hardware Misconfiguration:**
- Verify register addresses
- Check interrupt numbers
- Validate clock references
- Review hardware spec

**Boot Failures:**
- Check device tree syntax
- Verify DTB compilation
- Review bootloader logs
- Check kernel messages

### Integration with Android Build

#### Build System Integration

**BoardConfig.mk:**
```makefile
TARGET_KERNEL_ARCH := arm64
TARGET_KERNEL_SOURCE := kernel/vendor/device
TARGET_KERNEL_CONFIG := defconfig
```

**Build Process:**
1. Build system reads BoardConfig
2. Builds kernel with device tree
3. Compiles DTS to DTB
4. Packages in boot image
5. Includes in system build

#### Device Tree in Boot Image

**Boot Image Format:**
- Kernel image
- Ramdisk
- Device tree (DTB)
- Command line

**mkbootimg:**
```bash
mkbootimg \
    --kernel Image \
    --ramdisk initramfs.cpio.gz \
    --dtb device.dtb \
    --output boot.img
```

## Key Takeaways

1. **Device Tree describes hardware configuration** to the kernel, enabling one kernel to support multiple devices.

2. **Device Tree Source (DTS)** is human-readable text that gets compiled to binary Device Tree Blob (DTB).

3. **Device Tree Blob (DTB)** is the binary format loaded by the bootloader and passed to the kernel.

4. **Device Tree Overlays (DTBO)** are additional configurations applied on top of base DTB to support hardware variants.

5. **Device Tree uses a hierarchical tree structure** with nodes representing hardware components and properties describing their configuration.

6. **Android uses Device Tree** for hardware discovery, device configuration, and supporting multiple device variants.

7. **Device Tree is compiled from DTS to DTB** using the Device Tree Compiler (dtc) and integrated into boot images.

8. **Understanding Device Tree** is essential for device porting, hardware configuration, kernel development, and AOSP customization.

## Related Topics

- **Building the kernel:** How device trees are compiled and included in kernel builds
- **Bootloader and Fastboot:** How bootloader loads and passes device tree to kernel
- **Boot Partitions:** How device tree is stored in boot images and dtbo partition
- **Kernel boot arguments:** How device tree properties affect kernel behavior

