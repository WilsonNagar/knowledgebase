---
number: 40
title: 'ashmem, ion, dma-buf'
slug: ashmem-ion-dma-buf
level: beginner
tags:
  - aosp
  - ashmem
  - ion
  - dma-buf
  - memory
  - allocator
  - shared-memory
  - graphics
prerequisites:
  - differences-android-kernel-linux-kernel
  - android-architecture-complete-overview
estimated_minutes: 90
contributors: []
diagrams: []
examples: []
canonical_id: aosp-beginner-40
---

# ashmem, ion, dma-buf

## Overview

ashmem (Android Shared Memory), ION (Input/Output Memory Manager), and dma-buf (DMA Buffer Sharing) are Android's memory allocation and sharing mechanisms for graphics, media, and hardware-accelerated operations. Understanding these memory allocators is essential for AOSP development, as they're critical for graphics rendering, media processing, camera operations, and efficient memory sharing between processes and hardware. This guide provides a comprehensive overview of ashmem, ION, and dma-buf, their purposes, how they work, and when to use each.

Think of these memory allocators like different types of storage facilities: ashmem is like a shared warehouse where multiple tenants (processes) can access the same storage space, ION is like a specialized storage facility optimized for specific types of goods (graphics, media), and dma-buf is like a high-speed delivery system that allows hardware to directly access memory without going through the CPU. Each serves a specific purpose in Android's memory management ecosystem.

## Deep Explanation

### What are ashmem, ION, and dma-buf?

These are three different memory allocation and sharing mechanisms used in Android for different purposes:

**ashmem (Android Shared Memory):**
- Shared memory allocator
- Process-to-process sharing
- Garbage-collected
- Android-specific

**ION (Input/Output Memory Manager):**
- Unified memory allocator
- Hardware-accessible memory
- Graphics and media optimized
- Replaces PMEM

**dma-buf (DMA Buffer Sharing):**
- Standard Linux mechanism
- Hardware buffer sharing
- Cross-driver sharing
- Zero-copy transfers

### ashmem (Android Shared Memory)

#### What is ashmem?

ashmem is Android's shared memory allocator that allows multiple processes to share memory regions efficiently. It's designed specifically for Android's use cases and provides better performance than standard Linux shared memory.

**Key Characteristics:**
- **Shared Memory:** Multiple processes can access
- **Garbage Collected:** Automatically cleaned up
- **Android-Specific:** Not in mainline Linux
- **Efficient:** Optimized for Android

**Why ashmem?**
- **Performance:** Better than standard shared memory
- **Garbage Collection:** Automatic cleanup
- **Android-Optimized:** Designed for Android
- **Graphics:** Used by graphics system

#### ashmem Features

**Pin/Unpin:**
- Memory can be pinned
- Prevents garbage collection
- Unpinned when done
- Automatic management

**Garbage Collection:**
- Unpinned memory collected
- Automatic cleanup
- Prevents leaks
- Efficient memory use

**Sharing:**
- Multiple processes
- Efficient sharing
- Process isolation
- Security maintained

#### ashmem Usage

**Kernel Interface:**
```c
// Open ashmem device
int fd = open("/dev/ashmem", O_RDWR);

// Set name
ioctl(fd, ASHMEM_SET_NAME, "my_shared_mem");

// Set size
ioctl(fd, ASHMEM_SET_SIZE, size);

// Map memory
void *ptr = mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
```

**User-Space API:**
- Open `/dev/ashmem`
- Set name and size
- Map into process
- Share file descriptor

#### ashmem Use Cases

**Graphics:**
- Surface buffers
- Texture data
- Graphics memory
- Display buffers

**Media:**
- Video frames
- Audio buffers
- Media processing
- Codec buffers

**Binder:**
- Large Binder transactions
- Shared data
- Efficient IPC
- Performance

### ION (Input/Output Memory Manager)

#### What is ION?

ION is Android's unified memory allocator that provides hardware-accessible memory for graphics, media, camera, and other hardware-accelerated operations. It replaced the older PMEM allocator and provides a more flexible and efficient memory management system.

**Key Characteristics:**
- **Unified Interface:** Single allocator for multiple uses
- **Hardware-Accessible:** Memory accessible by hardware
- **Multiple Heaps:** Different memory pools
- **Android-Specific:** Not in mainline Linux

**Why ION?**
- **Hardware Access:** Graphics/media need hardware access
- **Unified:** Single interface for all needs
- **Flexible:** Multiple heap types
- **Performance:** Optimized for hardware

#### ION Heaps

**System Heap:**
- General-purpose memory
- CPU-accessible
- Standard allocations
- Common use

**System Contiguous Heap:**
- Physically contiguous
- Hardware requirements
- Limited availability
- Special cases

**Carveout Heap:**
- Reserved memory region
- Hardware-specific
- Pre-allocated
- Device-specific

**DMA Heap:**
- DMA-accessible
- Hardware DMA
- Scatter-gather
- Modern devices

#### ION Usage

**Kernel Interface:**
```c
// ION client
struct ion_client *client = ion_client_create(ion_dev);

// Allocate buffer
struct ion_handle *handle = ion_alloc(client, size, align, heap_mask, flags);

// Map buffer
void *vaddr = ion_map_kernel(client, handle);

// Share buffer
int fd = ion_share(client, handle);
```

**User-Space API:**
- Open ION device
- Allocate from heap
- Map into process
- Share with hardware

#### ION Use Cases

**Graphics:**
- Frame buffers
- Texture memory
- GPU memory
- Display buffers

**Media:**
- Video buffers
- Camera buffers
- Codec memory
- Media processing

**Camera:**
- Image buffers
- Preview buffers
- Capture buffers
- Camera memory

### dma-buf (DMA Buffer Sharing)

#### What is dma-buf?

dma-buf is a Linux kernel framework for sharing buffers between device drivers. It's a standard Linux mechanism (not Android-specific) that allows efficient zero-copy buffer sharing between drivers and hardware.

**Key Characteristics:**
- **Standard Linux:** Mainline Linux feature
- **Cross-Driver:** Share between drivers
- **Zero-Copy:** Efficient transfers
- **Hardware Access:** Direct hardware access

**Why dma-buf?**
- **Efficiency:** Zero-copy transfers
- **Standard:** Linux standard mechanism
- **Flexibility:** Works with any driver
- **Performance:** Optimal performance

#### dma-buf Features

**Buffer Sharing:**
- Share between drivers
- Cross-device sharing
- Efficient mechanism
- Standard interface

**Zero-Copy:**
- No data copying
- Direct access
- Maximum efficiency
- Performance optimized

**Synchronization:**
- Fence mechanism
- Synchronization primitives
- Access control
- Safe sharing

#### dma-buf Usage

**Kernel Interface:**
```c
// Export buffer
struct dma_buf *dmabuf = dma_buf_export(&exp_info);

// Import buffer
struct dma_buf_attachment *attach = dma_buf_attach(dmabuf, dev);

// Map for DMA
struct sg_table *sg = dma_buf_map_attachment(attach, direction);
```

**User-Space:**
- File descriptor based
- Share via file descriptor
- Standard mechanism
- Cross-process sharing

#### dma-buf Use Cases

**Graphics:**
- GPU buffers
- Display buffers
- Texture sharing
- Graphics memory

**Media:**
- Video buffers
- Codec buffers
- Media processing
- Hardware acceleration

**Camera:**
- Image buffers
- Camera memory
- ISP buffers
- Sensor data

### Comparison of Memory Allocators

#### ashmem vs ION vs dma-buf

**ashmem:**
- **Purpose:** Process-to-process sharing
- **Scope:** Android-specific
- **Use:** General shared memory
- **Hardware:** Not hardware-accessible

**ION:**
- **Purpose:** Hardware-accessible memory
- **Scope:** Android-specific
- **Use:** Graphics, media, camera
- **Hardware:** Hardware-accessible

**dma-buf:**
- **Purpose:** Cross-driver buffer sharing
- **Scope:** Standard Linux
- **Use:** Driver-to-driver sharing
- **Hardware:** Hardware-accessible

#### When to Use Each

**Use ashmem when:**
- Process-to-process sharing needed
- General shared memory
- Graphics surfaces
- Binder large transactions

**Use ION when:**
- Hardware-accessible memory needed
- Graphics buffers
- Media processing
- Camera operations

**Use dma-buf when:**
- Cross-driver sharing
- Standard Linux compatibility
- Modern devices
- Zero-copy needed

### Memory Allocation Flow

#### ashmem Flow

**Allocation:**
1. Open `/dev/ashmem`
2. Set name and size
3. Map into process
4. Share file descriptor

**Sharing:**
1. Process A creates ashmem
2. Shares file descriptor with Process B
3. Process B maps same memory
4. Both access shared memory

#### ION Flow

**Allocation:**
1. Create ION client
2. Allocate from heap
3. Map into process
4. Share with hardware

**Hardware Access:**
1. Allocate ION buffer
2. Get physical address
3. Program hardware
4. Hardware accesses directly

#### dma-buf Flow

**Export:**
1. Driver exports buffer
2. Creates dma-buf
3. Returns file descriptor
4. Share with other drivers

**Import:**
1. Driver imports dma-buf
2. Attaches to device
3. Maps for DMA
4. Accesses buffer

### Integration with Android

#### Graphics Integration

**SurfaceFlinger:**
- Uses ION for buffers
- Graphics memory
- Display buffers
- GPU memory

**HWUI:**
- Uses ION/dma-buf
- Rendering buffers
- Texture memory
- Graphics operations

#### Media Integration

**Media Framework:**
- Uses ION for buffers
- Video frames
- Audio buffers
- Codec memory

**Camera:**
- Uses ION extensively
- Image buffers
- Preview buffers
- Camera memory

### Memory Management

#### Lifecycle Management

**ashmem:**
- Garbage collected
- Automatic cleanup
- Pin/unpin mechanism
- Process-managed

**ION:**
- Reference counted
- Explicit free
- Client-managed
- Handle-based

**dma-buf:**
- Reference counted
- Export/import model
- Driver-managed
- File descriptor based

#### Security Considerations

**Process Isolation:**
- Memory isolated
- Access control
- Permission checks
- Security boundaries

**Hardware Access:**
- Controlled access
- Permission validation
- Secure sharing
- Hardware protection

### Performance Considerations

#### Efficiency

**ashmem:**
- Efficient sharing
- Low overhead
- Good for general use
- Process-to-process

**ION:**
- Hardware-optimized
- Direct hardware access
- Efficient for graphics/media
- Hardware-accelerated

**dma-buf:**
- Zero-copy transfers
- Maximum efficiency
- Cross-driver optimized
- Standard mechanism

#### Optimization

**Memory Pools:**
- Pre-allocated pools
- Reduce allocation overhead
- Faster allocation
- Better performance

**Caching:**
- Buffer caching
- Reuse buffers
- Reduce allocations
- Performance improvement

### Evolution and Migration

#### Historical Context

**PMEM (Legacy):**
- Old Android allocator
- Replaced by ION
- Less flexible
- Deprecated

**ION (Current):**
- Modern allocator
- Replaces PMEM
- More flexible
- Better performance

**dma-buf (Future):**
- Standard Linux
- Cross-platform
- Modern approach
- Industry standard

#### Migration Path

**From PMEM to ION:**
- ION replaces PMEM
- Better features
- More flexible
- Improved performance

**ION to dma-buf:**
- dma-buf complements ION
- Standard mechanism
- Cross-platform
- Future direction

## Key Takeaways

1. **ashmem is Android's shared memory allocator** for process-to-process memory sharing with automatic garbage collection.

2. **ION is Android's unified memory allocator** for hardware-accessible memory used by graphics, media, and camera systems.

3. **dma-buf is a standard Linux mechanism** for cross-driver buffer sharing with zero-copy transfers.

4. **Each allocator serves different purposes:** ashmem for general sharing, ION for hardware-accessible memory, dma-buf for cross-driver sharing.

5. **ION replaced PMEM** as the primary allocator for graphics and media operations in modern Android.

6. **dma-buf provides zero-copy transfers** and is becoming the standard for buffer sharing in modern Linux and Android systems.

7. **These allocators are critical** for graphics rendering, media processing, camera operations, and efficient memory management in Android.

8. **Understanding ashmem, ION, and dma-buf** is essential for AOSP development, graphics system work, and hardware integration.

## Related Topics

- **Differences between Android kernel & Linux kernel:** How these allocators are Android-specific kernel features
- **Android Architecture - Complete Overview:** How memory allocators fit into Android architecture
- **Binder IPC Basics:** How ashmem is used for large Binder transactions
- **Graphics Pipeline:** How ION and dma-buf are used for graphics operations

