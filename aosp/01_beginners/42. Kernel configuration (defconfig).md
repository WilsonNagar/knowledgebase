---
number: 42
title: Kernel configuration (defconfig)
slug: kernel-configuration-defconfig
level: beginner
tags:
  - aosp
  - kernel
  - defconfig
  - configuration
  - kconfig
  - build-config
prerequisites:
  - kernel-modules
  - differences-android-kernel-linux-kernel
  - boardconfig
estimated_minutes: 85
contributors: []
diagrams: []
examples: []
canonical_id: aosp-beginner-42
---

# Kernel configuration (defconfig)

## Overview

Kernel configuration (defconfig) is the process of selecting which kernel features, drivers, and options are compiled into the kernel. Understanding kernel configuration is essential for AOSP development, as it determines what hardware is supported, what features are available, and how the kernel is optimized for a specific device. This guide provides a comprehensive overview of kernel configuration, defconfig files, the Kconfig system, and how to configure the Android kernel for your device.

Think of kernel configuration like building a custom car: you start with a base model (the kernel source), and then you select which features you want (drivers, file systems, protocols) and which you don't need (unused drivers, unnecessary features). The defconfig file is like your order sheet that specifies exactly what goes into your custom kernel build. This determines the final kernel's size, capabilities, and compatibility with your hardware.

## Deep Explanation

### What is Kernel Configuration?

Kernel configuration is the process of selecting kernel features, drivers, and build options that will be compiled into the kernel. The configuration is stored in a defconfig file and determines what the kernel can do, what hardware it supports, and how it's optimized.

**Key Characteristics:**
- **Feature Selection:** Choose what to include
- **Driver Selection:** Select hardware drivers
- **Optimization:** Configure for specific hardware
- **Device-Specific:** Tailored to each device

**Why Configure the Kernel?**
- **Size:** Smaller kernel = faster boot
- **Features:** Only include what's needed
- **Hardware:** Support specific devices
- **Performance:** Optimize for target hardware

### Kernel Configuration System (Kconfig)

#### What is Kconfig?

Kconfig is the kernel's configuration system that allows selecting features and options. It provides a menu-driven interface and generates configuration files.

**Key Components:**
- **Kconfig Files:** Define options
- **Menuconfig:** Interactive configuration
- **defconfig:** Saved configuration
- **.config:** Active configuration

**Kconfig Features:**
- **Hierarchical:** Options organized in menus
- **Dependencies:** Options depend on others
- **Validation:** Checks for conflicts
- **Documentation:** Built-in help

#### Kconfig Syntax

**Basic Option:**
```
config FEATURE_NAME
    bool "Feature Description"
    default y
    help
        This feature does something useful.
```

**Option Types:**
- `bool` - Boolean (yes/no)
- `tristate` - Yes/No/Module
- `int` - Integer value
- `string` - String value
- `hex` - Hexadecimal value

**Dependencies:**
```
config FEATURE_B
    bool "Feature B"
    depends on FEATURE_A
    help
        Feature B requires Feature A.
```

**Selects:**
```
config FEATURE_A
    bool "Feature A"
    select FEATURE_B
    help
        Feature A automatically enables Feature B.
```

### defconfig Files

#### What is a defconfig?

A defconfig (default configuration) is a minimal kernel configuration file that contains only the non-default options. It's the starting point for kernel configuration and is device-specific.

**Key Characteristics:**
- **Minimal:** Only non-default options
- **Device-Specific:** Tailored to hardware
- **Starting Point:** Base configuration
- **Versioned:** Tied to kernel version

**defconfig Location:**
```
arch/<arch>/configs/<name>_defconfig
```

**Examples:**
- `arch/arm64/configs/defconfig` - Generic ARM64
- `arch/arm64/configs/pixel_defconfig` - Pixel device
- `arch/x86/configs/x86_64_defconfig` - x86_64

#### defconfig Format

**Basic Format:**
```
# CONFIG_OPTION is not set
CONFIG_OPTION=y
CONFIG_OPTION=m
CONFIG_OPTION="value"
```

**Option States:**
- `CONFIG_OPTION=y` - Built into kernel
- `CONFIG_OPTION=m` - Built as module
- `# CONFIG_OPTION is not set` - Disabled

**Example defconfig:**
```
CONFIG_ARM64=y
CONFIG_SMP=y
CONFIG_HOTPLUG_CPU=y
CONFIG_ANDROID=y
CONFIG_ANDROID_BINDER_IPC=y
CONFIG_ASHMEM=y
# CONFIG_UNUSED_FEATURE is not set
```

### Configuration Methods

#### Method 1: menuconfig (Interactive)

**menuconfig:**
```bash
cd kernel/
make ARCH=arm64 menuconfig
```

**Features:**
- Interactive menu
- Search functionality
- Dependency checking
- Help text
- Save configuration

**Navigation:**
- Arrow keys - Navigate
- Enter - Select/Enter submenu
- Space - Toggle option
- `/` - Search
- `?` - Help
- `Esc` - Go back

#### Method 2: defconfig (Predefined)

**Use Existing defconfig:**
```bash
cd kernel/
make ARCH=arm64 <name>_defconfig
```

**Process:**
1. Loads defconfig
2. Merges with defaults
3. Creates `.config`
4. Ready to build

**Example:**
```bash
make ARCH=arm64 defconfig
make ARCH=arm64 pixel_defconfig
```

#### Method 3: savedefconfig

**Save Current Configuration:**
```bash
cd kernel/
make ARCH=arm64 savedefconfig
```

**Creates:**
- Minimal defconfig
- Only non-default options
- Ready to commit
- Device-specific

**Use Case:**
- Save custom configuration
- Create device defconfig
- Update existing defconfig
- Version control

#### Method 4: oldconfig

**Update Configuration:**
```bash
cd kernel/
make ARCH=arm64 oldconfig
```

**Purpose:**
- Update from old kernel
- Handle new options
- Interactive prompts
- Preserve existing config

**Use Case:**
- Kernel version upgrade
- Merge configurations
- Handle new options
- Update defconfig

### Android-Specific Configuration

#### Android Kernel Options

**Base Android Support:**
```
CONFIG_ANDROID=y
```

**Required Android Features:**
```
CONFIG_ANDROID_BINDER_IPC=y
CONFIG_ANDROID_BINDER_DEVICES="binder,hwbinder,vndbinder"
CONFIG_ASHMEM=y
CONFIG_ANDROID_LOGGER=y
```

**ION Memory Allocator:**
```
CONFIG_ION=y
CONFIG_ION_SYSTEM_HEAP=y
CONFIG_ION_CMA_HEAP=y
```

**Wakelocks:**
```
CONFIG_PM_WAKELOCKS=y
CONFIG_PM_WAKELOCKS_LIMIT=100
CONFIG_PM_WAKELOCKS_GC=y
```

#### Device-Specific Configuration

**Hardware Drivers:**
```
CONFIG_INPUT_TOUCHSCREEN=y
CONFIG_TOUCHSCREEN_<vendor>=y
CONFIG_SOUND=y
CONFIG_SND_SOC_<chip>=y
```

**Display:**
```
CONFIG_DRM=y
CONFIG_DRM_<vendor>=y
CONFIG_FB=y
CONFIG_FB_<vendor>=y
```

**Network:**
```
CONFIG_WLAN=y
CONFIG_WLAN_VENDOR_<vendor>=y
CONFIG_BT=y
CONFIG_BT_<chip>=y
```

### Configuration Workflow

#### Step 1: Start with Base defconfig

**Load Base Configuration:**
```bash
cd kernel/
make ARCH=arm64 defconfig
```

**Or Device-Specific:**
```bash
make ARCH=arm64 <device>_defconfig
```

#### Step 2: Customize Configuration

**Interactive Customization:**
```bash
make ARCH=arm64 menuconfig
```

**Or Edit .config Directly:**
```bash
# Edit .config file
vim .config
```

**Or Use Scripts:**
```bash
# Apply configuration script
./scripts/config --enable CONFIG_OPTION
./scripts/config --disable CONFIG_OPTION
```

#### Step 3: Verify Configuration

**Check Configuration:**
```bash
make ARCH=arm64 oldconfig
```

**Verify Dependencies:**
- Check for missing dependencies
- Resolve conflicts
- Ensure consistency

#### Step 4: Save Configuration

**Save as defconfig:**
```bash
make ARCH=arm64 savedefconfig
mv defconfig arch/arm64/configs/mydevice_defconfig
```

**Or Save Full Config:**
```bash
cp .config arch/arm64/configs/mydevice_defconfig
```

### Common Configuration Options

#### Architecture Options

**ARM64:**
```
CONFIG_ARM64=y
CONFIG_64BIT=y
CONFIG_SMP=y
CONFIG_HOTPLUG_CPU=y
```

**x86:**
```
CONFIG_X86_64=y
CONFIG_64BIT=y
CONFIG_SMP=y
```

#### Core Features

**Process Management:**
```
CONFIG_PREEMPT=y
CONFIG_HIGH_RES_TIMERS=y
CONFIG_NO_HZ_IDLE=y
```

**Memory Management:**
```
CONFIG_HIGHMEM=y
CONFIG_CMA=y
CONFIG_ZONE_DMA=y
```

**File Systems:**
```
CONFIG_EXT4_FS=y
CONFIG_F2FS_FS=y
CONFIG_VFAT_FS=y
CONFIG_PROC_FS=y
CONFIG_SYSFS=y
```

#### Security Options

**SELinux:**
```
CONFIG_SECURITY_SELINUX=y
CONFIG_SECURITY_SELINUX_BOOTPARAM=y
CONFIG_SECURITY_SELINUX_DEVELOP=y
```

**Other Security:**
```
CONFIG_SECURITY=y
CONFIG_SECURITYFS=y
CONFIG_KEYS=y
```

### Configuration Best Practices

#### Size Optimization

**Minimize Kernel Size:**
- Disable unused features
- Build drivers as modules
- Remove unnecessary drivers
- Optimize for target hardware

**Module vs Built-in:**
- Common drivers: Built-in (`=y`)
- Optional drivers: Modules (`=m`)
- Rarely used: Disabled

#### Performance Optimization

**Optimize for Hardware:**
- Enable hardware-specific features
- Configure for target CPU
- Optimize memory settings
- Enable performance features

**CPU-Specific:**
```
CONFIG_ARM_CPU_TOPOLOGY=y
CONFIG_SCHED_MC=y
CONFIG_SCHED_SMT=y
```

#### Compatibility

**Maintain Compatibility:**
- Keep standard interfaces
- Don't break userspace
- Maintain ABI compatibility
- Test thoroughly

### Integration with Android Build

#### BoardConfig Integration

**BoardConfig.mk:**
```makefile
TARGET_KERNEL_ARCH := arm64
TARGET_KERNEL_CONFIG := mydevice_defconfig
TARGET_KERNEL_SOURCE := kernel/vendor/device
```

**Build System:**
- Loads defconfig automatically
- Builds kernel with config
- Includes in boot image
- Device-specific

#### Build Process

**Automatic Configuration:**
1. Build system reads BoardConfig
2. Loads specified defconfig
3. Builds kernel
4. Packages in boot image

**Manual Override:**
```bash
# Can override in build
TARGET_KERNEL_CONFIG := custom_defconfig
```

### Configuration Management

#### Version Control

**defconfig in Git:**
- Commit defconfig files
- Track changes
- Device-specific branches
- Version history

**Best Practices:**
- One defconfig per device
- Clear naming
- Document changes
- Test before commit

#### Configuration Updates

**Updating defconfig:**
1. Load current defconfig
2. Make changes
3. Test build
4. Save updated defconfig
5. Commit changes

**Kernel Upgrades:**
1. Load old defconfig
2. Run `oldconfig`
3. Handle new options
4. Test thoroughly
5. Save updated defconfig

### Troubleshooting Configuration

#### Common Issues

**Missing Dependencies:**
- Enable required options
- Check Kconfig dependencies
- Resolve conflicts

**Build Failures:**
- Check configuration
- Verify dependencies
- Review error messages
- Test incrementally

**Runtime Issues:**
- Verify drivers enabled
- Check module loading
- Review kernel logs
- Test hardware

### Configuration Tools

#### scripts/config

**Command-Line Configuration:**
```bash
./scripts/config --enable CONFIG_OPTION
./scripts/config --disable CONFIG_OPTION
./scripts/config --set-val CONFIG_OPTION value
./scripts/config --get CONFIG_OPTION
```

**Use Cases:**
- Script-based configuration
- Automated setup
- CI/CD pipelines
- Configuration management

#### merge_config.sh

**Merge Configurations:**
```bash
./scripts/kconfig/merge_config.sh defconfig fragment1 fragment2
```

**Purpose:**
- Combine configurations
- Apply fragments
- Merge device configs
- Build custom configs

## Key Takeaways

1. **Kernel configuration determines** which features, drivers, and options are compiled into the kernel.

2. **defconfig files** are minimal configuration files that contain only non-default options and are device-specific.

3. **Kconfig is the kernel's configuration system** that provides menu-driven configuration and dependency management.

4. **Configuration methods include** menuconfig (interactive), defconfig (predefined), savedefconfig (save current), and oldconfig (update).

5. **Android requires specific kernel options** like CONFIG_ANDROID, CONFIG_ANDROID_BINDER_IPC, CONFIG_ASHMEM, and CONFIG_ION.

6. **Configuration workflow** involves loading a base defconfig, customizing for your device, verifying, and saving.

7. **Best practices include** size optimization, performance tuning, maintaining compatibility, and proper version control.

8. **Understanding kernel configuration** is essential for device porting, kernel customization, and AOSP development.

## Related Topics

- **Kernel modules:** How configuration determines what's built-in vs modular
- **Building the kernel:** How defconfig is used in the build process
- **BoardConfig:** How kernel configuration is specified in Android build system
- **Differences between Android kernel & Linux kernel:** Android-specific configuration options

