---
number: 23
title: Build System Structure
slug: build-system-structure
level: beginner
tags:
  - aosp
  - build-system
  - make
  - soong
  - blueprint
  - compilation
prerequisites:
  - android-architecture-complete-overview
estimated_minutes: 80
contributors: []
diagrams: []
examples: []
canonical_id: aosp-beginner-23
---

# Build System Structure

## Overview

The Android build system is a complex framework that compiles source code, packages components, and generates installable system images. Understanding the build system structure is essential for AOSP development, as it determines how code is organized, how components are built, and how the final Android system is assembled. This guide provides a comprehensive overview of the Android build system architecture, its components, and how they work together to create a complete Android system.

Think of the Android build system like a sophisticated factory assembly line: raw materials (source code) enter at one end, go through various processing stations (compilers, linkers, packagers), and emerge as finished products (system images, APKs, libraries) at the other end. Each station has a specific job, and the entire line is orchestrated to produce a complete, working Android system.

## Deep Explanation

### What is the Android Build System?

The Android build system is a collection of tools, scripts, and configuration files that transform Android source code into runnable system images, applications, and libraries. It handles compilation, linking, packaging, and image creation for the entire Android platform.

**Key Characteristics:**
- **Multi-language Support:** Handles Java, Kotlin, C, C++, Rust, and more
- **Modular:** Each component builds independently
- **Incremental:** Only rebuilds what changed
- **Parallel:** Builds multiple components simultaneously
- **Configurable:** Supports different devices and variants

**Build System Evolution:**
- **Early Android:** Pure Make-based system
- **Android 7.0+:** Hybrid Make + Soong
- **Current:** Primarily Soong with Make for legacy support
- **Future:** Moving toward Bazel (experimental)

### Build System Architecture

The Android build system consists of several key components that work together:

#### 1. Build Configuration Layer

**Purpose:**
Defines what to build, how to build it, and for which device/variant.

**Components:**
- **Product Configuration:** Device-specific settings
- **Board Configuration:** Hardware-specific settings
- **Build Variants:** eng, user, userdebug
- **Lunch Combos:** Predefined device configurations

**Configuration Files:**
- `build/make/core/config.mk` - Core Make configuration
- `build/soong/Android.bp` - Soong build definitions
- `device/` - Device-specific configurations
- `vendor/` - Vendor-specific configurations

#### 2. Build Description Layer

**Purpose:**
Describes what needs to be built (modules, libraries, apps).

**Components:**
- **Android.mk:** Legacy Make-based build descriptions
- **Android.bp:** Modern Soong build descriptions
- **Blueprint Files:** Soong's build description format

**Build Descriptions:**
- Define source files
- Specify dependencies
- Configure build options
- Define output targets

#### 3. Build Execution Layer

**Purpose:**
Actually performs the compilation and packaging.

**Components:**
- **Make:** Legacy build executor
- **Soong:** Modern build executor
- **Kati:** Makefile parser and evaluator
- **Ninja:** Low-level build executor

**Execution Flow:**
1. Parse build descriptions
2. Resolve dependencies
3. Generate build graph
4. Execute build commands
5. Produce output artifacts

#### 4. Toolchain Layer

**Purpose:**
Provides compilation and linking tools.

**Components:**
- **Java Compiler:** javac for Java/Kotlin
- **C/C++ Compiler:** GCC or Clang
- **Linker:** ld or lld
- **Packaging Tools:** aapt, zip, etc.

**Toolchain Selection:**
- Prebuilt toolchains included
- Can use system toolchains
- Version-specific toolchains
- Architecture-specific toolchains

### Build System Components

#### Make-Based System (Legacy)

**What is Make?**
Make is a build automation tool that uses Makefiles to describe build rules.

**Make Components:**
- **Android.mk Files:** Module build descriptions
- **Core Makefiles:** Build system core logic
- **Device Makefiles:** Device-specific rules
- **Product Makefiles:** Product-specific rules

**Make Execution:**
- Parses Android.mk files
- Resolves dependencies
- Generates build commands
- Executes compilation

**Limitations:**
- Slow for large projects
- Difficult to parallelize
- Hard to maintain
- Limited incremental builds

#### Soong-Based System (Modern)

**What is Soong?**
Soong is Android's modern build system, written in Go, that replaces Make for most builds.

**Soong Components:**
- **Android.bp Files:** Module build descriptions
- **Blueprint Parser:** Parses Android.bp files
- **Soong Builder:** Executes builds
- **Ninja Generator:** Generates Ninja build files

**Soong Execution:**
- Parses Android.bp files
- Resolves dependencies
- Generates Ninja files
- Ninja executes builds

**Advantages:**
- Faster than Make
- Better parallelization
- Easier to maintain
- Better incremental builds

#### Hybrid System

**Current State:**
Android uses a hybrid approach:
- **Soong:** For new modules (preferred)
- **Make:** For legacy modules (still supported)
- **Integration:** Make can call Soong, Soong can call Make

**Migration:**
- Gradually migrating from Make to Soong
- New code uses Soong
- Legacy code still uses Make
- Both systems coexist

### Build System Directory Structure

The AOSP source tree is organized to support the build system:

#### Top-Level Directories

**build/**
- Core build system files
- Make and Soong definitions
- Build tools and scripts
- Common build logic

**device/**
- Device-specific configurations
- Board configurations
- Device makefiles
- Hardware-specific code

**vendor/**
- Vendor-specific code
- Proprietary components
- Vendor configurations
- OEM customizations

**frameworks/**
- Android framework code
- System services
- Framework libraries
- API implementations

**packages/**
- System applications
- Pre-installed apps
- System UI components
- Default apps

**system/**
- Core system components
- Native daemons
- System libraries
- Core utilities

**hardware/**
- Hardware abstraction layers
- HAL implementations
- Hardware interfaces
- Driver code

#### Build-Specific Directories

**out/**
- Build output directory
- Compiled objects
- Generated files
- Final images

**out/target/product/**
- Device-specific outputs
- System images
- OTA packages
- Installable files

**out/host/**
- Host tools
- Build utilities
- Development tools
- Host binaries

### Build Process Overview

The build process follows a structured sequence:

#### Phase 1: Configuration

**1. Environment Setup:**
```bash
source build/envsetup.sh
```

**2. Device Selection:**
```bash
lunch <device>-<variant>
```

**3. Configuration Loading:**
- Load product configuration
- Load board configuration
- Set build variables
- Prepare build environment

#### Phase 2: Build Description Parsing

**1. Parse Android.bp Files:**
- Soong scans for Android.bp files
- Parses build descriptions
- Resolves module dependencies
- Builds dependency graph

**2. Parse Android.mk Files:**
- Make parses Android.mk files
- Processes legacy modules
- Integrates with Soong
- Builds dependency graph

**3. Dependency Resolution:**
- Resolve all dependencies
- Build complete dependency graph
- Detect circular dependencies
- Order build execution

#### Phase 3: Build Execution

**1. Generate Build Files:**
- Soong generates Ninja files
- Make generates build rules
- Create execution plan
- Optimize build order

**2. Execute Builds:**
- Run compilers
- Link libraries
- Package components
- Generate artifacts

**3. Parallel Execution:**
- Build multiple modules simultaneously
- Utilize multiple CPU cores
- Optimize resource usage
- Minimize build time

#### Phase 4: Image Creation

**1. Package Components:**
- Package APKs
- Package libraries
- Package native binaries
- Package resources

**2. Create Partitions:**
- Create system.img
- Create vendor.img
- Create boot.img
- Create other partitions

**3. Generate Images:**
- Create flashable images
- Generate OTA packages
- Create installable packages
- Finalize outputs

### Build Variants

Android supports different build variants for different purposes:

#### eng (Engineering)

**Purpose:**
Development and debugging builds.

**Characteristics:**
- Root access enabled
- Debugging tools included
- Additional logging
- Development features enabled

**Use Cases:**
- Development
- Debugging
- Testing
- Internal use

#### userdebug

**Purpose:**
User builds with debugging capabilities.

**Characteristics:**
- Some debugging features
- ADB enabled
- Some root access
- Balanced features

**Use Cases:**
- Testing
- Beta releases
- Internal testing
- QA testing

#### user

**Purpose:**
Production user builds.

**Characteristics:**
- No root access
- Minimal debugging
- Optimized performance
- Production-ready

**Use Cases:**
- Production releases
- End-user devices
- Public releases
- Commercial

### Build Outputs

The build system produces various outputs:

#### System Images

**system.img:**
- Android system partition
- Framework and apps
- System libraries
- Core Android components

**vendor.img:**
- Vendor-specific components
- Proprietary code
- Hardware-specific code
- Vendor customizations

**boot.img:**
- Kernel image
- Device tree
- Initramfs
- Boot components

#### Applications

**APK Files:**
- System applications
- Pre-installed apps
- Framework resources
- System components

#### Libraries

**Shared Libraries (.so):**
- Native libraries
- JNI libraries
- System libraries
- Framework libraries

**Java Libraries (.jar):**
- Framework JARs
- System libraries
- API libraries
- Support libraries

#### Tools

**Host Tools:**
- Development tools
- Build utilities
- Testing tools
- Debugging tools

### Build System Features

#### Incremental Builds

**What It Does:**
Only rebuilds what changed since last build.

**Benefits:**
- Faster builds
- Saves time
- Efficient development
- Quick iterations

**How It Works:**
- Tracks file timestamps
- Compares with previous build
- Rebuilds only changed modules
- Updates dependencies

#### Parallel Builds

**What It Does:**
Builds multiple modules simultaneously.

**Benefits:**
- Utilizes multiple CPU cores
- Faster overall build time
- Better resource usage
- Scalable

**How It Works:**
- Analyzes dependency graph
- Identifies independent modules
- Builds in parallel
- Coordinates execution

#### Dependency Management

**What It Does:**
Tracks and resolves module dependencies.

**Benefits:**
- Correct build order
- Handles dependencies automatically
- Prevents build errors
- Ensures consistency

**How It Works:**
- Analyzes build descriptions
- Builds dependency graph
- Orders build execution
- Handles circular dependencies

### Build System Tools

#### lunch

**Purpose:**
Selects device and build variant.

**Usage:**
```bash
lunch aosp_arm-eng
```

**What It Does:**
- Sets up build environment
- Loads device configuration
- Sets build variables
- Prepares for build

#### m / make

**Purpose:**
Executes Make-based builds.

**Usage:**
```bash
m -j8
make -j8
```

**What It Does:**
- Executes Make build
- Builds specified targets
- Uses parallel jobs
- Produces outputs

#### mmm

**Purpose:**
Builds specific modules.

**Usage:**
```bash
mmm packages/apps/Settings
```

**What It Does:**
- Builds single module
- Handles dependencies
- Faster than full build
- Useful for development

#### soong_ui

**Purpose:**
Soong build system UI and executor.

**Usage:**
```bash
soong_ui
```

**What It Does:**
- Executes Soong builds
- Manages build process
- Coordinates Make and Soong
- Provides build interface

### Build System Configuration

#### Product Configuration

**Location:**
`device/<vendor>/<device>/`

**Files:**
- `AndroidProducts.mk` - Product definitions
- `<device>.mk` - Product configuration
- `BoardConfig.mk` - Board configuration

**Purpose:**
- Define device-specific settings
- Configure hardware
- Set build options
- Customize build

#### Build Variables

**Common Variables:**
- `TARGET_PRODUCT` - Target product
- `TARGET_BUILD_VARIANT` - Build variant
- `TARGET_ARCH` - Target architecture
- `TARGET_ARCH_VARIANT` - Architecture variant

**Usage:**
- Control build behavior
- Configure compilation
- Set build options
- Customize output

### Build System Best Practices

#### Organizing Code

**Structure:**
- Follow AOSP directory structure
- Use appropriate directories
- Organize by component
- Maintain consistency

**Naming:**
- Use clear names
- Follow conventions
- Be descriptive
- Avoid conflicts

#### Writing Build Files

**Android.bp (Soong):**
- Prefer Android.bp for new code
- Use modern syntax
- Define dependencies clearly
- Keep files organized

**Android.mk (Make):**
- Use for legacy code
- Migrate to Android.bp when possible
- Keep dependencies clear
- Document complex builds

#### Build Performance

**Optimization:**
- Use incremental builds
- Enable parallel builds
- Use ccache for C/C++
- Optimize dependencies

**Debugging:**
- Use verbose output
- Check build logs
- Verify dependencies
- Test incremental builds

## Key Takeaways

1. **Android build system is a complex framework** that transforms source code into complete Android system images.

2. **Build system uses hybrid approach** with Soong (modern) and Make (legacy) working together.

3. **Build system has layered architecture** with configuration, description, execution, and toolchain layers.

4. **Build process follows structured sequence** from configuration through parsing, execution, to image creation.

5. **Build system supports multiple variants** (eng, userdebug, user) for different use cases.

6. **Build system provides features** like incremental builds, parallel execution, and dependency management.

7. **Understanding build system structure** is essential for AOSP development, customization, and debugging.

8. **Build system is evolving** from Make to Soong, with potential future migration to Bazel.

## Related Topics

- **Make-Based Build System:** The legacy build system that Soong is replacing
- **Soong Build System:** The modern build system used for new code
- **Blueprint Language Fundamentals:** The language used in Android.bp files
- **AOSP Repo Structure:** How the AOSP source code is organized

