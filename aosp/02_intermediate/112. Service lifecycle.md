---
number: 112
title: Service lifecycle
slug: service-lifecycle
level: intermediate
tags:
  - aosp
  - framework
  - system-services
  - service-lifecycle
  - boot-phases
  - system-server
prerequisites:
  - system-server-overview
  - system-server-launch
  - activitymanagerservice-ams-internals
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-intermediate-112
---

# Service lifecycle

## Overview

Service lifecycle refers to the phases and states that system services go through from creation to shutdown, including initialization, boot phase callbacks, user switching, and shutdown. Understanding service lifecycle is essential for AOSP development, as it explains how services are created, how they receive boot phase notifications, how they handle user switching, how they coordinate with other services, and how they clean up during shutdown. This guide provides a comprehensive overview of service lifecycle, lifecycle phases, boot phase callbacks, user lifecycle, service coordination, and best practices.

Think of service lifecycle like a building's operational phases: just as a building goes through construction (service creation), opening (boot phases), daily operations (runtime), tenant changes (user switching), and closing (shutdown), services go through creation, boot phases, runtime operation, user switching, and shutdown phases.

## Deep Explanation

### What is Service Lifecycle?

Service lifecycle is the sequence of phases and states that system services go through from creation to shutdown, including initialization, boot phase callbacks, user switching, runtime operation, and shutdown.

**Key Characteristics:**
- **Lifecycle Phases:** Multiple phases from creation to shutdown
- **Boot Phase Callbacks:** Notifications during boot process
- **User Lifecycle:** Handling user switching
- **State Management:** Managing service state
- **Coordination:** Coordinating with other services

**Why Service Lifecycle Matters:**
- **Ordered Startup:** Ensures services start in correct order
- **Dependency Management:** Handles service dependencies
- **Resource Management:** Manages resources during lifecycle
- **User Isolation:** Handles multi-user scenarios

### Lifecycle Phases

#### Phase 1: Service Creation

**Service Creation:**
- Service instance created
- Constructor called
- Initial state set
- Dependencies injected

**Creation Process:**
```java
// In SystemServer
mActivityManagerService = mSystemServiceManager.startService(
    ActivityManagerService.Lifecycle.class).getService();
```

**Creation Steps:**
1. SystemServiceManager creates service instance
2. Service constructor called
3. Service initialized
4. Service added to service list
5. Service ready for lifecycle callbacks

#### Phase 2: onStart()

**onStart() Callback:**
- Called when service starts
- Initial setup performed
- Service registration
- Initial state initialization

**onStart() Implementation:**
```java
@Override
public void onStart() {
    // Initialize service
    initializeService();
    
    // Register with ServiceManager
    ServiceManager.addService(Context.ACTIVITY_SERVICE, this);
    
    // Set up initial state
    setInitialState();
}
```

**onStart() Responsibilities:**
- Initialize service state
- Register with ServiceManager
- Set up initial configuration
- Prepare for operation

#### Phase 3: Boot Phase Callbacks

**Boot Phase Callbacks:**
Services receive boot phase notifications to coordinate startup:

**PHASE_WAIT_FOR_DEFAULT_DISPLAY:**
- Wait for default display
- Display services ready
- UI can be initialized

**PHASE_LOCK_SETTINGS_READY:**
- Lock settings ready
- Security services initialized
- User data available

**PHASE_SYSTEM_SERVICES_READY:**
- Core services ready
- System can function
- Some services can start

**PHASE_ACTIVITY_MANAGER_READY:**
- ActivityManager ready
- Apps can launch
- User interaction possible

**PHASE_THIRD_PARTY_APPS_CAN_START:**
- Third-party apps can start
- User apps available
- Full system ready

**onBootPhase() Implementation:**
```java
@Override
public void onBootPhase(int phase) {
    switch (phase) {
        case SystemService.PHASE_SYSTEM_SERVICES_READY:
            // Core services ready
            onSystemServicesReady();
            break;
            
        case SystemService.PHASE_ACTIVITY_MANAGER_READY:
            // ActivityManager ready
            onActivityManagerReady();
            break;
            
        case SystemService.PHASE_THIRD_PARTY_APPS_CAN_START:
            // Third-party apps can start
            onThirdPartyAppsCanStart();
            break;
    }
}
```

**Boot Phase Coordination:**
- Services wait for dependencies
- Services coordinate startup
- Prevents race conditions
- Ensures correct order

#### Phase 4: Runtime Operation

**Runtime Operation:**
- Service handles requests
- Service maintains state
- Service responds to events
- Service coordinates with others

**Runtime Characteristics:**
- Service is fully operational
- Handles client requests
- Maintains service state
- Responds to system events

#### Phase 5: User Lifecycle

**User Lifecycle Callbacks:**
Services receive user lifecycle notifications:

**onUserStarting():**
- User switching started
- User-specific initialization
- User data available

**onUserStarted():**
- User fully started
- User can interact
- User apps available

**onUserStopping():**
- User switching away
- Clean up user resources
- Save user state

**onUserStopped():**
- User fully stopped
- User resources cleaned
- User data saved

**onUserUnlocking():**
- User unlocking
- User data decrypting
- User access granted

**onUserUnlocked():**
- User fully unlocked
- User data available
- User can use device

**User Lifecycle Implementation:**
```java
@Override
public void onUserStarting(TargetUser user) {
    // Initialize user-specific state
    initializeUserState(user.getUserIdentifier());
}

@Override
public void onUserStarted(TargetUser user) {
    // User fully started
    onUserFullyStarted(user.getUserIdentifier());
}

@Override
public void onUserStopping(TargetUser user) {
    // Clean up user resources
    cleanupUserResources(user.getUserIdentifier());
}
```

#### Phase 6: Shutdown

**Shutdown Process:**
- Service receives shutdown signal
- Service stops accepting requests
- Service cleans up resources
- Service terminates

**Shutdown Implementation:**
```java
@Override
public void onShutdown() {
    // Stop accepting requests
    stopAcceptingRequests();
    
    // Clean up resources
    cleanupResources();
    
    // Save state if needed
    saveState();
}
```

### Boot Phase Details

#### PHASE_WAIT_FOR_DEFAULT_DISPLAY

**Purpose:**
- Wait for default display
- Display services ready
- UI can be initialized

**When Called:**
- After display services start
- Before UI services start
- Early in boot process

**Use Cases:**
- Display-dependent services
- UI initialization
- Display configuration

#### PHASE_LOCK_SETTINGS_READY

**Purpose:**
- Lock settings ready
- Security services initialized
- User data available

**When Called:**
- After security services start
- Before user services start
- Security initialization complete

**Use Cases:**
- Security-dependent services
- User data access
- Lock screen services

#### PHASE_SYSTEM_SERVICES_READY

**Purpose:**
- Core services ready
- System can function
- Some services can start

**When Called:**
- After core services start
- Before app services start
- Core functionality available

**Use Cases:**
- Services depending on core services
- System-wide initialization
- Service coordination

#### PHASE_ACTIVITY_MANAGER_READY

**Purpose:**
- ActivityManager ready
- Apps can launch
- User interaction possible

**When Called:**
- After ActivityManager starts
- Before apps can start
- App management ready

**Use Cases:**
- App-dependent services
- Activity-related services
- User interaction services

#### PHASE_THIRD_PARTY_APPS_CAN_START

**Purpose:**
- Third-party apps can start
- User apps available
- Full system ready

**When Called:**
- After all system services ready
- Before user apps start
- System fully operational

**Use Cases:**
- App-dependent services
- User app integration
- Full system operation

### User Lifecycle Details

#### User Starting

**onUserStarting():**
- User switching started
- User-specific initialization
- User data available

**Responsibilities:**
- Initialize user state
- Load user data
- Set up user resources
- Prepare user environment

#### User Started

**onUserStarted():**
- User fully started
- User can interact
- User apps available

**Responsibilities:**
- Complete user initialization
- Start user services
- Enable user interaction
- Make user apps available

#### User Stopping

**onUserStopping():**
- User switching away
- Clean up user resources
- Save user state

**Responsibilities:**
- Stop user services
- Save user state
- Clean up user resources
- Prepare for user switch

#### User Stopped

**onUserStopped():**
- User fully stopped
- User resources cleaned
- User data saved

**Responsibilities:**
- Complete cleanup
- Release user resources
- Finalize user state
- User switch complete

### Service Coordination

#### Dependency Management

**Service Dependencies:**
- Services depend on other services
- Dependencies managed via boot phases
- Services wait for dependencies
- Prevents race conditions

**Dependency Example:**
```java
// Service depends on ActivityManager
@Override
public void onBootPhase(int phase) {
    if (phase == SystemService.PHASE_ACTIVITY_MANAGER_READY) {
        // ActivityManager is ready
        // Can now use ActivityManager
        ActivityManager am = getActivityManager();
        am.registerCallback(this);
    }
}
```

#### Service Communication

**Service Communication:**
- Services communicate via Binder
- Services coordinate via boot phases
- Services share state
- Services notify each other

**Communication Patterns:**
- Direct service calls
- Boot phase coordination
- Event notifications
- State sharing

### Lifecycle Best Practices

#### Initialization

**Best Practices:**
- Initialize in onStart()
- Use boot phases for dependencies
- Keep initialization fast
- Avoid blocking operations

**Guidelines:**
- Fast initialization
- Lazy initialization when possible
- Use background threads
- Avoid blocking main thread

#### State Management

**State Management:**
- Manage state during lifecycle
- Save state during shutdown
- Restore state during startup
- Handle state transitions

**State Management Example:**
```java
private void saveState() {
    // Save service state
    SharedPreferences prefs = getSharedPreferences();
    prefs.edit().putString("state", serializeState()).apply();
}

private void restoreState() {
    // Restore service state
    SharedPreferences prefs = getSharedPreferences();
    String state = prefs.getString("state", null);
    if (state != null) {
        deserializeState(state);
    }
}
```

#### Resource Management

**Resource Management:**
- Acquire resources in onStart()
- Release resources in onShutdown()
- Manage resources during runtime
- Handle resource cleanup

**Resource Management Example:**
```java
private FileObserver mFileObserver;

@Override
public void onStart() {
    // Acquire resources
    mFileObserver = new FileObserver(path) {
        // ...
    };
    mFileObserver.startWatching();
}

@Override
public void onShutdown() {
    // Release resources
    if (mFileObserver != null) {
        mFileObserver.stopWatching();
        mFileObserver = null;
    }
}
```

### Service Lifecycle Example

#### Complete Lifecycle Example

**Service Implementation:**
```java
public class MySystemService extends SystemService {
    private MyServiceState mState;
    
    public MySystemService(Context context) {
        super(context);
        mState = new MyServiceState();
    }
    
    @Override
    public void onStart() {
        // Phase 1: Service creation complete
        // Initialize service
        initializeService();
        
        // Register with ServiceManager
        ServiceManager.addService("myservice", this);
    }
    
    @Override
    public void onBootPhase(int phase) {
        if (phase == SystemService.PHASE_SYSTEM_SERVICES_READY) {
            // Phase 2: Core services ready
            onSystemServicesReady();
        } else if (phase == SystemService.PHASE_ACTIVITY_MANAGER_READY) {
            // Phase 3: ActivityManager ready
            onActivityManagerReady();
        } else if (phase == SystemService.PHASE_THIRD_PARTY_APPS_CAN_START) {
            // Phase 4: Apps can start
            onAppsCanStart();
        }
    }
    
    @Override
    public void onUserStarting(TargetUser user) {
        // Phase 5: User starting
        initializeUserState(user.getUserIdentifier());
    }
    
    @Override
    public void onUserStarted(TargetUser user) {
        // Phase 6: User started
        startUserServices(user.getUserIdentifier());
    }
    
    @Override
    public void onShutdown() {
        // Phase 7: Shutdown
        cleanupResources();
        saveState();
    }
}
```

### Debugging Lifecycle

#### Lifecycle Debugging

**Debugging Tools:**
- Service dumps
- Boot phase logs
- Lifecycle callbacks logs
- State inspection

**Debugging Commands:**
```bash
# Dump service state
adb shell dumpsys activity | grep MyService

# Check boot phases
adb logcat | grep BootPhase

# Monitor lifecycle
adb logcat | grep MyService
```

#### Common Issues

**Lifecycle Issues:**
- Service not starting
- Boot phase not called
- User lifecycle not working
- Shutdown not cleaning up

**Debugging Steps:**
1. Check service registration
2. Verify boot phase callbacks
3. Inspect service state
4. Review lifecycle logs

## Key Takeaways

1. **Service lifecycle** refers to the phases and states that system services go through from creation to shutdown, including initialization, boot phase callbacks, user switching, and shutdown.

2. **Lifecycle phases** include service creation (instance creation), onStart() (initial setup), boot phase callbacks (coordination), runtime operation (handling requests), user lifecycle (user switching), and shutdown (cleanup).

3. **Boot phase callbacks** include PHASE_WAIT_FOR_DEFAULT_DISPLAY, PHASE_LOCK_SETTINGS_READY, PHASE_SYSTEM_SERVICES_READY, PHASE_ACTIVITY_MANAGER_READY, and PHASE_THIRD_PARTY_APPS_CAN_START for coordinating service startup.

4. **User lifecycle** includes onUserStarting() (user switching started), onUserStarted() (user fully started), onUserStopping() (user switching away), onUserStopped() (user fully stopped), onUserUnlocking() (user unlocking), and onUserUnlocked() (user fully unlocked).

5. **Service coordination** includes dependency management (services wait for dependencies), service communication (services coordinate via boot phases), and state sharing (services share state).

6. **Best practices** include fast initialization (keep initialization fast), state management (manage state during lifecycle), resource management (acquire/release resources properly), and avoiding blocking operations.

7. **Understanding service lifecycle** is essential for AOSP development, enabling proper service initialization, dependency management, user lifecycle handling, and resource management.

## Related Topics

- **System Server Overview:** How system services are organized
- **System Server Launch:** How System Server starts services
- **ActivityManagerService (AMS) internals:** Example service lifecycle
- **Binderized services:** How services are exposed via Binder

