---
number: 99
title: InputManagerService (IMS)
slug: inputmanagerservice-ims
level: intermediate
tags:
  - aosp
  - framework
  - ims
  - input-manager
  - touch-input
  - system-services
prerequisites:
  - system-server-overview
  - windowmanagerservice-wms
  - android-architecture-complete-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-intermediate-99
---

# InputManagerService (IMS)

## Overview

InputManagerService (IMS) is a critical system service responsible for processing and routing input events from hardware devices (touchscreen, keyboard, etc.) to the appropriate applications and windows. Understanding IMS is essential for AOSP development, as it explains how input events are received, processed, routed, and delivered to applications, how input focus is managed, how input devices are handled, and how IMS coordinates with WindowManagerService. This guide provides a comprehensive overview of IMS, architecture, input event processing, input routing, focus management, input device management, and debugging.

Think of IMS like a postal service for input: just as a postal service receives mail (input events) from various sources (input devices), sorts it (processes events), determines the destination (target window), and delivers it (routes to applications), IMS receives input events from hardware, processes them, determines the target window, and delivers them to the appropriate application.

## Deep Explanation

### What is InputManagerService?

InputManagerService is a core system service running in the SystemServer process that manages all input events from hardware devices, including touch events, keyboard input, and other input sources, routing them to the appropriate windows and applications.

**Key Characteristics:**
- **Core Service:** Runs in SystemServer
- **Input Processing:** Processes input events
- **Event Routing:** Routes events to windows
- **Focus Management:** Manages input focus
- **Device Management:** Manages input devices

**Why IMS?**
- **Centralized Processing:** Single point for input processing
- **Consistent Routing:** Ensures consistent event routing
- **Focus Coordination:** Manages input focus
- **Device Coordination:** Coordinates multiple input devices

### IMS Architecture

#### Service Location

**IMS Location:**
- Runs in `system_server` process
- Part of SystemServer
- Started early in boot sequence
- Registered with ServiceManager

**Service Registration:**
```java
// In SystemServer
InputManagerService ims = new InputManagerService(...);
ServiceManager.addService(Context.INPUT_SERVICE, ims);
```

**Access from Apps:**
```java
// Apps access via InputManager (usually indirect)
// Input events delivered via WindowManager
```

#### Internal Components

**IMS Components:**
- **InputReader:** Reads input events from kernel
- **InputDispatcher:** Dispatches events to windows
- **InputPolicy:** Applies input policies
- **InputDeviceManager:** Manages input devices
- **FocusController:** Manages input focus

### Input Event Flow

#### Event Pipeline

**Input Event Flow:**
```
1. Hardware generates input event
2. Kernel input driver receives event
3. InputReader reads event from /dev/input/
4. InputReader processes event
5. InputDispatcher receives event
6. InputDispatcher determines target window
7. InputDispatcher applies input policy
8. InputDispatcher routes to WindowManager
9. WindowManager delivers to window
10. Window delivers to application
11. Application processes event
```

**Key Stages:**
- Hardware → Kernel
- Kernel → InputReader
- InputReader → InputDispatcher
- InputDispatcher → WindowManager
- WindowManager → Window
- Window → Application

#### InputReader

**InputReader Responsibilities:**
- Read events from `/dev/input/`
- Process raw input data
- Convert to Android input events
- Queue events for dispatcher

**InputReader Process:**
```
1. Poll /dev/input/ devices
2. Read raw input data
3. Parse input data
4. Create InputEvent
5. Queue for dispatcher
```

**Event Types:**
- Motion events (touch, mouse)
- Key events (keyboard)
- Switch events (lid, etc.)

#### InputDispatcher

**InputDispatcher Responsibilities:**
- Receive events from InputReader
- Determine target window
- Apply input policy
- Route events to windows
- Handle input focus

**Dispatcher Process:**
```
1. Receive event from InputReader
2. Determine target window (hit testing)
3. Apply input policy
4. Route to WindowManager
5. Handle focus changes
```

### Input Event Types

#### Motion Events

**Touch Events:**
- **ACTION_DOWN:** Touch started
- **ACTION_MOVE:** Touch moved
- **ACTION_UP:** Touch ended
- **ACTION_CANCEL:** Touch cancelled
- **ACTION_POINTER_DOWN:** Additional touch
- **ACTION_POINTER_UP:** Additional touch ended

**Motion Event Data:**
- X, Y coordinates
- Pressure
- Size
- Tool type
- Pointer count
- Event time

#### Key Events

**Key Event Types:**
- **ACTION_DOWN:** Key pressed
- **ACTION_UP:** Key released
- **ACTION_MULTIPLE:** Key repeat

**Key Event Data:**
- Key code
- Key character
- Meta state
- Scan code
- Event time

### Input Routing

#### Target Window Determination

**Hit Testing:**
```
1. Get touch coordinates
2. Query WindowManager for windows
3. Find topmost window at coordinates
4. Check window visibility
5. Check window focusability
6. Return target window
```

**Hit Test Process:**
- Coordinate-based lookup
- Z-order traversal
- Visibility check
- Focusability check

#### Event Routing

**Routing Process:**
```
1. InputDispatcher receives event
2. InputDispatcher performs hit test
3. InputDispatcher gets target window
4. InputDispatcher checks input policy
5. InputDispatcher routes to WindowManager
6. WindowManager delivers to window
7. Window delivers to application
```

**Routing Factors:**
- Touch coordinates
- Window z-order
- Window visibility
- Window focus
- Input policy

### Focus Management

#### Input Focus

**Focus Concept:**
- Only one window has input focus
- Focus determines input target
- Focus changes on window changes
- System windows can steal focus

**Focus Rules:**
- Topmost window gets focus
- System windows can steal focus
- Focus changes on window changes
- Focus affects input routing

#### Focus Changes

**Focus Change Flow:**
```
1. Window state changes
2. WindowManager notifies IMS
3. IMS updates focus
4. IMS notifies old window (focus lost)
5. IMS notifies new window (focus gained)
6. IMS routes input to new window
```

**Focus Notifications:**
- Focus gained
- Focus lost
- Window focusable state
- Window visibility changes

### Input Policy

#### Policy Application

**Input Policy:**
- Determines which events to process
- Handles system key interception
- Manages input filtering
- Enforces security policies

**Policy Rules:**
- System key handling (home, back, etc.)
- Input filtering
- Accessibility features
- Security restrictions

#### System Key Handling

**System Keys:**
- **HOME:** Home button
- **BACK:** Back button
- **MENU:** Menu button (legacy)
- **POWER:** Power button
- **VOLUME:** Volume buttons

**System Key Processing:**
```
1. InputDispatcher receives system key
2. InputDispatcher intercepts key
3. InputDispatcher handles system action
4. Key not delivered to app
```

### Input Device Management

#### Device Discovery

**Device Discovery:**
```
1. System boots
2. IMS scans /dev/input/
3. IMS discovers input devices
4. IMS reads device capabilities
5. IMS registers devices
6. IMS starts reading from devices
```

**Device Types:**
- Touchscreen
- Keyboard
- Mouse
- Gamepad
- Other input devices

#### Device Capabilities

**Device Information:**
- Device name
- Device type
- Input capabilities
- Key mappings
- Axis information

**Capability Query:**
- Supported events
- Key codes
- Axis ranges
- Device properties

### Input Channels

#### Channel Concept

**Input Channel:**
- Connection between IMS and window
- Used for input event delivery
- Created per window
- Managed by WindowManager

**Channel Lifecycle:**
- Created with window
- Used for input routing
- Destroyed with window
- Managed by WindowManager

#### Channel Communication

**Channel Flow:**
```
1. Window created
2. WindowManager creates InputChannel
3. WindowManager registers with IMS
4. IMS uses channel for routing
5. Events delivered via channel
6. Window destroyed
7. Channel destroyed
```

### IMS Coordination

#### WindowManager Coordination

**Window Coordination:**
- IMS queries WindowManager for windows
- WindowManager provides window information
- IMS uses info for hit testing
- WindowManager delivers events to windows

**Coordination Flow:**
```
IMS → Query WMS for windows
WMS → Return window list
IMS → Perform hit test
IMS → Route event to window
WMS → Deliver to window
```

#### AMS Coordination

**ANR Detection:**
- IMS monitors input response
- IMS notifies AMS of input events
- AMS tracks response time
- AMS detects ANR if timeout

**ANR Flow:**
```
1. IMS sends input event
2. IMS notifies AMS
3. AMS starts timer
4. If no response, AMS detects ANR
```

### Input Event Processing

#### Event Queuing

**Event Queue:**
- Events queued in InputDispatcher
- Processed in order
- Priority-based processing
- Timeout handling

**Queue Management:**
- Event ordering
- Priority handling
- Timeout management
- Queue overflow handling

#### Event Batching

**Batching Process:**
- Multiple events batched together
- Reduces overhead
- Improves performance
- Maintains event order

**Batching Benefits:**
- Reduced IPC overhead
- Better performance
- Smoother input
- Lower latency

### Debugging IMS

#### Common Issues

**Development Issues:**
- Input not working
- Events not delivered
- Focus issues
- Device not detected
- Routing problems

#### Debugging Tools

**dumpsys input:**
```bash
# Dump IMS state
adb shell dumpsys input

# Dump input devices
adb shell dumpsys input devices

# Dump input events
adb shell dumpsys input events
```

**getevent:**
```bash
# Monitor input events
adb shell getevent

# Monitor specific device
adb shell getevent /dev/input/event0

# Monitor with timestamps
adb shell getevent -t
```

**Logcat:**
```bash
# Filter IMS logs
adb logcat | grep InputManager

# Filter input events
adb logcat | grep InputDispatcher
```

#### IMS State Inspection

**Input Devices:**
```bash
# List input devices
adb shell dumpsys input devices

# Shows:
# - Device name
# - Device type
# - Capabilities
# - Key mappings
```

**Input Events:**
```bash
# Monitor events
adb shell getevent

# Shows:
# - Event type
# - Event code
# - Event value
# - Timestamp
```

## Key Takeaways

1. **InputManagerService (IMS)** is a core system service processing and routing input events from hardware devices to applications, managing input focus, and coordinating input devices.

2. **IMS architecture** includes InputReader (reads events from kernel), InputDispatcher (dispatches events to windows), InputPolicy (applies input policies), InputDeviceManager (manages devices), and FocusController (manages focus).

3. **Input event flow** goes from hardware → kernel → InputReader → InputDispatcher → WindowManager → window → application, with processing and routing at each stage.

4. **Input event types** include motion events (touch, mouse with actions like DOWN, MOVE, UP) and key events (keyboard with actions like DOWN, UP, MULTIPLE).

5. **Input routing** involves target window determination (hit testing based on coordinates and z-order), event routing (to WindowManager and then to windows), and routing factors (coordinates, z-order, visibility, focus).

6. **Focus management** includes input focus (only one window has focus), focus changes (on window state changes), and focus notifications (focus gained/lost).

7. **Input policy** applies policy rules (system key handling, input filtering, accessibility), handles system keys (HOME, BACK, POWER, etc.), and enforces security policies.

8. **Input device management** includes device discovery (scanning /dev/input/), device capabilities (querying device information), and device registration (registering with IMS).

9. **IMS coordination** with WindowManager (window queries and event delivery) and AMS (ANR detection) enables proper input processing and system functionality.

10. **Understanding IMS** is essential for AOSP development, explaining how Android processes and routes input events, manages focus, and coordinates with other services for proper input handling.

## Related Topics

- **System Server Overview:** How IMS fits into SystemServer
- **WindowManagerService (WMS):** How IMS coordinates with WMS for event routing
- **ActivityManagerService (AMS) internals:** How IMS coordinates with AMS for ANR detection
- **InputDispatcher + InputReader:** Detailed input processing components

