---
number: 198
title: signapk & AVB tools
slug: signapk-avb-tools
level: intermediate
tags:
  - aosp
  - signing
  - signapk
  - avb
  - avbtool
  - verified-boot
  - build-tools
prerequisites:
  - signing-rom-builds
  - android-verified-boot-2-0-avb
  - verified-boot-vboot
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-intermediate-198
---

# signapk & AVB tools

## Overview

signapk and AVB tools are essential tools for signing Android packages and images. signapk signs APK files and OTA packages, while AVB tools (avbtool) manage Android Verified Boot signatures for boot images and system partitions. Understanding signapk and AVB tools is essential for AOSP development, as it explains how to sign packages, how to create and verify AVB signatures, how to manage signing keys, and how these tools integrate with the Android build system. This guide provides a comprehensive overview of signapk and AVB tools, package signing, AVB signing, key management, tool usage, and best practices.

Think of signapk and AVB tools like notarization and certification systems: just as you might use a notary to sign important documents (signapk for packages) and a certification authority to verify system integrity (AVB tools for boot images), signapk signs packages to ensure authenticity, while AVB tools create and verify signatures on boot images and system partitions to ensure system integrity.

## Deep Explanation

### What are signapk & AVB Tools?

signapk and AVB tools are command-line tools for signing Android packages and managing Android Verified Boot signatures. signapk signs APK files and OTA packages, while AVB tools (avbtool) create and verify AVB signatures for boot images and system partitions.

**Key Characteristics:**
- **Package Signing:** signapk signs APK and OTA packages
- **AVB Signing:** AVB tools sign boot images and partitions
- **Key Management:** Manage signing keys
- **Verification:** Verify signatures
- **Build Integration:** Integrated with build system

**Why signapk & AVB Tools?**
- **Security:** Ensure package authenticity
- **Integrity:** Verify system integrity
- **Verified Boot:** Enable verified boot
- **Distribution:** Enable secure distribution
- **System Security:** Protect system components

### signapk Tool

#### Tool Overview

**signapk:**
- Signs APK files
- Signs OTA packages
- Adds cryptographic signatures
- Verifies package integrity
- Java-based tool

**Tool Location:**
- `build/tools/signapk/` in AOSP
- Built during AOSP build
- Available as `signapk.jar`
- Requires Java runtime

#### Basic Usage

**Basic Command:**
```bash
java -jar signapk.jar \
    certificate.pem \
    private_key.pk8 \
    unsigned.apk \
    signed.apk
```

**Command Parameters:**
- `certificate.pem` - X.509 certificate
- `private_key.pk8` - Private key (PKCS#8 format)
- `unsigned.apk` - Input unsigned package
- `signed.apk` - Output signed package

**Usage Characteristics:**
- Certificate-based signing
- Private key usage
- Package signing
- Signature addition
- Integrity verification

#### Advanced Usage

**Advanced Options:**
- `--min-sdk-version` - Minimum SDK version
- `--max-sdk-version` - Maximum SDK version
- `--key` - Key alias (for multiple keys)
- `--v1-signing-enabled` - Enable v1 signing
- `--v2-signing-enabled` - Enable v2 signing
- `--v3-signing-enabled` - Enable v3 signing

**Advanced Command:**
```bash
java -jar signapk.jar \
    --min-sdk-version 28 \
    --v1-signing-enabled true \
    --v2-signing-enabled true \
    --v3-signing-enabled true \
    certificate.pem \
    private_key.pk8 \
    unsigned.apk \
    signed.apk
```

**Advanced Characteristics:**
- SDK version control
- Signing scheme selection
- Multiple key support
- Version-specific signing
- Enhanced signing

### AVB Tools (avbtool)

#### Tool Overview

**avbtool:**
- Creates AVB signatures
- Verifies AVB signatures
- Manages AVB metadata
- Generates keys
- Python-based tool

**Tool Location:**
- `external/avb/` in AOSP
- Built during AOSP build
- Available as `avbtool` command
- Requires Python runtime

#### Basic Operations

**Add Hash Footer:**
```bash
avbtool add_hash_footer \
    --image boot.img \
    --partition_name boot \
    --partition_size 67108864 \
    --key keys/test_key.pem \
    --algorithm SHA256_RSA2048
```

**Add Hashtree Footer:**
```bash
avbtool add_hashtree_footer \
    --image system.img \
    --partition_name system \
    --partition_size 3221225472 \
    --key keys/test_key.pem \
    --algorithm SHA256_RSA2048
```

**Verify Image:**
```bash
avbtool verify_image --image boot.img
```

**Operations Characteristics:**
- Hash footer creation
- Hashtree footer creation
- Image verification
- Signature management
- Metadata handling

#### Advanced Operations

**Make vbmeta Image:**
```bash
avbtool make_vbmeta_image \
    --output vbmeta.img \
    --include_descriptors_from_image boot.img \
    --include_descriptors_from_image system.img \
    --include_descriptors_from_image vendor.img \
    --key keys/test_key.pem \
    --algorithm SHA256_RSA2048 \
    --rollback_index 0
```

**Extract Public Key:**
```bash
avbtool extract_public_key \
    --key keys/test_key.pem \
    --output public_key.bin
```

**Info Image:**
```bash
avbtool info_image --image boot.img
```

**Advanced Characteristics:**
- vbmeta creation
- Public key extraction
- Image information
- Rollback index management
- Multi-partition support

### Key Management

#### Key Generation

**Key Generation:**
- Generate RSA keys
- Generate ECDSA keys
- Extract public keys
- Convert key formats
- Manage key pairs

**RSA Key Generation:**
```bash
# Generate RSA private key
openssl genrsa -out private_key.pem 2048

# Extract public key
openssl rsa -in private_key.pem -pubout -out public_key.pem

# Convert to PKCS#8 format (for signapk)
openssl pkcs8 -topk8 -outform DER -in private_key.pem \
    -inform PEM -out private_key.pk8 -nocrypt

# Create certificate (for signapk)
openssl req -new -x509 -key private_key.pem \
    -out certificate.pem -days 10000
```

**AVB Key Generation:**
```bash
# Generate AVB key
openssl genrsa -out avb_key.pem 2048

# Extract AVB public key
avbtool extract_public_key \
    --key avb_key.pem \
    --output avb_public_key.bin
```

**Key Characteristics:**
- Key pair generation
- Format conversion
- Certificate creation
- Public key extraction
- Key management

#### Key Storage

**Key Storage:**
- Secure storage
- Key protection
- Access control
- Backup strategy
- Key rotation

**Storage Best Practices:**
- Store private keys securely
- Use encryption for key storage
- Limit key access
- Backup keys safely
- Rotate keys periodically

**Storage Characteristics:**
- Security focus
- Access control
- Backup support
- Key rotation
- Management practices

### Signing Workflows

#### APK Signing Workflow

**APK Signing:**
- Prepare unsigned APK
- Generate or use keys
- Sign APK
- Verify signature
- Distribute signed APK

**Workflow Steps:**
```bash
# Step 1: Prepare unsigned APK
# Build APK without signing

# Step 2: Sign APK
java -jar signapk.jar \
    certificate.pem \
    private_key.pk8 \
    app-unsigned.apk \
    app-signed.apk

# Step 3: Verify signature
jarsigner -verify -verbose -certs app-signed.apk
```

**Workflow Characteristics:**
- Preparation
- Signing process
- Verification
- Distribution
- Workflow management

#### OTA Package Signing Workflow

**OTA Signing:**
- Create OTA package
- Sign OTA package
- Verify signature
- Distribute OTA

**Workflow Steps:**
```bash
# Step 1: Create OTA package
./build/tools/releasetools/ota_from_target_files \
    target_files.zip \
    ota_unsigned.zip

# Step 2: Sign OTA package
java -jar signapk.jar \
    release.x509.pem \
    release.pk8 \
    ota_unsigned.zip \
    ota_signed.zip

# Step 3: Verify signature
jarsigner -verify -verbose -certs ota_signed.zip
```

**Workflow Characteristics:**
- Package creation
- Signing process
- Verification
- Distribution
- OTA workflow

#### AVB Signing Workflow

**AVB Signing:**
- Prepare images
- Sign boot image
- Sign system partitions
- Create vbmeta
- Verify signatures

**Workflow Steps:**
```bash
# Step 1: Sign boot image
avbtool add_hash_footer \
    --image boot.img \
    --partition_name boot \
    --partition_size 67108864 \
    --key keys/test_key.pem \
    --algorithm SHA256_RSA2048

# Step 2: Sign system partition
avbtool add_hashtree_footer \
    --image system.img \
    --partition_name system \
    --partition_size 3221225472 \
    --key keys/test_key.pem \
    --algorithm SHA256_RSA2048

# Step 3: Create vbmeta
avbtool make_vbmeta_image \
    --output vbmeta.img \
    --include_descriptors_from_image boot.img \
    --include_descriptors_from_image system.img \
    --key keys/test_key.pem \
    --algorithm SHA256_RSA2048

# Step 4: Verify signatures
avbtool verify_image --image boot.img
avbtool verify_image --image system.img
```

**Workflow Characteristics:**
- Image preparation
- Partition signing
- vbmeta creation
- Verification
- AVB workflow

### Build System Integration

#### Automatic Signing

**Build Integration:**
- Automatic package signing
- Automatic AVB signing
- Key configuration
- Signing automation
- Build output signing

**Build Configuration:**
```makefile
# In BoardConfig.mk
PRODUCT_DEFAULT_DEV_CERTIFICATE := \
    build/target/product/security/testkey

# AVB configuration
BOARD_AVB_ENABLE := true
BOARD_AVB_ALGORITHM := SHA256_RSA2048
BOARD_AVB_KEY_PATH := keys/test_key.pem
```

**Integration Characteristics:**
- Automatic signing
- Configuration support
- Key management
- Build automation
- System integration

### Best Practices

#### Best Practices

**Best Practices:**
- Use strong keys
- Protect private keys
- Test signatures
- Verify before distribution
- Document signing process

**Practice Guidelines:**
- **Keys:** Use strong keys
- **Protection:** Protect private keys
- **Testing:** Test signatures
- **Verification:** Verify before distribution
- **Documentation:** Document signing process

#### Common Issues

**Common Issues:**
- Invalid signatures
- Key mismatches
- Verification failures
- Missing keys
- Format errors

**Issue Solutions:**
- Verify key format
- Check key paths
- Validate certificates
- Test signatures
- Review error messages

## Key Takeaways

1. **signapk and AVB tools** are essential tools for signing Android packages and managing Android Verified Boot signatures, with signapk signing APK and OTA packages and AVB tools creating and verifying AVB signatures.

2. **signapk tool** includes tool overview (signs APK files, signs OTA packages, adds cryptographic signatures, verifies package integrity, Java-based tool), basic usage (certificate, private key, unsigned package, signed package), advanced usage (SDK version control, signing scheme selection, multiple key support, version-specific signing), and tool characteristics.

3. **AVB tools (avbtool)** includes tool overview (creates AVB signatures, verifies AVB signatures, manages AVB metadata, generates keys, Python-based tool), basic operations (add hash footer, add hashtree footer, verify image), advanced operations (make vbmeta image, extract public key, info image), and tool characteristics.

4. **Key management** includes key generation (generate RSA keys, generate ECDSA keys, extract public keys, convert key formats, manage key pairs), key storage (secure storage, key protection, access control, backup strategy, key rotation), and management characteristics.

5. **Signing workflows** include APK signing workflow (prepare unsigned APK, generate or use keys, sign APK, verify signature, distribute signed APK), OTA package signing workflow (create OTA package, sign OTA package, verify signature, distribute OTA), AVB signing workflow (prepare images, sign boot image, sign system partitions, create vbmeta, verify signatures), and workflow characteristics.

6. **Build system integration** includes automatic signing (automatic package signing, automatic AVB signing, key configuration, signing automation, build output signing), and integration characteristics.

7. **Best practices** include best practices (use strong keys, protect private keys, test signatures, verify before distribution, document signing process), common issues (invalid signatures, key mismatches, verification failures, missing keys, format errors), and practice guidelines.

8. **Understanding signapk and AVB tools** is essential for AOSP development, enabling package signing, AVB signature management, key management, secure distribution, and proper signing implementation.

## Related Topics

- **Signing ROM builds:** ROM signing details
- **Android Verified Boot 2.0 (AVB):** AVB details
- **Verified Boot (vboot):** Verified boot details

