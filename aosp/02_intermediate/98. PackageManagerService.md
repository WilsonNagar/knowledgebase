---
number: 98
title: PackageManagerService
slug: packagemanagerservice
level: intermediate
tags:
  - aosp
  - framework
  - pms
  - package-manager
  - app-installation
  - system-services
prerequisites:
  - system-server-overview
  - activitymanagerservice-ams-internals
  - android-architecture-complete-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-intermediate-98
---

# PackageManagerService

## Overview

PackageManagerService (PMS) is a critical system service responsible for managing Android application packages, including installation, uninstallation, package scanning, permission management, and component resolution. Understanding PMS is essential for AOSP development, as it explains how apps are installed, how packages are scanned and parsed, how permissions are managed, how components are resolved, and how PMS coordinates with other system services. This guide provides a comprehensive overview of PMS, architecture, package installation, APK parsing, permission management, component resolution, and debugging.

Think of PMS like a library catalog system: just as a library catalog tracks all books (packages), manages book information (package metadata), handles book checkouts (permissions), and helps find books (component resolution), PMS tracks all installed apps, manages package information, handles permissions, and helps resolve which components can handle intents.

## Deep Explanation

### What is PackageManagerService?

PackageManagerService is a core system service running in the SystemServer process that manages all aspects of Android application packages, including installation, scanning, parsing, permission management, and component resolution.

**Key Characteristics:**
- **Core Service:** Runs in SystemServer
- **Package Management:** Manages all installed packages
- **APK Parsing:** Parses AndroidManifest.xml
- **Permission Management:** Grants and revokes permissions
- **Component Resolution:** Resolves intents to components

**Why PMS?**
- **Centralized Management:** Single point for package management
- **Security:** Enforces package security
- **Component Discovery:** Enables component resolution
- **Permission Enforcement:** Manages app permissions

### PMS Architecture

#### Service Location

**PMS Location:**
- Runs in `system_server` process
- Part of SystemServer
- Started early in boot sequence
- Registered with ServiceManager

**Service Registration:**
```java
// In SystemServer
PackageManagerService pms = new PackageManagerService(...);
ServiceManager.addService(Context.PACKAGE_SERVICE, pms);
```

**Access from Apps:**
```java
// Apps access via PackageManager
PackageManager pm = getPackageManager();
```

#### Internal Components

**PMS Components:**
- **PackageParser:** Parses APK files
- **PackageInstaller:** Handles installations
- **PermissionManager:** Manages permissions
- **ComponentResolver:** Resolves components
- **PackageData:** Stores package information

### Package Installation

#### Installation Flow

**Package Installation Process:**
```
1. Installation request received
2. PMS verifies APK signature
3. PMS parses AndroidManifest.xml
4. PMS checks package compatibility
5. PMS creates package directory
6. PMS copies APK to /data/app/
7. PMS extracts native libraries
8. PMS creates data directory
9. PMS grants permissions
10. PMS registers components
11. PMS optimizes code (dex2oat)
12. Installation complete
```

**Installation Steps:**
- **Verification:** APK signature verification
- **Parsing:** AndroidManifest.xml parsing
- **Storage:** APK and data directory creation
- **Registration:** Component registration
- **Optimization:** Code optimization

#### APK Verification

**Signature Verification:**
```
1. Extract signature from APK
2. Verify certificate chain
3. Check certificate validity
4. Verify package name matches certificate
5. Check for tampering
```

**Security Checks:**
- Signature validation
- Certificate chain validation
- Package name verification
- Tamper detection
- Security policy enforcement

#### APK Storage

**APK Locations:**
- `/data/app/` - User-installed apps
- `/system/app/` - System apps
- `/system/priv-app/` - Privileged system apps
- `/vendor/app/` - Vendor apps

**Storage Structure:**
```
/data/app/
  com.example.app-1/
    base.apk
    lib/
      arm64/
        libnative.so
```

### APK Parsing

#### AndroidManifest.xml Parsing

**Manifest Parsing:**
```
1. Extract AndroidManifest.xml from APK
2. Parse XML structure
3. Extract package information
4. Extract components
5. Extract permissions
6. Extract metadata
```

**Extracted Information:**
- Package name
- Version code and name
- Application label and icon
- Components (activities, services, receivers, providers)
- Permissions (declared and used)
- Intent filters
- Metadata

#### Component Extraction

**Component Types:**
- **Activities:** UI components
- **Services:** Background services
- **Broadcast Receivers:** Event handlers
- **Content Providers:** Data sharing

**Component Information:**
- Component name
- Intent filters
- Permissions
- Configuration
- Metadata

#### Package Information

**Package Data Structure:**
- **Package Name:** Unique identifier
- **Version:** Version code and name
- **Application Info:** App-level information
- **Component List:** All components
- **Permission List:** Declared permissions
- **Metadata:** Additional information

### Permission Management

#### Permission Types

**Permission Categories:**
- **Normal:** Granted automatically
- **Dangerous:** Requires user approval
- **Signature:** Same signature as declaring app
- **System:** System apps only
- **Development:** Development tools only

**Permission Levels:**
- **Protection Level:** Normal, dangerous, signature, etc.
- **Group:** Permission groups
- **Flags:** Additional flags

#### Permission Granting

**Permission Grant Flow:**
```
1. App requests permission
2. PMS checks if already granted
3. If normal permission, grant automatically
4. If dangerous permission:
   - Check if user already approved
   - If not, show user dialog
   - User approves/denies
5. PMS stores permission grant
6. App can use permission
```

**Grant Storage:**
- Stored in `/data/system/packages.xml`
- Per-user permission grants
- Runtime permission grants
- Persistent across reboots

#### Permission Enforcement

**Permission Check Flow:**
```
1. App tries to access protected resource
2. System service checks permission
3. Service queries PMS for grant status
4. PMS checks permission grant
5. Access allowed or denied
```

**Enforcement Points:**
- System service calls
- Framework API calls
- Component access
- Resource access

### Component Resolution

#### Intent Resolution

**Intent Resolution Process:**
```
1. App calls startActivity(intent)
2. AMS receives intent
3. AMS queries PMS for matching components
4. PMS searches installed packages
5. PMS matches intent filters
6. PMS returns matching components
7. AMS starts selected component
```

**Resolution Steps:**
- Intent analysis
- Package scanning
- Intent filter matching
- Component selection
- Result return

#### Intent Filter Matching

**Matching Criteria:**
- **Action:** Intent action matches
- **Category:** Intent categories match
- **Data:** Intent data URI matches
- **Type:** Intent MIME type matches

**Matching Process:**
```
1. Extract intent components
2. Search all packages
3. For each package:
   - Check component intent filters
   - Match action, category, data, type
   - Calculate match score
4. Return best matches
```

#### Component Discovery

**Component Types:**
- **Activities:** Resolved via intent
- **Services:** Resolved via intent
- **Broadcast Receivers:** Resolved via intent
- **Content Providers:** Resolved via URI

**Discovery Process:**
- Scan all packages
- Match intent filters
- Return matching components
- Handle multiple matches

### Package Scanning

#### Boot-Time Scanning

**Boot Scan Process:**
```
1. System boots
2. PMS starts scanning
3. PMS scans /system/app/
4. PMS scans /system/priv-app/
5. PMS scans /vendor/app/
6. PMS scans /data/app/
7. PMS parses each APK
8. PMS registers components
9. Scan complete
```

**Scan Locations:**
- System directories
- Vendor directories
- User data directories
- Package directories

#### Runtime Scanning

**Runtime Scan Triggers:**
- Package installation
- Package update
- Package removal
- System update
- Manual scan request

**Scan Process:**
- Detect changes
- Parse new/modified packages
- Update package database
- Notify other services

### Package Database

#### Package Storage

**Package Information Storage:**
- `/data/system/packages.xml` - Package list
- `/data/system/packages.list` - Package list (text)
- `/data/system/packages-stopped.xml` - Stopped packages
- Package-specific directories

**Database Structure:**
- Package metadata
- Component information
- Permission grants
- User data

#### Package Queries

**Query Operations:**
- Get package info
- Get component info
- Get permission info
- List installed packages
- Query components

**Query Performance:**
- Cached package information
- Fast lookup
- Efficient scanning
- Indexed data

### PMS Coordination

#### AMS Coordination

**Activity Management:**
- AMS queries PMS for components
- PMS provides component information
- AMS uses info to start components
- Coordination for activity lifecycle

**Component Resolution:**
```
AMS → Query PMS for component
PMS → Resolve intent
PMS → Return component info
AMS → Start component
```

#### Security Coordination

**Security Services:**
- SELinux coordination
- App sandboxing
- Permission enforcement
- Security policy

**Security Flow:**
- PMS enforces package security
- Coordinates with security services
- Manages app isolation
- Enforces security policies

### Package Updates

#### Update Process

**Update Flow:**
```
1. New APK received
2. PMS verifies signature
3. PMS checks version
4. PMS backs up old package
5. PMS installs new package
6. PMS migrates data
7. PMS updates components
8. Update complete
```

**Update Considerations:**
- Version compatibility
- Data migration
- Component updates
- Permission changes
- Rollback capability

### Package Removal

#### Uninstallation Process

**Uninstall Flow:**
```
1. Uninstall request received
2. PMS checks if package can be removed
3. PMS stops all components
4. PMS removes package files
5. PMS removes data directory
6. PMS updates package database
7. PMS notifies other services
8. Uninstall complete
```

**Removal Steps:**
- Component stopping
- File removal
- Data cleanup
- Database update
- Service notification

### Debugging PMS

#### Common Issues

**Development Issues:**
- Package not installing
- Permission issues
- Component not found
- Parsing errors
- Signature problems

#### Debugging Tools

**dumpsys package:**
```bash
# Dump PMS state
adb shell dumpsys package

# Dump specific package
adb shell dumpsys package com.example.app

# Dump permissions
adb shell dumpsys package permissions

# Dump components
adb shell dumpsys package components
```

**Package Manager Commands:**
```bash
# List packages
adb shell pm list packages

# Get package info
adb shell pm dump com.example.app

# Grant permission
adb shell pm grant com.example.app android.permission.CAMERA

# Revoke permission
adb shell pm revoke com.example.app android.permission.CAMERA
```

#### PMS State Inspection

**Package List:**
```bash
# List all packages
adb shell pm list packages

# Shows:
# - Package name
# - Version
# - Installation location
```

**Package Information:**
```bash
# Get package info
adb shell dumpsys package com.example.app

# Shows:
# - Package name
# - Version
# - Components
# - Permissions
# - Installation info
```

## Key Takeaways

1. **PackageManagerService (PMS)** is a core system service managing all aspects of Android application packages, including installation, scanning, parsing, permission management, and component resolution.

2. **PMS architecture** includes PackageParser (parses APKs), PackageInstaller (handles installations), PermissionManager (manages permissions), ComponentResolver (resolves components), and PackageData (stores package information).

3. **Package installation** involves APK verification (signature validation), APK parsing (AndroidManifest.xml parsing), APK storage (directory creation), component registration, and code optimization (dex2oat).

4. **APK parsing** extracts package information (name, version, metadata), components (activities, services, receivers, providers), permissions (declared and used), and intent filters from AndroidManifest.xml.

5. **Permission management** includes permission types (normal, dangerous, signature, system), permission granting (automatic or user approval), permission enforcement (system service checks), and permission storage (persistent grants).

6. **Component resolution** involves intent resolution (matching intents to components), intent filter matching (action, category, data, type), component discovery (scanning all packages), and returning matching components to AMS.

7. **Package scanning** occurs at boot time (scanning all package directories) and at runtime (on installation/update), parsing APKs and updating the package database.

8. **PMS coordination** with AMS (component resolution), security services (permission enforcement), and other services enables proper package management and system functionality.

9. **Understanding PMS** is essential for AOSP development, explaining how Android manages packages, permissions, and components, and how to debug package-related issues.

## Related Topics

- **System Server Overview:** How PMS fits into SystemServer
- **ActivityManagerService (AMS) internals:** How PMS coordinates with AMS for component resolution
- **Binder IPC Basics:** How PMS communicates with apps
- **Android Architecture - Complete Overview:** How PMS fits into overall architecture

