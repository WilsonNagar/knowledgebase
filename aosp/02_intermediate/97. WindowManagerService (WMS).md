---
number: 97
title: WindowManagerService (WMS)
slug: windowmanagerservice-wms
level: intermediate
tags:
  - aosp
  - framework
  - wms
  - window-manager
  - display-management
  - system-services
prerequisites:
  - system-server-overview
  - activitymanagerservice-ams-internals
  - android-architecture-complete-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-intermediate-97
---

# WindowManagerService (WMS)

## Overview

WindowManagerService (WMS) is a critical system service responsible for managing all windows in the Android system, including window creation, layout calculation, input event routing, window animations, and display management. Understanding WMS is essential for AOSP development, as it explains how windows are created and managed, how layouts are calculated, how input events are routed, how window animations work, and how WMS coordinates with SurfaceFlinger for rendering. This guide provides a comprehensive overview of WMS, architecture, window management, layout calculation, input routing, and debugging.

Think of WMS like a stage manager in a theater: just as a stage manager coordinates all actors (windows), manages their positions (layout), routes audience interactions (input events), handles scene transitions (animations), and coordinates with lighting (SurfaceFlinger), WMS coordinates all windows, manages their positions and sizes, routes input events, handles window animations, and coordinates with SurfaceFlinger for display.

## Deep Explanation

### What is WindowManagerService?

WindowManagerService is a core system service running in the SystemServer process that manages all windows in the Android system, including application windows, system windows, window layouts, input event routing, and window animations.

**Key Characteristics:**
- **Core Service:** Runs in SystemServer
- **Window Management:** Manages all windows
- **Layout Calculation:** Calculates window positions and sizes
- **Input Routing:** Routes input events to windows
- **Animation Coordination:** Coordinates window animations

**Why WMS?**
- **Centralized Management:** Single point for window management
- **Consistent Layout:** Ensures consistent window layout
- **Input Coordination:** Coordinates input event routing
- **Display Coordination:** Coordinates with SurfaceFlinger

### WMS Architecture

#### Service Location

**WMS Location:**
- Runs in `system_server` process
- Part of SystemServer
- Started early in boot sequence
- Registered with ServiceManager

**Service Registration:**
```java
// In SystemServer
WindowManagerService wms = new WindowManagerService(...);
ServiceManager.addService(Context.WINDOW_SERVICE, wms);
```

**Access from Apps:**
```java
// Apps access via WindowManager
WindowManager wm = getSystemService(WindowManager.class);
```

#### Internal Components

**WMS Components:**
- **WindowState:** Represents a window
- **DisplayContent:** Represents a display
- **WindowToken:** Window token for security
- **Layout Engine:** Calculates window layouts
- **Input Manager:** Routes input events
- **Animation Controller:** Manages animations

### Window Management

#### Window Types

**Application Windows:**
- Activity windows
- Dialog windows
- Popup windows
- Custom windows

**System Windows:**
- Status bar
- Navigation bar
- System dialogs
- Toast windows
- Overlay windows

**Window Layers:**
- Windows organized in layers (z-order)
- Higher layer = on top
- System windows on top
- Application windows below

#### Window Creation

**Window Creation Flow:**
```
1. App requests window creation
2. Framework makes Binder call to WMS
3. WMS validates request
4. WMS creates WindowState
5. WMS assigns window token
6. WMS calculates initial layout
7. WMS requests Surface from SurfaceFlinger
8. WMS adds window to display
9. Window becomes visible
```

**WindowState:**
- **Window Info:** Window properties
- **Surface:** Surface for rendering
- **Layout:** Window layout parameters
- **Token:** Security token
- **Display:** Display reference

#### Window Destruction

**Window Destruction Flow:**
```
1. App requests window removal
2. WMS receives removal request
3. WMS removes window from display
4. WMS releases Surface
5. WMS removes WindowState
6. WMS updates layout
7. Window is destroyed
```

### Layout Calculation

#### Layout Process

**Layout Calculation Flow:**
```
1. WMS receives layout request
2. WMS collects all windows
3. WMS calculates window positions
4. WMS calculates window sizes
5. WMS handles overlaps
6. WMS applies constraints
7. WMS updates window layouts
8. WMS notifies SurfaceFlinger
```

**Layout Factors:**
- Window type
- Window size
- Display size
- Other windows
- System UI
- Constraints

#### Window Positioning

**Position Calculation:**
- Based on window type
- Respects display bounds
- Handles multiple displays
- Accounts for system UI
- Applies constraints

**Z-Order:**
- Windows organized by layer
- Higher layer = on top
- Calculated during layout
- Updated dynamically

#### Layout Constraints

**Constraints:**
- Display bounds
- System UI (status bar, nav bar)
- Window type restrictions
- Parent window constraints
- Security constraints

**Constraint Application:**
- Enforced during layout
- Prevents invalid layouts
- Ensures window visibility
- Maintains system UI

### Input Event Routing

#### Input Flow

**Input Event Flow:**
```
1. Input event generated (touch, key, etc.)
2. InputManager receives event
3. InputManager queries WMS for target window
4. WMS identifies target window
5. WMS routes event to target window
6. Window receives event
7. Window processes event
```

**WMS Role:**
- Identifies target window
- Routes event to window
- Handles focus management
- Manages input channels

#### Window Focus

**Focus Management:**
- WMS manages window focus
- Only one window has focus
- Focus determines input target
- Focus changes on window changes

**Focus Rules:**
- Topmost window gets focus
- System windows can steal focus
- Focus changes on window changes
- Focus affects input routing

#### Input Channels

**Input Channel:**
- Connection between WMS and window
- Used for input event delivery
- Created per window
- Managed by WMS

**Channel Management:**
- Created with window
- Used for input routing
- Destroyed with window
- Managed by WMS

### Window Animations

#### Animation Types

**Window Animations:**
- **Open Animation:** Window opening
- **Close Animation:** Window closing
- **Transition Animation:** Window transitions
- **System Animation:** System UI animations

**Animation Coordination:**
- WMS coordinates animations
- Manages animation timing
- Handles animation cancellation
- Coordinates with SurfaceFlinger

#### Animation Flow

**Animation Process:**
```
1. Window state changes
2. WMS detects change
3. WMS starts animation
4. WMS updates window properties
5. WMS notifies SurfaceFlinger
6. Animation plays
7. Animation completes
8. WMS updates final state
```

### Display Management

#### Display Configuration

**Display Management:**
- WMS manages multiple displays
- Each display has DisplayContent
- WMS handles display changes
- WMS coordinates multi-display

**DisplayContent:**
- Represents a display
- Contains windows for display
- Manages display configuration
- Handles display changes

#### Multi-Display Support

**Multiple Displays:**
- Primary display
- Secondary displays
- Virtual displays
- Each with own window list

**Display Coordination:**
- WMS manages all displays
- Windows assigned to displays
- Layout calculated per display
- Input routed per display

### SurfaceFlinger Coordination

#### Surface Management

**Surface Creation:**
```
1. WMS requests Surface
2. SurfaceFlinger creates Surface
3. SurfaceFlinger returns Surface
4. WMS assigns Surface to window
5. Window uses Surface for rendering
```

**Surface Lifecycle:**
- Created with window
- Updated on layout changes
- Released on window destruction
- Managed by WMS

#### Composition

**Composition Process:**
```
1. WMS calculates window layouts
2. WMS updates window Surfaces
3. WMS notifies SurfaceFlinger
4. SurfaceFlinger composites Surfaces
5. SurfaceFlinger displays result
```

**WMS Role:**
- Calculates layouts
- Updates Surfaces
- Notifies SurfaceFlinger
- Coordinates composition

### WMS Data Structures

#### WindowState

**Window Information:**
- Window properties
- Surface reference
- Layout parameters
- Token reference
- Display reference
- Animation state

#### DisplayContent

**Display Information:**
- Display ID
- Display configuration
- Window list
- Layout state
- Input state

#### WindowToken

**Token Information:**
- Token identifier
- Window list
- App token reference
- Security information

### Window Policies

#### Window Policy

**Policy Rules:**
- Window type restrictions
- Size constraints
- Position constraints
- Visibility rules
- Security rules

**Policy Enforcement:**
- Enforced during layout
- Prevents invalid windows
- Ensures security
- Maintains system stability

#### Security

**Window Security:**
- Window tokens for security
- Permission checks
- System window restrictions
- Overlay restrictions

**Security Enforcement:**
- Token validation
- Permission checks
- System window checks
- Overlay validation

### Debugging WMS

#### Common Issues

**Development Issues:**
- Window not appearing
- Layout issues
- Input not working
- Animation problems
- Display issues

#### Debugging Tools

**dumpsys window:**
```bash
# Dump WMS state
adb shell dumpsys window

# Dump windows
adb shell dumpsys window windows

# Dump displays
adb shell dumpsys window displays

# Dump policy
adb shell dumpsys window policy
```

**Logcat:**
```bash
# Filter WMS logs
adb logcat | grep WindowManager

# Filter window lifecycle
adb logcat | grep WindowManager | grep lifecycle
```

#### WMS State Inspection

**Window List:**
```bash
# List all windows
adb shell dumpsys window windows

# Shows:
# - Window name
# - Window type
# - Window state
# - Layout parameters
# - Surface information
```

**Display Information:**
```bash
# List displays
adb shell dumpsys window displays

# Shows:
# - Display ID
# - Display configuration
# - Window count
# - Layout state
```

## Key Takeaways

1. **WindowManagerService (WMS)** is a core system service managing all windows, including window creation, layout calculation, input event routing, window animations, and display management.

2. **WMS architecture** includes WindowState (represents windows), DisplayContent (represents displays), WindowToken (security tokens), Layout Engine (calculates layouts), and Input Manager (routes input events).

3. **Window management** involves window types (application windows, system windows), window creation (WindowState creation, Surface assignment), window destruction (removal, Surface release), and window layers (z-order management).

4. **Layout calculation** involves layout process (position and size calculation), window positioning (based on type and constraints), z-order management (layer organization), and constraint application (display bounds, system UI).

5. **Input event routing** includes input flow (event generation to window delivery), window focus management (focus assignment and changes), and input channels (connection between WMS and windows).

6. **Window animations** involve animation types (open, close, transition, system), animation coordination (timing and cancellation), and animation flow (state changes to completion).

7. **Display management** includes display configuration (DisplayContent management), multi-display support (primary, secondary, virtual displays), and display coordination (window assignment and layout per display).

8. **SurfaceFlinger coordination** involves surface management (Surface creation and lifecycle), composition process (layout calculation to display), and WMS role (layout calculation and SurfaceFlinger notification).

9. **Understanding WMS** is essential for AOSP development, explaining how Android manages windows, layouts, input, and display, and how to debug window and display-related issues.

## Related Topics

- **System Server Overview:** How WMS fits into SystemServer
- **ActivityManagerService (AMS) internals:** How WMS coordinates with AMS
- **SurfaceFlinger (composition engine):** How WMS coordinates with SurfaceFlinger
- **InputDispatcher + InputReader:** How WMS coordinates with input system

