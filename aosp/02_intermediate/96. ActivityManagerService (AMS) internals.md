---
number: 96
title: ActivityManagerService (AMS) internals
slug: activitymanagerservice-ams-internals
level: intermediate
tags:
  - aosp
  - framework
  - ams
  - activity-manager
  - process-management
  - system-services
prerequisites:
  - system-server-overview
  - binder-ipc-basics
  - android-architecture-complete-overview
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-intermediate-96
---

# ActivityManagerService (AMS) internals

## Overview

ActivityManagerService (AMS) is one of the most critical system services in Android, responsible for managing application lifecycle, process management, task management, ANR detection, and memory coordination. Understanding AMS internals is essential for AOSP development, as it explains how activities are started, how processes are managed, how tasks are organized, how ANRs are detected, and how AMS coordinates with other system components. This guide provides a comprehensive overview of AMS internals, architecture, activity lifecycle management, process management, task management, and debugging.

Think of AMS like an air traffic controller: just as an air traffic controller manages all aircraft (activities), coordinates takeoffs and landings (activity lifecycle), monitors aircraft status (process states), and handles emergencies (ANRs), AMS manages all Android activities, coordinates their lifecycle, monitors process states, and handles application responsiveness issues.

## Deep Explanation

### What is ActivityManagerService?

ActivityManagerService is a core system service running in the SystemServer process that manages the lifecycle of Android applications, including activities, processes, tasks, and application responsiveness.

**Key Characteristics:**
- **Core Service:** Runs in SystemServer
- **Lifecycle Management:** Manages activity lifecycle
- **Process Management:** Creates and kills processes
- **Task Management:** Manages task stacks
- **ANR Detection:** Monitors application responsiveness

**Why AMS?**
- **Centralized Management:** Single point for activity management
- **Security:** Enforces permissions and security
- **Resource Management:** Manages system resources
- **Coordination:** Coordinates with other services

### AMS Architecture

#### Service Location

**AMS Location:**
- Runs in `system_server` process
- Part of SystemServer
- Started early in boot sequence
- Registered with ServiceManager

**Service Registration:**
```java
// In SystemServer
ActivityManagerService ams = new ActivityManagerService();
ServiceManager.addService(Context.ACTIVITY_SERVICE, ams);
```

**Access from Apps:**
```java
// Apps access via ActivityManager
IActivityManager am = ActivityManager.getService();
```

#### Internal Components

**AMS Components:**
- **ActivityStackSupervisor:** Manages activity stacks
- **ProcessRecord:** Tracks process information
- **ActivityRecord:** Tracks activity information
- **TaskRecord:** Tracks task information
- **ANR Handler:** Detects and handles ANRs

### Activity Lifecycle Management

#### Starting an Activity

**Activity Start Flow:**
```
1. App calls startActivity()
2. Framework makes Binder call to AMS
3. AMS validates Intent and permissions
4. AMS checks if target process exists
5. If not, AMS asks Zygote to fork process
6. AMS creates ActivityRecord
7. AMS adds activity to task stack
8. AMS calls activity lifecycle methods
9. AMS coordinates with WindowManager
10. Activity appears on screen
```

**Code Flow:**
```java
// App code
startActivity(intent);

// Framework (ActivityManager)
IActivityManager am = ActivityManager.getService();
am.startActivity(...);

// AMS receives call
public int startActivity(...) {
    // Validate intent
    // Check permissions
    // Create or get process
    // Create ActivityRecord
    // Add to stack
    // Start activity
}
```

#### Activity States

**Activity State Machine:**
- **STOPPED:** Not visible, in background
- **PAUSED:** Partially visible, not interactive
- **STOPPING:** Transitioning to stopped
- **RESUMED:** Visible and interactive
- **STARTED:** Visible but not interactive
- **CREATED:** Created but not started
- **INITIALIZING:** Being created

**State Transitions:**
```
INITIALIZING → CREATED → STARTED → RESUMED
                                    ↓
                              PAUSED → STOPPED
```

#### ActivityRecord

**ActivityRecord Structure:**
- **Activity Info:** Component name, intent
- **Process:** ProcessRecord reference
- **Task:** TaskRecord reference
- **State:** Current activity state
- **Window:** Window token

**Purpose:**
- Tracks activity information
- Manages activity lifecycle
- Coordinates with WindowManager
- Handles activity state

### Process Management

#### Process Creation

**Process Creation Flow:**
```
1. AMS needs to start activity
2. AMS checks if process exists
3. If not, AMS requests process from Zygote
4. Zygote forks new process
5. Process loads application code
6. AMS creates ProcessRecord
7. Process registers with AMS
8. AMS assigns process priority
```

**ProcessRecord:**
- **PID:** Process ID
- **UID:** User ID
- **Package Name:** Application package
- **Priority:** Process priority
- **Activities:** List of activities
- **Services:** List of services

#### Process Priorities

**Priority Levels:**
- **Foreground Process:** App with visible activity (highest)
- **Visible Process:** App with paused but visible activity
- **Service Process:** App with running service
- **Background Process:** App in background
- **Empty Process:** App with no active components (lowest)

**Priority Assignment:**
- Based on highest component priority
- Activity > Service > Background
- AMS updates priority dynamically
- Used for memory management

#### Process Killing

**Process Killing Flow:**
```
1. System memory gets low
2. AMS identifies processes to kill
3. AMS uses oom_adj scores
4. AMS kills processes starting with lowest priority
5. AMS preserves foreground and system processes
```

**Kill Order:**
1. Empty processes
2. Background processes
3. Service processes (if needed)
4. Visible processes (rarely)
5. Foreground processes (never)

### Task Management

#### Task Stacks

**Task Stack Structure:**
- **TaskRecord:** Represents a task
- **Activity Stack:** Stack of activities
- **Stack ID:** Unique identifier
- **Stack State:** Current state

**Task Types:**
- **Standard:** Normal task
- **Single Top:** Single instance
- **Single Task:** Single task instance
- **Single Instance:** Single activity instance

#### Task Management

**Task Operations:**
- **Create Task:** When activity starts
- **Add Activity:** Add to task stack
- **Remove Activity:** Remove from stack
- **Move Task:** Move to front/back
- **Remove Task:** Remove entire task

**Task Stack Example:**
```
Task 1: [Activity A] [Activity B] [Activity C]
Task 2: [Activity D] [Activity E]
```

### ANR Detection

#### What is ANR?

ANR (Application Not Responding) occurs when the main thread is blocked too long, causing the app to become unresponsive.

**ANR Types:**
- **Input ANR:** App doesn't respond to input within 5 seconds
- **Service ANR:** Service doesn't finish `onStart()` within 20 seconds
- **Broadcast ANR:** Broadcast receiver doesn't finish within 10 seconds

#### ANR Detection Flow

**Input ANR Detection:**
```
1. AMS sends input event to app
2. AMS starts 5-second timer
3. If app doesn't respond in 5 seconds:
   - AMS detects ANR
   - AMS collects stack traces
   - AMS shows "App isn't responding" dialog
   - AMS logs ANR information
```

**ANR Handler:**
- Monitors input events
- Tracks response times
- Detects timeouts
- Collects diagnostics
- Shows user dialog

#### ANR Diagnostics

**ANR Information:**
- **Stack Traces:** All thread stack traces
- **Process State:** Current process state
- **CPU Usage:** CPU usage information
- **Memory State:** Memory information
- **Logs:** Relevant log entries

**ANR Log Location:**
- `/data/anr/` directory
- `traces.txt` file
- Contains stack traces
- Useful for debugging

### Memory Management

#### Memory Coordination

**AMS Memory Role:**
- Monitors system memory
- Coordinates with Low Memory Killer
- Identifies processes to kill
- Manages process priorities
- Tracks memory usage

**Memory Management Flow:**
```
1. System memory gets low
2. Low Memory Killer notifies AMS
3. AMS identifies processes to kill
4. AMS uses process priorities
5. AMS kills processes
6. Memory is freed
```

#### OOM Adj Scores

**OOM Adj Scores:**
- Lower score = higher priority
- Used by Low Memory Killer
- AMS assigns scores
- Based on process priority

**Score Ranges:**
- **Foreground:** 0-1
- **Visible:** 1-2
- **Service:** 2-5
- **Background:** 5-9
- **Empty:** 9-15

### AMS Coordination

#### WindowManager Coordination

**Window Management:**
- AMS creates ActivityRecord
- AMS requests window from WindowManager
- WindowManager creates window
- AMS coordinates activity visibility
- WindowManager manages window display

**Coordination Flow:**
```
AMS → Create ActivityRecord
AMS → Request Window from WMS
WMS → Create Window
AMS → Start Activity Lifecycle
WMS → Display Window
```

#### PackageManager Coordination

**Package Management:**
- AMS queries PackageManager for components
- PackageManager resolves intents
- PackageManager provides component info
- AMS uses info to start components

**Component Resolution:**
```
AMS → Query PMS for component
PMS → Resolve Intent
PMS → Return component info
AMS → Start component
```

### AMS Data Structures

#### ActivityStackSupervisor

**Purpose:**
- Manages all activity stacks
- Coordinates stack operations
- Handles stack transitions
- Manages display assignments

**Key Operations:**
- Create stack
- Remove stack
- Move activity between stacks
- Handle stack focus

#### ProcessRecord

**Process Information:**
- Process ID (PID)
- User ID (UID)
- Package name
- Process priority
- Activity list
- Service list
- Memory information

#### ActivityRecord

**Activity Information:**
- Component name
- Intent
- Process reference
- Task reference
- Activity state
- Window token
- Configuration

#### TaskRecord

**Task Information:**
- Task ID
- Activity stack
- Stack state
- Intent
- Root activity
- Affinity

### Debugging AMS

#### Common Issues

**Development Issues:**
- Activity not starting
- Process not created
- ANR issues
- Memory problems
- Task stack issues

#### Debugging Tools

**dumpsys activity:**
```bash
# Dump AMS state
adb shell dumpsys activity

# Dump specific activity
adb shell dumpsys activity activities

# Dump processes
adb shell dumpsys activity processes

# Dump tasks
adb shell dumpsys activity tasks
```

**Logcat:**
```bash
# Filter AMS logs
adb logcat | grep ActivityManager

# Filter activity lifecycle
adb logcat | grep ActivityManager | grep lifecycle
```

#### AMS State Inspection

**Process List:**
```bash
# List all processes
adb shell dumpsys activity processes

# Shows:
# - Process name
# - PID
# - UID
# - Priority
# - Activities
# - Services
```

**Task Stack:**
```bash
# List task stacks
adb shell dumpsys activity tasks

# Shows:
# - Task ID
# - Activities in stack
# - Stack state
# - Intent
```

## Key Takeaways

1. **ActivityManagerService (AMS)** is a core system service managing application lifecycle, processes, tasks, ANR detection, and memory coordination in Android.

2. **AMS architecture** includes ActivityStackSupervisor (manages stacks), ProcessRecord (tracks processes), ActivityRecord (tracks activities), and TaskRecord (tracks tasks).

3. **Activity lifecycle management** involves starting activities (validation, process creation, ActivityRecord creation, lifecycle calls), managing activity states (STOPPED, PAUSED, RESUMED, etc.), and coordinating with WindowManager.

4. **Process management** includes process creation (Zygote forking, ProcessRecord creation), priority assignment (Foreground, Visible, Service, Background, Empty), and process killing (based on oom_adj scores and memory pressure).

5. **Task management** involves task stacks (TaskRecord, activity stacks), task operations (create, add, remove, move), and task types (Standard, Single Top, Single Task, Single Instance).

6. **ANR detection** monitors input events (5-second timeout), service operations (20-second timeout), broadcast receivers (10-second timeout), and collects diagnostics (stack traces, process state, logs).

7. **Memory management** coordinates with Low Memory Killer, assigns oom_adj scores based on process priority, identifies processes to kill, and manages process priorities dynamically.

8. **Understanding AMS internals** is essential for AOSP development, explaining how Android manages applications, processes, and tasks, and how to debug activity and process-related issues.

## Related Topics

- **System Server Overview:** How AMS fits into SystemServer
- **WindowManagerService (WMS):** How AMS coordinates with WMS
- **Binder IPC Basics:** How AMS communicates with apps
- **Low Memory Killer (LMK) / ActivityManager interactions:** How AMS coordinates memory management

