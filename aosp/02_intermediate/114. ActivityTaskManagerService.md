---
number: 114
title: ActivityTaskManagerService
slug: activitytaskmanagerservice
level: intermediate
tags:
  - aosp
  - framework
  - atms
  - activity-task-manager
  - task-management
  - system-services
prerequisites:
  - activitymanagerservice-ams-internals
  - system-server-overview
  - binder-ipc-basics
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-intermediate-114
---

# ActivityTaskManagerService

## Overview

ActivityTaskManagerService (ATMS) is a core system service responsible for managing activity and task lifecycle, activity stacks, task organization, and activity transitions. ATMS was introduced in Android 10 (API 29) as a split from ActivityManagerService to better separate concerns and improve maintainability. Understanding ATMS is essential for AOSP development, as it explains how activities are managed, how tasks are organized, how activity stacks work, how activity transitions are handled, and how ATMS coordinates with other system components. This guide provides a comprehensive overview of ATMS, architecture, activity management, task management, stack management, and debugging.

Think of ATMS like a building manager: just as a building manager manages all floors (activity stacks), coordinates room assignments (activity placement), handles tenant moves (activity transitions), and organizes building sections (tasks), ATMS manages all activity stacks, coordinates activity placement, handles activity transitions, and organizes tasks.

## Deep Explanation

### What is ActivityTaskManagerService?

ActivityTaskManagerService (ATMS) is a core system service running in the SystemServer process that manages activity and task lifecycle, activity stacks, task organization, and activity transitions. ATMS was split from ActivityManagerService in Android 10 to separate activity/task management from process management.

**Key Characteristics:**
- **Core Service:** Runs in SystemServer
- **Activity Management:** Manages activity lifecycle
- **Task Management:** Manages task organization
- **Stack Management:** Manages activity stacks
- **Transition Management:** Handles activity transitions

**Why ATMS?**
- **Separation of Concerns:** Separates activity/task management from process management
- **Maintainability:** Easier to maintain and extend
- **Modularity:** Better modular architecture
- **Performance:** Optimized for activity/task operations

### ATMS Architecture

#### Service Location

**ATMS Location:**
- Runs in `system_server` process
- Part of SystemServer
- Started early in boot sequence
- Registered with ServiceManager

**Service Registration:**
```java
// In SystemServer
ActivityTaskManagerService atms = new ActivityTaskManagerService(...);
ServiceManager.addService(Context.ACTIVITY_TASK_SERVICE, atms);
```

**Access from Apps:**
```java
// Apps access via ActivityTaskManager
IActivityTaskManager atm = ActivityTaskManager.getService();
```

#### Relationship with AMS

**AMS vs ATMS:**
- **AMS:** Manages processes, memory, ANR detection
- **ATMS:** Manages activities, tasks, stacks, transitions
- **Coordination:** ATMS and AMS coordinate closely
- **Separation:** Clear separation of responsibilities

**Coordination:**
```java
// ATMS coordinates with AMS
// ATMS: "I need to start an activity"
// AMS: "I'll create/manage the process"
// ATMS: "I'll manage the activity lifecycle"
```

#### Internal Components

**ATMS Components:**
- **ActivityStackSupervisor:** Manages activity stacks
- **TaskRecord:** Tracks task information
- **ActivityRecord:** Tracks activity information
- **RootWindowContainer:** Root window container
- **RecentTasks:** Manages recent tasks

### Activity Management

#### Activity Lifecycle

**Activity Lifecycle Management:**
ATMS manages the activity lifecycle, coordinating with AMS for process management:

**Lifecycle States:**
- **INITIALIZING:** Activity being created
- **RESUMED:** Activity visible and interactive
- **PAUSED:** Activity partially visible
- **STOPPED:** Activity not visible
- **DESTROYED:** Activity destroyed

**Lifecycle Flow:**
```
1. App calls startActivity()
2. ATMS receives request
3. ATMS validates intent
4. ATMS coordinates with AMS for process
5. ATMS creates ActivityRecord
6. ATMS adds to task stack
7. ATMS calls activity lifecycle methods
8. Activity transitions through states
```

#### Starting an Activity

**Activity Start Flow:**
```java
// App code
startActivity(intent);

// Framework (ActivityTaskManager)
IActivityTaskManager atm = ActivityTaskManager.getService();
atm.startActivity(...);

// ATMS receives call
public int startActivity(...) {
    // Validate intent
    // Coordinate with AMS for process
    // Create ActivityRecord
    // Add to task stack
    // Start activity
}
```

**Start Process:**
1. Validate Intent and permissions
2. Resolve target component
3. Coordinate with AMS for process
4. Create ActivityRecord
5. Determine target task
6. Add to task stack
7. Start activity lifecycle
8. Coordinate with WindowManager

#### Activity States

**Activity State Machine:**
```
INITIALIZING → RESUMED → PAUSED → STOPPED → DESTROYED
     ↑            ↓         ↓         ↓
     └────────────┴─────────┴─────────┘
```

**State Transitions:**
- **INITIALIZING → RESUMED:** Activity created and started
- **RESUMED → PAUSED:** Activity loses focus
- **PAUSED → RESUMED:** Activity regains focus
- **PAUSED → STOPPED:** Activity hidden
- **STOPPED → DESTROYED:** Activity finished

### Task Management

#### Task Concept

**What is a Task?**
- Collection of activities working together
- Represents user's work flow
- Activities in same task share back stack
- Tasks can span multiple apps

**Task Characteristics:**
- **Task ID:** Unique identifier
- **Task Affinity:** Task grouping
- **Task Root:** Root activity
- **Task Stack:** Activity stack

#### Task Organization

**Task Structure:**
```
Task 1:
├── Activity A (root)
├── Activity B
└── Activity C (top)

Task 2:
├── Activity D (root)
└── Activity E (top)
```

**Task Management:**
- Create tasks
- Add activities to tasks
- Remove activities from tasks
- Move tasks
- Remove tasks

#### Task Affinity

**Task Affinity:**
- Groups activities into tasks
- Activities with same affinity in same task
- Default: Package name
- Can be customized

**Affinity Example:**
```xml
<!-- Activity with custom affinity -->
<activity
    android:name=".MyActivity"
    android:taskAffinity="com.example.customtask" />
```

#### Task Launch Modes

**Launch Modes:**
- **Standard:** New activity instance
- **SingleTop:** Reuse if on top
- **SingleTask:** Single task instance
- **SingleInstance:** Single activity instance

**Launch Mode Behavior:**
```java
// Standard: Always creates new instance
// SingleTop: Reuses if on top of stack
// SingleTask: Single instance in task
// SingleInstance: Single instance in system
```

### Stack Management

#### Activity Stack

**Activity Stack:**
- LIFO (Last In, First Out) structure
- Activities pushed on top
- Activities popped from top
- Back button pops stack

**Stack Structure:**
```
Stack (top to bottom):
┌─────────────────┐
│ Activity C      │ ← Top (currently visible)
├─────────────────┤
│ Activity B      │
├─────────────────┤
│ Activity A      │ ← Bottom (root)
└─────────────────┘
```

#### Stack Operations

**Stack Operations:**
- **Push:** Add activity to top
- **Pop:** Remove activity from top
- **Peek:** Get top activity
- **Clear:** Remove all activities

**Stack Example:**
```java
// Push activity
stack.push(activityC);

// Pop activity
Activity popped = stack.pop();

// Peek top
Activity top = stack.peek();
```

#### Multiple Stacks

**Multiple Stacks:**
- System can have multiple stacks
- Each display can have stack
- Multi-window has multiple stacks
- Stack per task

**Stack Organization:**
```
Display 1 Stack:
├── Task 1 Stack
│   ├── Activity A
│   └── Activity B
└── Task 2 Stack
    └── Activity C

Display 2 Stack:
└── Task 3 Stack
    └── Activity D
```

### Activity Transitions

#### Transition Types

**Transition Types:**
- **Activity Start:** Starting new activity
- **Activity Finish:** Finishing activity
- **Activity Resume:** Resuming activity
- **Activity Pause:** Pausing activity

**Transition Flow:**
```
Activity A (RESUMED)
    ↓ (startActivity)
Activity B (INITIALIZING)
    ↓
Activity A (PAUSED)
    ↓
Activity B (RESUMED)
```

#### Transition Coordination

**Transition Coordination:**
- Coordinate with WindowManager
- Coordinate with AMS
- Handle animations
- Manage state

**Coordination Example:**
```java
// ATMS coordinates transition
public void startActivity(...) {
    // 1. Coordinate with AMS for process
    ams.ensureProcess(...);
    
    // 2. Create ActivityRecord
    ActivityRecord record = new ActivityRecord(...);
    
    // 3. Add to stack
    stack.addActivity(record);
    
    // 4. Coordinate with WindowManager
    wms.addWindow(...);
    
    // 5. Start activity
    record.start();
}
```

### Multi-Window Support

#### Multi-Window Modes

**Multi-Window Modes:**
- **Split Screen:** Two activities side by side
- **Picture-in-Picture:** Overlay activity
- **Freeform:** Resizable windows
- **Multi-Display:** Activities on different displays

**Multi-Window Management:**
- Manage multiple stacks
- Coordinate window positions
- Handle focus changes
- Manage transitions

#### Stack per Window

**Stack per Window:**
- Each window has its own stack
- Independent activity stacks
- Independent back stacks
- Coordinated management

**Multi-Window Stack:**
```
Window 1 Stack:
├── Activity A
└── Activity B

Window 2 Stack:
├── Activity C
└── Activity D
```

### Recent Tasks

#### Recent Tasks Management

**Recent Tasks:**
- List of recently used tasks
- Persisted across reboots
- Used for task switching
- Managed by ATMS

**Recent Tasks Features:**
- Add tasks to recent
- Remove tasks from recent
- Persist recent tasks
- Restore recent tasks

#### Task Persistence

**Task Persistence:**
- Tasks saved to disk
- Restored on boot
- Maintains task state
- Preserves activity state

**Persistence Example:**
```java
// Save recent tasks
recentTasks.save();

// Restore recent tasks
recentTasks.restore();
```

### Coordination with Other Services

#### Coordination with AMS

**AMS Coordination:**
- Process management
- Memory management
- ANR detection
- Process lifecycle

**Coordination Flow:**
```
ATMS: "I need to start an activity"
AMS: "I'll create/manage the process"
ATMS: "Process ready, starting activity"
AMS: "Monitoring process"
```

#### Coordination with WindowManager

**WindowManager Coordination:**
- Window creation
- Window positioning
- Window visibility
- Window animations

**Coordination Flow:**
```
ATMS: "Starting activity, need window"
WMS: "Creating window"
ATMS: "Activity ready, show window"
WMS: "Window displayed"
```

### ATMS Data Structures

#### ActivityRecord

**ActivityRecord:**
- Represents an activity
- Tracks activity state
- Contains activity information
- Manages activity lifecycle

**ActivityRecord Fields:**
- Activity component
- Activity state
- Activity task
- Activity window

#### TaskRecord

**TaskRecord:**
- Represents a task
- Tracks task activities
- Contains task information
- Manages task stack

**TaskRecord Fields:**
- Task ID
- Task affinity
- Task activities
- Task root

#### ActivityStack

**ActivityStack:**
- Represents activity stack
- Manages activity order
- Handles stack operations
- Coordinates transitions

**ActivityStack Operations:**
- Push activity
- Pop activity
- Get top activity
- Clear stack

### Debugging ATMS

#### ATMS Dumps

**Dump ATMS State:**
```bash
# Dump ATMS state
adb shell dumpsys activity activities

# Dump specific task
adb shell dumpsys activity activities | grep TaskRecord

# Dump activity stack
adb shell dumpsys activity activities | grep ActivityStack
```

#### Common Issues

**Common Issues:**
- Activity not starting
- Task not created
- Stack corruption
- Transition issues

**Debugging Steps:**
1. Check ATMS logs
2. Dump ATMS state
3. Verify activity records
4. Check task records
5. Review stack state

## Key Takeaways

1. **ActivityTaskManagerService (ATMS)** is a core system service managing activity and task lifecycle, activity stacks, task organization, and activity transitions, split from AMS in Android 10.

2. **ATMS architecture** includes service location (runs in system_server), relationship with AMS (ATMS manages activities/tasks, AMS manages processes), and internal components (ActivityStackSupervisor, TaskRecord, ActivityRecord).

3. **Activity management** includes activity lifecycle (INITIALIZING, RESUMED, PAUSED, STOPPED, DESTROYED), starting activities (validate, coordinate with AMS, create ActivityRecord, add to stack), and activity states (state machine with transitions).

4. **Task management** includes task concept (collection of activities), task organization (task structure, task management), task affinity (groups activities), and task launch modes (Standard, SingleTop, SingleTask, SingleInstance).

5. **Stack management** includes activity stack (LIFO structure), stack operations (push, pop, peek, clear), and multiple stacks (system can have multiple stacks, stack per display/window).

6. **Activity transitions** include transition types (start, finish, resume, pause), transition coordination (with WindowManager and AMS), and transition flow (state changes).

7. **Multi-window support** includes multi-window modes (split screen, PiP, freeform, multi-display), stack per window (each window has its own stack), and multi-window management (coordinate multiple stacks).

8. **Recent tasks** include recent tasks management (list of recently used tasks), task persistence (tasks saved to disk, restored on boot), and task restoration (maintains task state).

9. **Coordination** includes coordination with AMS (process management), coordination with WindowManager (window creation), and coordination flow (service interactions).

10. **Understanding ATMS** is essential for AOSP development, enabling activity management, task organization, stack management, and activity transitions.

## Related Topics

- **ActivityManagerService (AMS) internals:** Process management (complementary to ATMS)
- **System Server Overview:** How system services are organized
- **WindowManagerService (WMS):** Window management coordination
- **Binder IPC Basics:** How ATMS communicates

