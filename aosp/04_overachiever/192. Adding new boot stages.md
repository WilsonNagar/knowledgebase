---
number: 192
title: Adding new boot stages
slug: adding-new-boot-stages
level: overachiever
tags:
  - aosp
  - boot
  - init
  - boot-stages
  - system-startup
  - initialization
prerequisites:
  - boot-process-overview
  - init-phases-early-init-init-late-init
  - init-system-in-android
  - system-server-startup
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-overachiever-192
---

# Adding new boot stages

## Overview

Adding new boot stages refers to the process of extending the Android boot sequence with custom initialization phases, actions, and services to support custom functionality, hardware initialization, and system customization. Understanding how to add new boot stages is essential for AOSP development, as it enables custom initialization, hardware-specific setup, system extension, and boot sequence customization. This guide provides a comprehensive overview of adding new boot stages, boot stage design, init.rc integration, stage implementation, framework integration, and best practices.

Think of adding new boot stages like adding new phases to a construction project: just as you might add a "inspection phase" or "testing phase" to a construction project, adding new boot stages allows you to insert custom initialization phases into the Android boot sequence. This enables custom setup, hardware initialization, and system configuration at specific points in the boot process.

## Deep Explanation

### What is Adding New Boot Stages?

Adding new boot stages refers to the process of extending the Android boot sequence with custom initialization phases, actions, and services to support custom functionality, hardware initialization, and system customization.

**Key Characteristics:**
- **Boot Sequence Extension:** Extend boot sequence
- **Custom Initialization:** Custom initialization phases
- **Hardware Setup:** Hardware-specific setup
- **System Configuration:** System configuration stages
- **Framework Integration:** Integrate with framework

**Why Add New Boot Stages?**
- **Custom Functionality:** Support custom functionality
- **Hardware Initialization:** Initialize custom hardware
- **System Extension:** Extend system capabilities
- **Boot Customization:** Customize boot sequence
- **Device-Specific Setup:** Device-specific initialization

### Boot Stage Design

#### Stage Planning

**Stage Planning:**
- Identify initialization needs
- Determine stage timing
- Plan dependencies
- Design stage actions
- Define stage triggers

**Planning Process:**
```
1. Identify what needs initialization
2. Determine when it should happen
3. Identify dependencies
4. Design stage actions
5. Define trigger conditions
```

**Planning Considerations:**
- **Timing:** When should stage execute?
- **Dependencies:** What must be ready first?
- **Actions:** What should stage do?
- **Triggers:** What triggers the stage?
- **Ordering:** Where in boot sequence?

#### Stage Types

**Stage Types:**
- **Early Stage:** Very early initialization
- **Mid Stage:** Mid-boot initialization
- **Late Stage:** Late-boot initialization
- **Post Stage:** Post-boot initialization
- **Conditional Stage:** Condition-based stage

**Stage Type Selection:**
- **Early:** Critical setup, minimal dependencies
- **Mid:** After basic setup, before services
- **Late:** After services start, before UI
- **Post:** After system ready, background init
- **Conditional:** Based on conditions

### Init.rc Integration

#### Action Definition

**Action Definition:**
- Define action in init.rc
- Specify trigger
- Define commands
- Set properties
- Start services

**Definition Format:**
```init
# Custom boot stage
on custom-init
    # Set property to indicate stage start
    setprop sys.custom.init.started 1
    
    # Create directories
    mkdir /data/custom 0755 system system
    mkdir /cache/custom 0755 system system
    
    # Mount custom filesystems
    mount tmpfs tmpfs /data/custom mode=0755,uid=1000,gid=1000
    
    # Set up permissions
    chmod 0755 /data/custom
    chown system system /data/custom
    
    # Initialize custom hardware
    write /sys/class/custom/init 1
    
    # Set property to indicate stage complete
    setprop sys.custom.init.completed 1
```

**Definition Characteristics:**
- Action declaration
- Trigger specification
- Command execution
- Property setting
- Service management

#### Trigger Definition

**Trigger Definition:**
- Define when stage executes
- Use existing triggers
- Create custom triggers
- Handle dependencies
- Manage execution order

**Trigger Types:**
- **Property-based:**** Triggered by property change
- **Event-based:**** Triggered by event
- **Time-based:**** Triggered at specific time
- **Conditional:**** Triggered by condition
- **Manual:**** Triggered manually

**Trigger Example:**
```init
# Trigger after late-init
on property:sys.boot_completed=1
    # Custom post-boot stage
    start custom-post-init

# Trigger after specific service
on property:sys.custom.service.ready=1
    # Custom service-dependent stage
    start custom-service-init

# Custom trigger
on custom-trigger
    # Custom stage
    start custom-init
```

**Trigger Characteristics:**
- Trigger specification
- Dependency handling
- Execution ordering
- Condition evaluation
- Event handling

### Stage Implementation

#### Action Implementation

**Action Implementation:**
- Implement stage actions
- Handle errors
- Log progress
- Set properties
- Initialize components

**Implementation Example:**
```init
# Custom initialization stage
on custom-hardware-init
    # Log stage start
    write /dev/kmsg "Starting custom hardware initialization"
    
    # Initialize hardware
    write /sys/class/custom/device/init 1
    
    # Wait for hardware ready
    wait /sys/class/custom/device/ready 1
    
    # Configure hardware
    write /sys/class/custom/device/config "value"
    
    # Set property
    setprop sys.custom.hardware.ready 1
    
    # Log completion
    write /dev/kmsg "Custom hardware initialization complete"
```

**Implementation Characteristics:**
- Action execution
- Error handling
- Progress logging
- Property management
- Component initialization

#### Service Integration

**Service Integration:**
- Start services in stage
- Configure services
- Set service properties
- Manage service lifecycle
- Handle service dependencies

**Service Example:**
```init
# Service definition
service custom-service /system/bin/custom_service
    class core
    user system
    group system
    seclabel u:r:custom_service:s0
    oneshot

# Start service in stage
on custom-init
    # Start custom service
    start custom-service
    
    # Wait for service ready
    wait /sys/class/custom/service/ready 1
    
    # Set property
    setprop sys.custom.service.ready 1
```

**Service Characteristics:**
- Service definition
- Service startup
- Service configuration
- Lifecycle management
- Dependency handling

### Framework Integration

#### System Property Integration

**Property Integration:**
- Set system properties
- Read property values
- Monitor property changes
- Use properties for coordination
- Integrate with framework

**Property Example:**
```java
// Framework code reading custom property
public class CustomBootManager {
    public boolean isCustomInitComplete() {
        return SystemProperties.getBoolean(
            "sys.custom.init.completed", false);
    }
    
    public void waitForCustomInit() {
        while (!isCustomInitComplete()) {
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
}
```

**Property Characteristics:**
- Property setting
- Property reading
- Property monitoring
- Framework coordination
- System integration

#### System Service Integration

**Service Integration:**
- Integrate with SystemServer
- Start services in stage
- Coordinate with framework
- Handle service dependencies
- Manage service lifecycle

**Integration Example:**
```java
// SystemServer integration
public class SystemServer {
    private void startBootstrapServices() {
        // Wait for custom init
        waitForCustomInit();
        
        // Start custom service
        mCustomService = new CustomService(mSystemContext);
        mCustomService.start();
    }
    
    private void waitForCustomInit() {
        while (!SystemProperties.getBoolean(
                "sys.custom.init.completed", false)) {
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
}
```

**Integration Characteristics:**
- SystemServer integration
- Service coordination
- Dependency handling
- Lifecycle management
- Framework integration

### Device-Specific Integration

#### Device Init Integration

**Device Integration:**
- Add to device init.rc
- Device-specific configuration
- Hardware-specific setup
- Vendor customization
- OEM integration

**Integration Example:**
```init
# In device/<vendor>/<device>/init.<device>.rc

# Custom device initialization
on device-custom-init
    # Device-specific setup
    write /sys/class/device/custom/init 1
    
    # Configure device hardware
    write /sys/class/device/custom/config "device_value"
    
    # Set device property
    setprop ro.device.custom.ready 1
```

**Integration Characteristics:**
- Device-specific configuration
- Hardware setup
- Vendor customization
- OEM integration
- Device manifest

#### Build System Integration

**Build Integration:**
- Include in build system
- Package init.rc files
- Configure build
- Device-specific files
- System integration

**Build Configuration:**
```makefile
# In device.mk
PRODUCT_COPY_FILES += \
    device/<vendor>/<device>/init.custom.rc:$(TARGET_COPY_OUT_VENDOR)/etc/init/init.custom.rc
```

**Build Characteristics:**
- Build system integration
- File packaging
- Configuration management
- Device support
- System integration

### Best Practices

#### Best Practices

**Best Practices:**
- Plan stage timing carefully
- Handle dependencies properly
- Log stage progress
- Handle errors gracefully
- Test thoroughly

**Practice Guidelines:**
- **Timing:** Plan stage timing carefully
- **Dependencies:** Handle dependencies properly
- **Logging:** Log stage progress
- **Errors:** Handle errors gracefully
- **Testing:** Test thoroughly

#### Common Patterns

**Common Patterns:**
- Hardware initialization stages
- Service preparation stages
- Configuration stages
- Post-boot stages
- Conditional stages

**Pattern Examples:**
- Hardware init before services
- Service prep before framework
- Configuration after mount
- Post-boot background init
- Conditional based on properties

## Key Takeaways

1. **Adding new boot stages** refers to the process of extending the Android boot sequence with custom initialization phases, actions, and services to support custom functionality, hardware initialization, and system customization.

2. **Boot stage design** includes stage planning (identify initialization needs, determine stage timing, plan dependencies, design stage actions, define stage triggers), stage types (early stage, mid stage, late stage, post stage, conditional stage), and design characteristics.

3. **Init.rc integration** includes action definition (define action in init.rc, specify trigger, define commands, set properties, start services), trigger definition (define when stage executes, use existing triggers, create custom triggers, handle dependencies, manage execution order), and integration characteristics.

4. **Stage implementation** includes action implementation (implement stage actions, handle errors, log progress, set properties, initialize components), service integration (start services in stage, configure services, set service properties, manage service lifecycle, handle service dependencies), and implementation characteristics.

5. **Framework integration** includes system property integration (set system properties, read property values, monitor property changes, use properties for coordination, integrate with framework), system service integration (integrate with SystemServer, start services in stage, coordinate with framework, handle service dependencies, manage service lifecycle), and integration characteristics.

6. **Device-specific integration** includes device init integration (add to device init.rc, device-specific configuration, hardware-specific setup, vendor customization, OEM integration), build system integration (include in build system, package init.rc files, configure build, device-specific files, system integration), and integration characteristics.

7. **Best practices** include best practices (plan stage timing carefully, handle dependencies properly, log stage progress, handle errors gracefully, test thoroughly), common patterns (hardware initialization stages, service preparation stages, configuration stages, post-boot stages, conditional stages), and practice guidelines.

8. **Understanding how to add new boot stages** is essential for AOSP development, enabling custom initialization, hardware-specific setup, system extension, boot sequence customization, and proper boot stage implementation.

## Related Topics

- **Boot Process Overview:** Boot process details
- **Init Phases - early_init, init, late-init:** Init phases details
- **Init System in Android:** Init system details
- **SystemServer startup:** SystemServer details

