---
number: 185
title: Modifying ActivityManager internals
slug: modifying-activitymanager-internals
level: overachiever
tags:
  - aosp
  - framework
  - ams
  - activity-manager
  - system-modification
  - customization
prerequisites:
  - activitymanagerservice-ams-internals
  - hooking-into-system-services
  - customizing-framework-services
estimated_minutes: 95
contributors: []
diagrams: []
examples: []
canonical_id: aosp-overachiever-185
---

# Modifying ActivityManager internals

## Overview

Modifying ActivityManager internals refers to the process of customizing and extending the ActivityManagerService (AMS) implementation to add new functionality, change behavior, or adapt it for specific requirements. Understanding how to modify ActivityManager internals is essential for advanced AOSP development, as it explains how to extend AMS functionality, how to modify activity lifecycle behavior, how to customize process management, how to add new features, and how to integrate modifications with the framework. This guide provides a comprehensive overview of modifying ActivityManager internals, modification approaches, implementation techniques, integration methods, and best practices.

Think of modifying ActivityManager internals like customizing a factory's production line: just as you might modify a production line to add new steps, change the workflow, or adapt it for different products, modifying AMS allows you to add new functionality, change activity lifecycle behavior, customize process management, and adapt the system for specific requirements. This requires deep understanding of AMS architecture and careful integration with the framework.

## Deep Explanation

### What is Modifying ActivityManager Internals?

Modifying ActivityManager internals refers to the process of customizing and extending the ActivityManagerService (AMS) implementation to add new functionality, change behavior, or adapt it for specific requirements.

**Key Characteristics:**
- **Service Extension:** Extend AMS functionality
- **Behavior Modification:** Change AMS behavior
- **Feature Addition:** Add new features
- **Customization:** Customize for specific needs
- **Framework Integration:** Integrate with framework

**Why Modify ActivityManager Internals?**
- **OEM Requirements:** Meet OEM-specific needs
- **Feature Addition:** Add new functionality
- **Behavior Customization:** Customize behavior
- **Hardware Adaptation:** Adapt for specific hardware
- **Market Differentiation:** Differentiate products

### Modification Approaches

#### Service Subclassing

**Service Subclassing:**
- Extend ActivityManagerService class
- Override methods
- Add custom functionality
- Maintain compatibility

**Subclassing Example:**
```java
public class CustomActivityManagerService extends ActivityManagerService {
    public CustomActivityManagerService(Context context) {
        super(context);
        // Custom initialization
    }
    
    @Override
    public int startActivity(IApplicationThread caller, String callingPackage,
                            Intent intent, String resolvedType, IBinder resultTo,
                            String resultWho, int requestCode, int startFlags,
                            ProfilerInfo profilerInfo, Bundle bOptions) {
        // Custom pre-processing
        customPreStartActivity(caller, intent);
        
        // Call parent
        int result = super.startActivity(caller, callingPackage, intent,
                                        resolvedType, resultTo, resultWho,
                                        requestCode, startFlags, profilerInfo, bOptions);
        
        // Custom post-processing
        customPostStartActivity(result, intent);
        
        return result;
    }
    
    private void customPreStartActivity(IApplicationThread caller, Intent intent) {
        // OEM-specific logic
        // Log activity start
        // Validate intent
        // Add custom checks
    }
    
    private void customPostStartActivity(int result, Intent intent) {
        // Post-processing
        // Track activity start
        // Notify listeners
    }
}
```

**Subclassing Characteristics:**
- Extend base class
- Override methods
- Add custom logic
- Maintain compatibility
- Framework integration

#### Method Overriding

**Method Overriding:**
- Override specific methods
- Modify behavior
- Add custom logic
- Preserve original functionality

**Overriding Example:**
```java
@Override
public void finishActivity(IBinder token, int resultCode, Intent resultData,
                           boolean finishTask) {
    // Custom logic before
    customPreFinishActivity(token, resultCode);
    
    // Call parent
    super.finishActivity(token, resultCode, resultData, finishTask);
    
    // Custom logic after
    customPostFinishActivity(token);
}

private void customPreFinishActivity(IBinder token, int resultCode) {
    // Custom validation
    // Log activity finish
    // Track activity lifecycle
}

private void customPostFinishActivity(IBinder token) {
    // Post-processing
    // Cleanup
    // Notify listeners
}
```

**Overriding Characteristics:**
- Method-level modification
- Behavior change
- Custom logic
- Original functionality preserved
- Selective modification

#### Component Extension

**Component Extension:**
- Extend AMS components
- Customize ActivityStackSupervisor
- Modify ProcessRecord
- Extend ActivityRecord

**Component Extension Example:**
```java
public class CustomActivityStackSupervisor extends ActivityStackSupervisor {
    public CustomActivityStackSupervisor(ActivityManagerService service) {
        super(service);
        // Custom initialization
    }
    
    @Override
    void startActivityLocked(ActivityRecord r, ActivityRecord focusedTop,
                            boolean newTask, boolean keepCurTransition,
                            ActivityOptions options) {
        // Custom logic
        customPreStartActivityLocked(r);
        
        // Call parent
        super.startActivityLocked(r, focusedTop, newTask,
                                 keepCurTransition, options);
        
        // Custom logic
        customPostStartActivityLocked(r);
    }
    
    private void customPreStartActivityLocked(ActivityRecord r) {
        // Custom validation
        // Log activity start
    }
    
    private void customPostStartActivityLocked(ActivityRecord r) {
        // Post-processing
    }
}
```

**Extension Characteristics:**
- Component-level extension
- Deep customization
- Architecture integration
- Framework compatibility
- Selective extension

### Implementation Techniques

#### Activity Lifecycle Modification

**Lifecycle Modification:**
- Modify activity start flow
- Customize activity resume
- Change activity pause behavior
- Extend activity stop logic

**Lifecycle Example:**
```java
@Override
public void activityResumed(IBinder token) {
    // Custom logic
    customPreActivityResumed(token);
    
    // Call parent
    super.activityResumed(token);
    
    // Custom logic
    customPostActivityResumed(token);
}

private void customPreActivityResumed(IBinder token) {
    ActivityRecord r = ActivityRecord.forToken(token);
    if (r != null) {
        // Custom validation
        // Track activity state
        // Log activity resume
    }
}

private void customPostActivityResumed(IBinder token) {
    // Post-processing
    // Notify listeners
    // Update statistics
}
```

**Lifecycle Characteristics:**
- Lifecycle hook points
- State tracking
- Custom validation
- Logging and monitoring
- Integration points

#### Process Management Customization

**Process Management:**
- Customize process creation
- Modify process priority
- Change process killing logic
- Extend process monitoring

**Process Management Example:**
```java
@Override
final ProcessRecord startProcessLocked(String hostingName, String hostingTypeStr,
                                        String abiOverride, String entryPoint,
                                        String[] entryPointArgs, Runnable crashHandler) {
    // Custom logic
    customPreStartProcess(hostingName, entryPoint);
    
    // Call parent
    ProcessRecord app = super.startProcessLocked(hostingName, hostingTypeStr,
                                                 abiOverride, entryPoint,
                                                 entryPointArgs, crashHandler);
    
    // Custom logic
    customPostStartProcess(app);
    
    return app;
}

private void customPreStartProcess(String hostingName, String entryPoint) {
    // Custom validation
    // Log process start
    // Track process creation
}

private void customPostStartProcess(ProcessRecord app) {
    if (app != null) {
        // Post-processing
        // Set custom properties
        // Register listeners
    }
}
```

**Process Management Characteristics:**
- Process creation hooks
- Priority management
- Monitoring integration
- Custom properties
- Lifecycle tracking

#### Task Management Extension

**Task Management:**
- Customize task creation
- Modify task stack behavior
- Extend task switching
- Add task management features

**Task Management Example:**
```java
@Override
void moveTaskToFrontLocked(int taskId, int flags, Bundle options,
                           String reason) {
    // Custom logic
    customPreMoveTaskToFront(taskId, reason);
    
    // Call parent
    super.moveTaskToFrontLocked(taskId, flags, options, reason);
    
    // Custom logic
    customPostMoveTaskToFront(taskId);
}

private void customPreMoveTaskToFront(int taskId, String reason) {
    // Custom validation
    // Log task switch
    // Track task management
}

private void customPostMoveTaskToFront(int taskId) {
    // Post-processing
    // Notify listeners
    // Update statistics
}
```

**Task Management Characteristics:**
- Task lifecycle hooks
- Stack management
- Switching logic
- Custom features
- Integration points

### Integration Methods

#### SystemServer Integration

**SystemServer Integration:**
- Replace AMS in SystemServer
- Register custom service
- Initialize custom components
- Integrate with boot sequence

**Integration Example:**
```java
// In SystemServer.java
private void startBootstrapServices(@NonNull TimingsTraceAndSlog t) {
    // Create custom AMS
    mActivityManagerService = new CustomActivityManagerService(mSystemContext);
    
    // Initialize
    mActivityManagerService.setSystemProcess();
    
    // Register with ServiceManager
    ServiceManager.addService(Context.ACTIVITY_SERVICE, mActivityManagerService);
}
```

**Integration Characteristics:**
- SystemServer modification
- Service registration
- Boot sequence integration
- Component initialization
- Framework integration

#### Build System Integration

**Build Integration:**
- Modify Android.bp files
- Update build configuration
- Include custom sources
- Configure dependencies

**Build Configuration:**
```python
# Android.bp
java_library {
    name: "framework-services",
    srcs: [
        "services/core/java/com/android/server/am/*.java",
        "services/core/java/com/android/server/am/custom/*.java",  // Custom
    ],
    libs: [
        "framework",
        "services.core",
    ],
}
```

**Build Characteristics:**
- Build system configuration
- Source inclusion
- Dependency management
- Compilation integration
- Build output

### Best Practices

#### Best Practices

**Best Practices:**
- Understand AMS architecture
- Maintain compatibility
- Test thoroughly
- Document changes
- Follow framework patterns

**Practice Guidelines:**
- **Architecture:** Understand AMS architecture
- **Compatibility:** Maintain framework compatibility
- **Testing:** Test thoroughly
- **Documentation:** Document changes
- **Patterns:** Follow framework patterns

#### Common Modifications

**Common Modifications:**
- Activity start customization
- Process priority management
- Task management features
- ANR handling customization
- Memory management extension

**Modification Examples:**
- Custom activity validation
- Process priority adjustment
- Task switching logic
- ANR detection customization
- Memory pressure handling

## Key Takeaways

1. **Modifying ActivityManager internals** refers to the process of customizing and extending the ActivityManagerService (AMS) implementation to add new functionality, change behavior, or adapt it for specific requirements.

2. **Modification approaches** include service subclassing (extend ActivityManagerService class, override methods, add custom functionality, maintain compatibility), method overriding (override specific methods, modify behavior, add custom logic, preserve original functionality), component extension (extend AMS components, customize ActivityStackSupervisor, modify ProcessRecord, extend ActivityRecord), and approach characteristics.

3. **Implementation techniques** include activity lifecycle modification (modify activity start flow, customize activity resume, change activity pause behavior, extend activity stop logic), process management customization (customize process creation, modify process priority, change process killing logic, extend process monitoring), task management extension (customize task creation, modify task stack behavior, extend task switching, add task management features), and technique characteristics.

4. **Integration methods** include SystemServer integration (replace AMS in SystemServer, register custom service, initialize custom components, integrate with boot sequence), build system integration (modify Android.bp files, update build configuration, include custom sources, configure dependencies), and integration characteristics.

5. **Best practices** include best practices (understand AMS architecture, maintain compatibility, test thoroughly, document changes, follow framework patterns), common modifications (activity start customization, process priority management, task management features, ANR handling customization, memory management extension), and practice guidelines.

6. **Understanding how to modify ActivityManager internals** is essential for advanced AOSP development, enabling OEM requirements, feature addition, behavior customization, hardware adaptation, and proper AMS modification implementation.

## Related Topics

- **ActivityManagerService (AMS) internals:** AMS details
- **Hooking into system services:** Hooking details
- **Customizing framework services:** Customization details

