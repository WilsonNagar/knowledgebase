---
number: 6
title: "Working with Databases in Go"
slug: "working-with-databases-in-go"
level: "intermediate"
tags: ["go", "database", "sql", "orm", "gorm", "sqlx"]
prerequisites: ["testing-and-benchmarking-in-go"]
estimated_minutes: 110
contributors: []
diagrams: []
examples: []
canonical_id: "golang-intermediate-06"
---

# Working with Databases in Go

## Overview

This guide covers working with SQL databases using database/sql, using ORMs like GORM, connection pooling, transactions, prepared statements, and best practices for database operations in Go.

## Deep Explanation

### database/sql Package

```go
import (
    "database/sql"
    _ "github.com/lib/pq"  // PostgreSQL driver
)

db, err := sql.Open("postgres", "connection string")
defer db.Close()

// Query
rows, err := db.Query("SELECT id, name FROM users")
defer rows.Close()

for rows.Next() {
    var id int
    var name string
    rows.Scan(&id, &name)
}

// Exec
result, err := db.Exec("INSERT INTO users (name) VALUES ($1)", "Alice")

// Prepared statements
stmt, _ := db.Prepare("SELECT * FROM users WHERE id = $1")
defer stmt.Close()
row := stmt.QueryRow(1)

// Transactions
tx, _ := db.Begin()
tx.Exec("INSERT INTO users ...")
tx.Commit()
```

### GORM

```go
import "gorm.io/gorm"

type User struct {
    ID    uint   `gorm:"primaryKey"`
    Name  string
    Email string
}

db.Create(&user)
db.First(&user, 1)
db.Where("name = ?", "Alice").Find(&users)
db.Model(&user).Update("name", "Bob")
db.Delete(&user)
```

## Real Code Examples

### Example: User Repository

```go
package main

import (
    "database/sql"
    "fmt"
)

type User struct {
    ID    int
    Name  string
    Email string
}

type UserRepository struct {
    db *sql.DB
}

func NewUserRepository(db *sql.DB) *UserRepository {
    return &UserRepository{db: db}
}

func (r *UserRepository) Create(name, email string) (*User, error) {
    var user User
    err := r.db.QueryRow(
        "INSERT INTO users (name, email) VALUES ($1, $2) RETURNING id",
        name, email,
    ).Scan(&user.ID)
    if err != nil {
        return nil, err
    }
    user.Name = name
    user.Email = email
    return &user, nil
}

func (r *UserRepository) GetByID(id int) (*User, error) {
    var user User
    err := r.db.QueryRow(
        "SELECT id, name, email FROM users WHERE id = $1",
        id,
    ).Scan(&user.ID, &user.Name, &user.Email)
    if err != nil {
        return nil, err
    }
    return &user, nil
}

func main() {
    db, _ := sql.Open("postgres", "connection string")
    repo := NewUserRepository(db)
    
    user, _ := repo.Create("Alice", "alice@example.com")
    fmt.Printf("Created user: %+v\n", user)
}
```

## Hard Use-Case: Transaction Management

### Problem Statement

Implement a service that performs multiple database operations atomically using transactions.

### Solution

```go
package main

import "database/sql"

type TransferService struct {
    db *sql.DB
}

func (s *TransferService) Transfer(fromID, toID int, amount float64) error {
    tx, err := s.db.Begin()
    if err != nil {
        return err
    }
    defer tx.Rollback()
    
    // Deduct from sender
    _, err = tx.Exec(
        "UPDATE accounts SET balance = balance - $1 WHERE id = $2",
        amount, fromID,
    )
    if err != nil {
        return err
    }
    
    // Add to receiver
    _, err = tx.Exec(
        "UPDATE accounts SET balance = balance + $1 WHERE id = $2",
        amount, toID,
    )
    if err != nil {
        return err
    }
    
    return tx.Commit()
}
```

## References and Further Reading

- [Go database/sql](https://pkg.go.dev/database/sql)
- [GORM Documentation](https://gorm.io/)

## Quiz

### Question 1
What is the purpose of sql.Open()?

**A)** Opens a connection  
**B)** Validates connection string  
**C)** Creates a connection pool  
**D)** Executes a query

**Answer: C** - sql.Open() creates a connection pool but doesn't open connections until needed.

## Related Topics

- [Testing and Benchmarking in Go](./05.%20Testing%20and%20Benchmarking%20in%20Go.md)
- [Building CLI Applications in Go](./07.%20Building%20CLI%20Applications%20in%20Go.md)

